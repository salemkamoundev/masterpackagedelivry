==============================================================================
FICHIER : src/index.html
==============================================================================
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MasterDelivery</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <app-root></app-root>
</body>
</html>



==============================================================================
FICHIER : src/app/app.component.html
==============================================================================
<router-outlet></router-outlet>



==============================================================================
FICHIER : src/app/app.spec.ts
==============================================================================
import { TestBed } from '@angular/core/testing';
import { App } from './app';

describe('App', () => {
  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [App],
    }).compileComponents();
  });

  it('should create the app', () => {
    const fixture = TestBed.createComponent(App);
    const app = fixture.componentInstance;
    expect(app).toBeTruthy();
  });

  it('should render title', () => {
    const fixture = TestBed.createComponent(App);
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h1')?.textContent).toContain('Hello, master-delivery');
  });
});



==============================================================================
FICHIER : src/app/core/auth/auth.service.ts
==============================================================================
import { Injectable, inject, signal } from '@angular/core';
import { Router } from '@angular/router';
import { from, Observable, of } from 'rxjs';
import { switchMap, map } from 'rxjs/operators';

// AngularFire
import { Auth, user } from '@angular/fire/auth';
import { Firestore } from '@angular/fire/firestore';

// SDK Natif
import { 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword, 
  signInWithPopup, 
  GoogleAuthProvider, 
  signOut, 
  User 
} from 'firebase/auth';

import { 
  doc, 
  setDoc, 
  getDoc 
} from 'firebase/firestore';

export interface UserProfile {
  uid: string;
  email: string;
  role: 'DRIVER' | 'EMPLOYEE' | 'ADMIN' | 'SUPER_ADMIN';
  company: string;
  phoneNumber: string; // NOUVEAU CHAMP OBLIGATOIRE
  isActive: boolean;
  createdAt: Date;
}

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private auth = inject(Auth);
  private firestore = inject(Firestore);
  private router = inject(Router);

  user$ = user(this.auth);
  currentUserProfile = signal<UserProfile | null>(null);

  constructor() {}

  login(email: string, pass: string) {
    return from(signInWithEmailAndPassword(this.auth, email, pass));
  }

  loginGoogle() {
    const provider = new GoogleAuthProvider();
    return from(signInWithPopup(this.auth, provider));
  }

  // Signature mise √† jour avec phoneNumber
  register(email: string, pass: string, role: 'DRIVER' | 'EMPLOYEE', company: string, phoneNumber: string) {
    return from(createUserWithEmailAndPassword(this.auth, email, pass)).pipe(
      switchMap(credential => this.createProfile(credential.user, role, company, phoneNumber))
    );
  }

  // Signature mise √† jour avec phoneNumber
  createProfile(user: User, role: 'DRIVER' | 'EMPLOYEE', company: string, phoneNumber: string) {
    const userProfile: UserProfile = {
      uid: user.uid,
      email: user.email || '',
      role: role,
      company: company,
      phoneNumber: phoneNumber,
      isActive: false, 
      createdAt: new Date()
    };
    const userDocRef = doc(this.firestore, 'users', user.uid);
    return from(setDoc(userDocRef, userProfile));
  }

  logout() {
    return from(signOut(this.auth)).pipe(
      map(() => {
        this.router.navigate(['/login']);
      })
    );
  }

  getUserProfile(uid: string): Observable<UserProfile | undefined> {
    const userDocRef = doc(this.firestore, 'users', uid);
    return from(getDoc(userDocRef)).pipe(
      map(snapshot => snapshot.data() as UserProfile)
    );
  }
}



==============================================================================
FICHIER : src/app/core/auth/register/register.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { Router, RouterModule } from '@angular/router';
import { AuthService } from '../auth.service';
import { CompanyService } from '../../services/company.service';

@Component({
  selector: 'app-register',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, RouterModule],
  template: `
    <div class="min-h-screen flex items-center justify-center bg-gray-100 px-4">
      <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg">
        <div class="text-center">
          <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Cr√©er un compte</h2>
        </div>
        
        <form [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="mt-8 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input formControlName="email" type="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Mot de passe</label>
            <input formControlName="password" type="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm p-2">
          </div>

          <!-- T√âL√âPHONE : TEXTE SIMPLE OBLIGATOIRE -->
          <div>
            <label class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
            <input formControlName="phoneNumber" type="text" placeholder="Num√©ro de t√©l√©phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm p-2">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">M√©tier</label>
            <select formControlName="role" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md border p-2">
              <option value="DRIVER">Chauffeur</option>
              <option value="EMPLOYEE">Employ√©</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Soci√©t√©</label>
            <select formControlName="company" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md border p-2">
              <option value="" disabled>Choisir une soci√©t√©</option>
              @for (company of activeCompanies(); track company.uid) {
                 <option [value]="company.name">{{ company.name }}</option>
              }
            </select>
          </div>

          <button type="submit" [disabled]="registerForm.invalid || activeCompanies().length === 0"
            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400">
            S'inscrire
          </button>
        </form>
         <div class="text-center mt-4">
          <a routerLink="/login" class="font-medium text-indigo-600 hover:text-indigo-500">
            D√©j√† un compte ? Se connecter
          </a>
        </div>
      </div>
    </div>
  `
})
export class RegisterComponent {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private router = inject(Router);
  private companyService = inject(CompanyService);

  activeCompanies = this.companyService.activeCompanies; 

  registerForm = this.fb.group({
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required, Validators.minLength(6)]],
    phoneNumber: ['', Validators.required], // Validation simple
    role: ['DRIVER', Validators.required],
    company: ['', Validators.required]
  });

  onSubmit() {
    if (this.registerForm.valid) {
      const { email, password, role, company, phoneNumber } = this.registerForm.value;
      this.authService.register(email!, password!, role as any, company!, phoneNumber!).subscribe({
        next: () => {
          alert('Compte cr√©√© ! En attente de validation.');
          this.router.navigate(['/login']);
        },
        error: (err) => alert('Erreur inscription : ' + err.message)
      });
    }
  }
}



==============================================================================
FICHIER : src/app/core/auth/complete-profile/complete-profile.component.ts
==============================================================================
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { Router } from '@angular/router';
import { AuthService } from '../auth.service';
import { CompanyService } from '../../services/company.service';
import { take } from 'rxjs/operators';

@Component({
  selector: 'app-complete-profile',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="min-h-screen flex items-center justify-center bg-gray-100 px-4">
      <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg">
        <div class="text-center">
          <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Finaliser l'inscription</h2>
          <p class="mt-2 text-sm text-gray-600">
            Veuillez compl√©ter vos informations pour acc√©der √† la plateforme.
          </p>
        </div>
        
        <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="mt-8 space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Compte Google</label>
            <div class="mt-1 px-3 py-2 border border-gray-200 bg-gray-50 rounded-md text-gray-600 text-sm">
              {{ (currentUser$ | async)?.email }}
            </div>
          </div>

          <!-- T√âL√âPHONE : TEXTE SIMPLE OBLIGATOIRE -->
          <div>
            <label class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
            <input formControlName="phoneNumber" type="text" placeholder="Num√©ro de t√©l√©phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm p-2">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Votre M√©tier</label>
            <select formControlName="role" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md border p-2">
              <option value="" disabled>Choisir un m√©tier</option>
              <option value="DRIVER">Chauffeur</option>
              <option value="EMPLOYEE">Employ√©</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Votre Soci√©t√©</label>
            <select formControlName="company" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md border p-2">
              <option value="" disabled>Choisir une soci√©t√©</option>
              @for (company of activeCompanies(); track company.uid) {
                 <option [value]="company.name">{{ company.name }}</option>
              }
            </select>
          </div>

          <button type="submit" [disabled]="profileForm.invalid"
            class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
            Valider et Acc√©der
          </button>
        </form>
      </div>
    </div>
  `
})
export class CompleteProfileComponent implements OnInit {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private companyService = inject(CompanyService);
  private router = inject(Router);

  currentUser$ = this.authService.user$;
  activeCompanies = this.companyService.activeCompanies;

  profileForm = this.fb.group({
    phoneNumber: ['', Validators.required], // Validation simple
    role: ['', Validators.required],
    company: ['', Validators.required]
  });

  ngOnInit() {
    this.currentUser$.pipe(take(1)).subscribe(user => {
      if (!user) this.router.navigate(['/login']);
    });
  }

  onSubmit() {
    if (this.profileForm.valid) {
      this.currentUser$.pipe(take(1)).subscribe(user => {
        if (user) {
          const { role, company, phoneNumber } = this.profileForm.value;
          this.authService.createProfile(user, role as any, company!, phoneNumber!).subscribe({
            next: () => {
              alert('Profil compl√©t√© !');
              if (role === 'DRIVER') this.router.navigate(['/driver']);
              else this.router.navigate(['/admin']);
            },
            error: (err) => alert('Erreur cr√©ation profil : ' + err.message)
          });
        }
      });
    }
  }
}



==============================================================================
FICHIER : src/app/core/auth/login/login.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { Router, RouterModule } from '@angular/router';
import { AuthService } from '../auth.service';
import { switchMap, map } from 'rxjs/operators';
import { of } from 'rxjs';

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, RouterModule],
  template: `
    <div class="min-h-screen flex items-center justify-center bg-gray-100 px-4">
      <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg">
        <div class="text-center">
          <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Connexion</h2>
          <p class="mt-2 text-sm text-gray-600">Acc√©dez √† Master Delivery</p>
        </div>
        
        <form [formGroup]="loginForm" (ngSubmit)="onSubmit()" class="mt-8 space-y-6">
          <div class="rounded-md shadow-sm -space-y-px">
            <div>
              <label for="email-address" class="sr-only">Email</label>
              <input id="email-address" formControlName="email" type="email" required 
                class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" 
                placeholder="Adresse Email">
            </div>
            <div>
              <label for="password" class="sr-only">Mot de passe</label>
              <input id="password" formControlName="password" type="password" required 
                class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" 
                placeholder="Mot de passe">
            </div>
          </div>

          <div>
            <button type="submit" [disabled]="loginForm.invalid"
              class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
              Se connecter
            </button>
          </div>
        </form>

        <div class="mt-4">
           <button (click)="loginWithGoogle()" type="button" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 flex items-center justify-center gap-2">
             <svg class="h-5 w-5" viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                <g transform="matrix(1, 0, 0, 1, 27.009001, -39.238998)">
                  <path fill="#4285F4" d="M -3.264 51.509 C -3.264 50.719 -3.334 49.969 -3.454 49.239 L -14.754 49.239 L -14.754 53.749 L -8.284 53.749 C -8.574 55.229 -9.424 56.479 -10.684 57.329 L -10.684 60.329 L -6.824 60.329 C -4.564 58.239 -3.264 55.159 -3.264 51.509 Z"/>
                  <path fill="#34A853" d="M -14.754 63.239 C -11.514 63.239 -8.804 62.159 -6.824 60.329 L -10.684 57.329 C -11.764 58.049 -13.134 58.489 -14.754 58.489 C -17.884 58.489 -20.534 56.379 -21.484 53.529 L -25.464 53.529 L -25.464 56.619 C -23.494 60.539 -19.444 63.239 -14.754 63.239 Z"/>
                  <path fill="#FBBC05" d="M -21.484 53.529 C -21.734 52.809 -21.864 52.039 -21.864 51.239 C -21.864 50.439 -21.724 49.669 -21.484 48.949 L -21.484 45.859 L -25.464 45.859 C -26.284 47.479 -26.754 49.299 -26.754 51.239 C -26.754 53.179 -26.284 54.999 -25.464 56.619 L -21.484 53.529 Z"/>
                  <path fill="#EA4335" d="M -14.754 43.989 C -12.984 43.989 -11.404 44.599 -10.154 45.789 L -6.734 42.369 C -8.804 40.429 -11.514 39.239 -14.754 39.239 C -19.444 39.239 -23.494 41.939 -25.464 45.859 L -21.484 48.949 C -20.534 46.099 -17.884 43.989 -14.754 43.989 Z"/>
                </g>
             </svg>
             Connexion Google
           </button>
        </div>

        <div class="text-center mt-4">
          <a routerLink="/register" class="font-medium text-indigo-600 hover:text-indigo-500">
            Pas encore de compte ? S'inscrire
          </a>
        </div>
      </div>
    </div>
  `
})
export class LoginComponent {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private router = inject(Router);

  loginForm = this.fb.group({
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required, Validators.minLength(6)]]
  });

  private checkStatusAndRedirect(profile: any) {
    // BYPASS SUPER ADMIN : Si c'est l'admin, on ignore le statut isActive
    if (profile?.email === 'admin@gmail.com') {
        this.router.navigate(['/admin']);
        return;
    }

    if (profile && profile.isActive) {
      if (profile.role === 'DRIVER') {
        this.router.navigate(['/driver']);
      } else {
        this.router.navigate(['/admin']);
      }
    } else {
      this.authService.logout().subscribe(() => {
         alert("Votre compte n'est pas encore valid√©. Veuillez attendre l'approbation d'un administrateur avant de pouvoir vous connecter.");
      });
    }
  }

  onSubmit() {
    if (this.loginForm.valid) {
      const { email, password } = this.loginForm.value;
      
      this.authService.login(email!, password!).pipe(
        switchMap(cred => {
           // BYPASS IMMEDIAT SI EMAIL ADMIN
           if (cred.user.email?.toLowerCase() === 'admin@gmail.com') {
               return of({ email: 'admin@gmail.com', role: 'SUPER_ADMIN', isActive: true }); // Faux profil pour passer
           }
           return this.authService.getUserProfile(cred.user.uid);
        })
      ).subscribe({
        next: (profile) => this.checkStatusAndRedirect(profile),
        error: (err) => alert('Erreur de connexion: ' + err.message)
      });
    }
  }

  loginWithGoogle() {
    this.authService.loginGoogle().pipe(
      switchMap(cred => {
         if (cred.user.email?.toLowerCase() === 'admin@gmail.com') {
            return of({ email: 'admin@gmail.com', role: 'SUPER_ADMIN', isActive: true });
         }
         return this.authService.getUserProfile(cred.user.uid);
      })
    ).subscribe({
      next: (profile) => {
        if (profile) {
          this.checkStatusAndRedirect(profile);
        } else {
          this.router.navigate(['/complete-profile']);
        }
      },
      error: (err) => {
         console.error('Google Auth Error:', err);
         alert('Erreur Google: ' + err.message);
      }
    });
  }
}



==============================================================================
FICHIER : src/app/core/services/car.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Firestore } from '@angular/fire/firestore';
import { collectionData } from '@angular/fire/firestore';
import { collection, addDoc, updateDoc, doc } from 'firebase/firestore';
import { Observable } from 'rxjs';

export interface Car {
  uid?: string;
  model: string;
  plate: string;
  status: 'AVAILABLE' | 'MAINTENANCE' | 'BUSY';
  assignedDriverId?: string | null;
  company: string;
}

@Injectable({
  providedIn: 'root'
})
export class CarService {
  private firestore = inject(Firestore);
  
  private get carsCollection() {
    return collection(this.firestore, 'cars');
  }

  getCars(): Observable<Car[]> {
    return collectionData(this.carsCollection, { idField: 'uid' }) as Observable<Car[]>;
  }

  addCar(car: Car) {
    return addDoc(this.carsCollection, car);
  }

  updateCar(carId: string, data: Partial<Car>) {
    const carRef = doc(this.firestore, 'cars', carId);
    return updateDoc(carRef, data);
  }

  assignDriver(carId: string, driverId: string | null) {
    const carRef = doc(this.firestore, 'cars', carId);
    return updateDoc(carRef, { 
      assignedDriverId: driverId,
      status: driverId ? 'BUSY' : 'AVAILABLE'
    });
  }
}



==============================================================================
FICHIER : src/app/core/services/chat.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Database, ref, push, set, listVal, query, orderByChild } from '@angular/fire/database';
import { Observable, map, BehaviorSubject } from 'rxjs';
import { UserProfile } from '../auth/auth.service';
import { UserService } from './user.service';

export interface ChatMessage {
  senderId: string;
  text: string;
  createdAt: number;
}

@Injectable({
  providedIn: 'root'
})
export class ChatService {
  private db = inject(Database);
  private userService = inject(UserService);
  private targetUserSource = new BehaviorSubject<UserProfile | null>(null);
  targetUser$ = this.targetUserSource.asObservable();

  startChatWith(user: UserProfile) { this.targetUserSource.next(user); }

  getConversationId(user1: string, user2: string): string {
    return user1 < user2 ? `${user1}_${user2}` : `${user2}_${user1}`;
  }

  async sendMessage(chatId: string, senderId: string, text: string) {
    const messagesRef = ref(this.db, `chats/${chatId}/messages`);
    const newMessageRef = push(messagesRef);
    await set(newMessageRef, { senderId, text, createdAt: Date.now() });
    
    const metaRef = ref(this.db, `chats/${chatId}/meta`);
    await set(metaRef, { lastMessage: text, lastUpdate: Date.now(), participants: chatId.split('_') });
  }

  getMessages(chatId: string): Observable<ChatMessage[]> {
    const messagesRef = ref(this.db, `chats/${chatId}/messages`);
    const q = query(messagesRef, orderByChild('createdAt'));
    return listVal(q) as Observable<ChatMessage[]>;
  }

  getContacts(currentUserId: string): Observable<UserProfile[]> {
    return this.userService.getAllUsers().pipe(
      map(users => users.filter(u => u.uid !== currentUserId))
    );
  }
}



==============================================================================
FICHIER : src/app/core/services/trip.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Firestore, collection, addDoc, collectionData, doc, updateDoc, deleteDoc, arrayUnion } from '@angular/fire/firestore';
import { Observable } from 'rxjs';

export interface Parcel {
  description: string;
  weight: number;
  recipient: string;
  delivered?: boolean; // NOUVEAU : Statut de livraison
}

export interface GeoLocation {
  lat: number;
  lng: number;
  city: string;
  lastUpdate: string;
}

export interface TripRequest {
  type: 'PARCEL' | 'PASSENGER';
  description?: string;
  parcels?: Parcel[];
  requesterName: string;
  requesterEmail?: string;
  requesterCompany?: string;
  status: 'PENDING' | 'ACCEPTED' | 'REJECTED';
  createdAt: string;
}

export interface Trip {
  uid?: string;
  departure: string;
  destination: string;
  
  departureLat?: number;
  departureLng?: number;
  destinationLat?: number;
  destinationLng?: number;

  date: string;
  status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED';
  driverId: string;
  carId: string;
  company: string;
  currentLocation?: GeoLocation;
  parcels: Parcel[];
  extraRequests?: TripRequest[];
}

@Injectable({
  providedIn: 'root'
})
export class TripService {
  private firestore = inject(Firestore);
  private tripsCollection = collection(this.firestore, 'trips');

  getTrips(): Observable<Trip[]> {
    return collectionData(this.tripsCollection, { idField: 'uid' }) as Observable<Trip[]>;
  }

  createTrip(trip: Trip) {
    return addDoc(this.tripsCollection, trip);
  }

  deleteTrip(tripId: string) {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return deleteDoc(tripRef);
  }

  updatePosition(tripId: string, location: GeoLocation, status: 'IN_PROGRESS' | 'COMPLETED') {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return updateDoc(tripRef, { 
      currentLocation: location,
      status: status
    });
  }

  // NOUVEAU : Mettre √† jour la liste des colis (pour cocher/d√©cocher livr√©)
  updateParcels(tripId: string, parcels: Parcel[]) {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return updateDoc(tripRef, { parcels });
  }

  addRequest(tripId: string, request: TripRequest) {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return updateDoc(tripRef, {
      extraRequests: arrayUnion(request)
    });
  }
}



==============================================================================
FICHIER : src/app/core/services/mock-data.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Firestore, collection, getDocs, writeBatch, doc } from '@angular/fire/firestore';
import { Auth } from '@angular/fire/auth';

@Injectable({
  providedIn: 'root'
})
export class MockDataService {
  private firestore = inject(Firestore);

  // VILLES DE TUNISIE POUR LES TRAJETS
  private cities = [
    { name: 'Tunis', lat: 36.8065, lng: 10.1815 },
    { name: 'Sfax', lat: 34.7406, lng: 10.7603 },
    { name: 'Sousse', lat: 35.8256, lng: 10.6084 },
    { name: 'Gab√®s', lat: 33.8815, lng: 10.0982 },
    { name: 'Bizerte', lat: 37.2744, lng: 9.8739 },
    { name: 'Nabeul', lat: 36.4540, lng: 10.7350 }
  ];

  async generateAll() {
    console.log('D√©but du nettoyage...');
    await this.clearFirestore();
    console.log('Base nettoy√©e. G√©n√©ration...');

    const batch = writeBatch(this.firestore);
    
    // 1. CR√âATION SOCI√âT√â
    const companyId = 'comp_tunisia_express';
    batch.set(doc(this.firestore, 'companies', companyId), {
      name: 'Tunisia Express',
      contactEmail: 'contact@tn-express.tn',
      isActive: true,
      createdAt: new Date().toISOString()
    });

    // 2. CR√âATION DES UTILISATEURS
    const drivers: any[] = []; // CORRECTION : Typage explicite
    const admins: any[] = [];  // CORRECTION : Typage explicite

    // -> 3 Chauffeurs
    for (let i = 1; i <= 3; i++) {
       const uid = 'driver_' + Date.now() + '_' + i;
       const driver = {
          uid: uid,
          email: `chauffeur${i}@test.com`,
          role: 'DRIVER',
          company: 'Tunisia Express',
          phoneNumber: '+216 20 000 00' + i,
          isActive: true,
          createdAt: new Date()
       };
       batch.set(doc(this.firestore, 'users', uid), driver);
       drivers.push(driver);

       const carId = 'car_' + uid;
       batch.set(doc(this.firestore, 'cars', carId), {
          model: 'Peugeot Partner',
          plate: `12${i} TN 4567`,
          status: 'BUSY',
          assignedDriverId: uid,
          company: 'Tunisia Express'
       });
    }

    // -> 2 Administrateurs
    for (let i = 1; i <= 2; i++) {
       const uid = 'admin_' + Date.now() + '_' + i;
       const admin = {
          uid: uid,
          email: `admin${i}@test.com`,
          role: 'ADMIN',
          company: 'Tunisia Express',
          phoneNumber: '+216 50 000 00' + i,
          isActive: true,
          createdAt: new Date()
       };
       batch.set(doc(this.firestore, 'users', uid), admin);
       admins.push(admin);
    }

    // 3. CR√âATION DES TRAJETS
    drivers.forEach((driver, index) => {
       for(let j=0; j<2; j++) {
          const start = this.cities[Math.floor(Math.random() * this.cities.length)];
          let end = this.cities[Math.floor(Math.random() * this.cities.length)];
          while(start.name === end.name) end = this.cities[Math.floor(Math.random() * this.cities.length)];

          const tripId = 'trip_' + driver.uid + '_' + j;
          const creator = (Math.random() > 0.5) ? admins[0].email : 'admin@gmail.com'; 

          batch.set(doc(this.firestore, 'trips', tripId), {
             departure: start.name,
             destination: end.name,
             date: new Date().toISOString(),
             status: 'IN_PROGRESS',
             driverId: driver.uid,
             carId: 'car_' + driver.uid,
             company: 'Tunisia Express',
             currentLocation: { lat: start.lat, lng: start.lng, city: start.name, lastUpdate: new Date().toISOString() },
             parcels: [
                { description: 'Colis A', weight: 10, recipient: 'Client X', delivered: false },
                { description: 'Documents', weight: 1, recipient: 'Banque', delivered: true }
             ],
             extraRequests: [
                { requesterEmail: creator, type: 'PARCEL', description: 'Urgent', status: 'PENDING', createdAt: new Date().toISOString() }
             ]
          });
       }
    });

    await batch.commit();
    alert('Donn√©es g√©n√©r√©es : 3 Chauffeurs, 2 Admins, 1 Soci√©t√©, 6 Trajets.');
  }

  private async clearFirestore() {
    const collections = ['users', 'companies', 'cars', 'trips', 'chats'];
    for (const colName of collections) {
      const q = collection(this.firestore, colName);
      const snapshot = await getDocs(q);
      const batch = writeBatch(this.firestore);
      snapshot.docs.forEach((d) => {
         const data = d.data();
         if (colName === 'users' && data['email'] === 'admin@gmail.com') return;
         batch.delete(d.ref);
      });
      await batch.commit();
    }
  }
}



==============================================================================
FICHIER : src/app/core/services/company.service.ts
==============================================================================
import { Injectable, inject, signal } from '@angular/core';
import { Firestore } from '@angular/fire/firestore';
import { collectionData } from '@angular/fire/firestore'; // Import AngularFire pour l'Observable
import { collection, addDoc, updateDoc, doc } from 'firebase/firestore'; // Imports Natifs pour les actions
import { Observable } from 'rxjs';

export interface Company {
  uid?: string;
  name: string;
  contactEmail: string;
  isActive: boolean;
  createdAt: string;
}

@Injectable({
  providedIn: 'root'
})
export class CompanyService {
  private firestore = inject(Firestore);
  
  // Utilisation de la fonction collection native avec l'instance inject√©e
  private get companiesCollection() {
    return collection(this.firestore, 'companies');
  }

  activeCompanies = signal<Company[]>([]);

  constructor() {
    this.getCompanies().subscribe(companies => {
      const active = companies.filter(c => c.isActive);
      this.activeCompanies.set(active);
    });
  }

  getCompanies(): Observable<Company[]> {
    // collectionData accepte une r√©f√©rence native et retourne un Observable
    return collectionData(this.companiesCollection, { idField: 'uid' }) as Observable<Company[]>;
  }

  addCompany(company: Omit<Company, 'uid' | 'createdAt'>) {
    const newCompany: Company = {
      ...company,
      isActive: true,
      createdAt: new Date().toISOString()
    };
    return addDoc(this.companiesCollection, newCompany);
  }

  updateCompany(uid: string, data: Partial<Omit<Company, 'uid' | 'createdAt'>>) {
    const companyRef = doc(this.firestore, 'companies', uid);
    return updateDoc(companyRef, data);
  }

  toggleStatus(uid: string, isActive: boolean) {
    return this.updateCompany(uid, { isActive });
  }
}



==============================================================================
FICHIER : src/app/core/services/user.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Firestore, collection, doc, updateDoc, onSnapshot } from '@angular/fire/firestore';
import { Observable } from 'rxjs';
import { UserProfile } from '../auth/auth.service';

@Injectable({
  providedIn: 'root'
})
export class UserService {
  private firestore = inject(Firestore);

  // CORRECTION : On utilise new Observable + onSnapshot au lieu de collectionData
  // Cela contourne le bug "outside injection context"
  getAllUsers(): Observable<UserProfile[]> {
    return new Observable((observer) => {
      const usersRef = collection(this.firestore, 'users');
      
      // √âcoute temps r√©el native
      const unsubscribe = onSnapshot(usersRef, 
        (snapshot) => {
          const users = snapshot.docs.map(d => ({ 
            uid: d.id, 
            ...d.data() 
          })) as UserProfile[];
          observer.next(users);
        },
        (error) => {
          observer.error(error);
        }
      );

      // Nettoyage lors du d√©sabonnement
      return () => unsubscribe();
    });
  }

  // Mettre √† jour le statut (Validation)
  updateUserStatus(uid: string, isActive: boolean): Promise<void> {
    const userRef = doc(this.firestore, 'users', uid);
    return updateDoc(userRef, { isActive });
  }

  // Mettre √† jour le r√¥le (Promotion)
  updateUserRole(uid: string, role: 'DRIVER' | 'EMPLOYEE' | 'ADMIN' | 'SUPER_ADMIN'): Promise<void> {
    const userRef = doc(this.firestore, 'users', uid);
    return updateDoc(userRef, { role });
  }
}



==============================================================================
FICHIER : src/app/core/guards/admin.guard.ts
==============================================================================
import { inject } from '@angular/core';
import { CanActivateFn, Router } from '@angular/router';
import { AuthService } from '../auth/auth.service';
import { map, switchMap, take } from 'rxjs/operators';
import { of } from 'rxjs';

export const adminGuard: CanActivateFn = (route, state) => {
  const auth = inject(AuthService);
  const router = inject(Router);
  if (true) return true;
  return auth.user$.pipe(
    take(1),
    switchMap(user => {
      if (!user) return of(null);
      return auth.getUserProfile(user.uid);
    }),
    map(profile => {
      // V√©rification des r√¥les (case sensitive selon votre convention, ici UPPERCASE pour matcher AuthService)
      // Note: Le patch perl ci-dessus a ajout√© SUPER_ADMIN au type UserProfile pour √©viter l'erreur TS
      if (profile && (profile.role === 'ADMIN' || profile.role === 'SUPER_ADMIN')) {
        return true;
      }
      
      // Redirection si pas admin
      return router.createUrlTree(['/login']);
    })
  );
};



==============================================================================
FICHIER : src/app/app.component.scss
==============================================================================



==============================================================================
FICHIER : src/app/app.routes.ts
==============================================================================
import { Routes } from '@angular/router';
import { LoginComponent } from './core/auth/login/login.component';
import { RegisterComponent } from './core/auth/register/register.component';
import { CompleteProfileComponent } from './core/auth/complete-profile/complete-profile.component';
import { DriverDashboardComponent } from './features/driver/dashboard/driver-dashboard.component'; // NOUVEL IMPORT
import { adminGuard } from './core/guards/admin.guard';

export const routes: Routes = [
  { path: 'login', component: LoginComponent },
  { path: 'register', component: RegisterComponent },
  { path: 'complete-profile', component: CompleteProfileComponent },
  
  // Route Chauffeur (Pas d'Admin Guard)
  { path: 'driver', component: DriverDashboardComponent },

  // Routes Admin prot√©g√©es
  {
    path: 'admin',
    loadChildren: () => import('./features/admin/admin.routes').then(m => m.ADMIN_ROUTES),
    canActivate: [adminGuard]
  },
  
  { path: '', redirectTo: 'login', pathMatch: 'full' }
];



==============================================================================
FICHIER : src/app/app.ts
==============================================================================
import { Component, signal } from '@angular/core';
import { RouterOutlet } from '@angular/router';

@Component({
  selector: 'app-root',
  imports: [RouterOutlet],
  templateUrl: './app.html',
  styleUrl: './app.scss'
})
export class App {
  protected readonly title = signal('master-delivery');
}



==============================================================================
FICHIER : src/app/app.component.spec.ts
==============================================================================
import { ComponentFixture, TestBed } from '@angular/core/testing';

import { AppComponent } from './app.component';

describe('AppComponent', () => {
  let component: AppComponent;
  let fixture: ComponentFixture<AppComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [AppComponent]
    })
    .compileComponents();

    fixture = TestBed.createComponent(AppComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



==============================================================================
FICHIER : src/app/features/chat/chat.component.ts
==============================================================================
import { Component, inject, OnInit, signal, ViewChild, ElementRef } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { ChatService, ChatMessage } from '../../core/services/chat.service';
import { AuthService, UserProfile } from '../../core/auth/auth.service';
import { Observable, of, combineLatest } from 'rxjs';
import { toSignal } from '@angular/core/rxjs-interop';

@Component({
  selector: 'app-chat',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <div class="flex h-[calc(100vh-100px)] bg-white border rounded-lg shadow-sm overflow-hidden m-4">
      <div class="w-80 border-r border-gray-200 flex flex-col bg-gray-50">
        <div class="p-4 border-b border-gray-200 bg-indigo-50"><h2 class="font-bold text-indigo-900">Discussions</h2></div>
        <div class="flex-1 overflow-y-auto">
          @for (user of contacts$ | async; track user.uid) {
            <div (click)="selectUser(user)" class="p-4 border-b border-gray-100 cursor-pointer hover:bg-white flex items-center gap-3" [class.bg-white]="selectedUser()?.uid === user.uid">
              <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold shrink-0">{{ user.email.charAt(0).toUpperCase() }}</div>
              <div class="overflow-hidden"><p class="text-sm font-semibold truncate">{{ user.email }}</p><p class="text-xs text-gray-500">{{ user.role }}</p></div>
            </div>
          }
        </div>
      </div>
      <div class="flex-1 flex flex-col bg-slate-50 relative">
        @if (selectedUser(); as recipient) {
          <div class="p-4 bg-white border-b shadow-sm flex items-center gap-3">
             <div class="h-8 w-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold">{{ recipient.email.charAt(0).toUpperCase() }}</div>
             <div><h3 class="font-bold text-gray-800">{{ recipient.email }}</h3></div>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-3" #scrollContainer>
             @for (msg of messages$ | async; track msg.createdAt) {
                <div class="flex" [ngClass]="msg.senderId === currentUser()?.uid ? 'justify-end' : 'justify-start'">
                   <div class="max-w-[70%] px-4 py-2 rounded-2xl text-sm shadow-sm" [ngClass]="msg.senderId === currentUser()?.uid ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'">
                      {{ msg.text }}
                      <div class="text-[10px] mt-1 opacity-70 text-right">{{ msg.createdAt | date:'HH:mm' }}</div>
                   </div>
                </div>
             }
          </div>
          <form (ngSubmit)="sendMessage()" class="p-4 bg-white border-t flex gap-2">
             <input [(ngModel)]="newMessage" name="msg" placeholder="..." class="flex-1 border-gray-300 rounded-full px-4 py-2 bg-gray-100 outline-none">
             <button type="submit" [disabled]="!newMessage.trim()" class="bg-indigo-600 text-white w-10 h-10 rounded-full shadow flex items-center justify-center">‚û§</button>
          </form>
        } @else {
          <div class="flex-1 flex flex-col items-center justify-center text-gray-400"><span class="text-6xl mb-4">üí¨</span><p>S√©lectionnez une conversation</p></div>
        }
      </div>
    </div>
  `
})
export class ChatComponent implements OnInit {
  private chatService = inject(ChatService);
  public authService = inject(AuthService);
  @ViewChild('scrollContainer') private scrollContainer!: ElementRef;
  currentUser = toSignal(this.authService.user$);
  contacts$: Observable<UserProfile[]> = of([]);
  messages$: Observable<ChatMessage[]> = of([]);
  selectedUser = signal<UserProfile | null>(null);
  newMessage = '';

  ngOnInit() {
    this.authService.user$.subscribe(u => { if (u) this.contacts$ = this.chatService.getContacts(u.uid); });
    combineLatest([this.authService.user$, this.chatService.targetUser$]).subscribe(([currentUser, targetUser]) => {
      if (currentUser && targetUser && this.selectedUser()?.uid !== targetUser.uid) {
         this.selectUser(targetUser, currentUser.uid);
      }
    });
  }
  selectUser(user: UserProfile, currentUserId?: string) {
    this.selectedUser.set(user);
    const uid = currentUserId || this.currentUser()?.uid;
    if (uid) {
       const chatId = this.chatService.getConversationId(uid, user.uid);
       this.messages$ = this.chatService.getMessages(chatId);
       setTimeout(() => { if(this.scrollContainer) this.scrollContainer.nativeElement.scrollTop = 99999; }, 200);
    }
  }
  sendMessage() {
    if (this.currentUser()?.uid && this.selectedUser() && this.newMessage.trim()) {
       const chatId = this.chatService.getConversationId(this.currentUser()!.uid, this.selectedUser()!.uid);
       this.chatService.sendMessage(chatId, this.currentUser()!.uid, this.newMessage);
       this.newMessage = '';
       setTimeout(() => { if(this.scrollContainer) this.scrollContainer.nativeElement.scrollTop = 99999; }, 100);
    }
  }
}



==============================================================================
FICHIER : src/app/features/driver/dashboard/driver-dashboard.component.ts
==============================================================================
import { Component, inject, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { AuthService } from '../../../core/auth/auth.service';
import { TripService } from '../../../core/services/trip.service';
import { CarService } from '../../../core/services/car.service';
import { toSignal } from '@angular/core/rxjs-interop';
import { combineLatest, map } from 'rxjs';
import { Firestore, doc, updateDoc } from '@angular/fire/firestore';

@Component({
  selector: 'app-driver-dashboard',
  standalone: true,
  imports: [CommonModule],
  template: `
    <div class="min-h-screen bg-gray-50 flex flex-col">
      <header class="bg-white shadow-sm border-b border-gray-200 relative z-10">
        <div class="max-w-7xl mx-auto py-4 px-4 flex justify-between items-center">
          <h1 class="text-xl font-bold text-gray-900">üß¢ Espace Chauffeur</h1>
          <button (click)="logout()" class="text-sm text-red-600 font-medium">D√©connexion</button>
        </div>
      </header>
      <main class="flex-1 max-w-7xl mx-auto w-full py-8 px-4 relative">
        <div *ngIf="missions().length > 0; else noMissions">
           <h2 class="text-xl font-bold text-gray-800 mb-6">Vos Missions ({{ missions().length }})</h2>
           <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
              @for (trip of missions(); track trip.uid) {
                 <div class="bg-white shadow-sm rounded-xl border border-gray-100 p-6">
                    <div class="flex justify-between mb-4">
                       <span class="font-bold text-lg">{{ trip.destination }}</span>
                       <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800">{{ trip.status }}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Depuis: {{ trip.departure }}</p>
                    <button (click)="viewDetails(trip)" class="w-full bg-indigo-600 text-white py-2 rounded">Voir D√©tails</button>
                 </div>
              }
           </div>
        </div>
        <ng-template #noMissions><div class="text-center py-12 text-gray-500">Aucune mission assign√©e.</div></ng-template>
        <div *ngIf="selectedTrip()" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl p-6 max-w-lg w-full">
                <h3 class="font-bold text-lg mb-4">D√©tails Mission</h3>
                <p>Destination: {{ selectedTrip().destination }}</p>
                <div class="flex gap-2 mt-6">
                   <button (click)="closeDetails()" class="flex-1 bg-gray-100 py-2 rounded">Fermer</button>
                   <button *ngIf="selectedTrip().status === 'PENDING'" (click)="startMission()" class="flex-1 bg-green-600 text-white py-2 rounded">D√©marrer</button>
                   <button *ngIf="selectedTrip().status === 'IN_PROGRESS'" (click)="completeMission()" class="flex-1 bg-red-600 text-white py-2 rounded">Terminer</button>
                </div>
            </div>
        </div>
      </main>
    </div>
  `
})
export class DriverDashboardComponent {
  private authService = inject(AuthService);
  private tripService = inject(TripService);
  private carService = inject(CarService);
  private firestore = inject(Firestore);
  private user$ = this.authService.user$;
  private cars$ = this.carService.getCars();
  private allTrips$ = this.tripService.getTrips();
  selectedTrip = signal<any>(null);
  missions = toSignal(combineLatest([this.user$, this.cars$, this.allTrips$]).pipe(map(([user, cars, trips]) => {
        if (!user) return [];
        const myCar = cars.find(c => c.assignedDriverId === user.uid);
        if (!myCar) return [];
        return trips.filter(t => t.carId === myCar.uid);
      })), { initialValue: [] });
  viewDetails(trip: any) { this.selectedTrip.set(trip); }
  closeDetails() { this.selectedTrip.set(null); }
  async startMission() { if(this.selectedTrip()) { await updateDoc(doc(this.firestore, 'trips', this.selectedTrip().uid), { status: 'IN_PROGRESS' }); this.closeDetails(); } }
  async completeMission() { if(this.selectedTrip() && confirm('Terminer ?')) { await updateDoc(doc(this.firestore, 'trips', this.selectedTrip().uid), { status: 'COMPLETED' }); this.closeDetails(); } }
  logout() { this.authService.logout().subscribe(); }
}



==============================================================================
FICHIER : src/app/features/admin/home/admin-home.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { UserService } from '../../../core/services/user.service';
import { map } from 'rxjs/operators';
import { RouterLink } from '@angular/router';

@Component({
  selector: 'app-admin-home',
  standalone: true,
  imports: [CommonModule, RouterLink],
  template: `
    <div class="space-y-6">
      
      <!-- Welcome Section -->
      <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-indigo-600">
        <h2 class="text-2xl font-bold text-gray-800">Bienvenue sur votre Tableau de Bord</h2>
        <p class="text-gray-600 mt-1">Voici un aper√ßu de l'activit√© de votre flotte aujourd'hui.</p>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- Card 1: Total Users -->
        <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase">Utilisateurs Total</p>
              <h3 class="text-3xl font-bold text-gray-900 mt-2">{{ (stats$ | async)?.total || 0 }}</h3>
            </div>
            <div class="p-3 bg-blue-50 rounded-full">
              <span class="text-2xl">üë•</span>
            </div>
          </div>
          <div class="mt-4 flex items-center text-sm text-gray-600">
            <span class="text-green-600 font-medium flex items-center">
              <span class="mr-1">‚Üë</span> Actifs
            </span>
            <span class="mx-2 text-gray-300">|</span>
            <span class="text-gray-500">Employ√©s & Chauffeurs</span>
          </div>
        </div>

        <!-- Card 2: Drivers -->
        <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase">Chauffeurs</p>
              <h3 class="text-3xl font-bold text-gray-900 mt-2">{{ (stats$ | async)?.drivers || 0 }}</h3>
            </div>
            <div class="p-3 bg-indigo-50 rounded-full">
               <span class="text-2xl">üß¢</span>
            </div>
          </div>
          <div class="mt-4">
             <a routerLink="/admin/drivers" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Voir les d√©tails ‚Üí</a>
          </div>
        </div>

        <!-- Card 3: Pending Validations -->
        <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase">En attente</p>
              <h3 class="text-3xl font-bold text-orange-600 mt-2">{{ (stats$ | async)?.pending || 0 }}</h3>
            </div>
            <div class="p-3 bg-orange-50 rounded-full">
               <span class="text-2xl">‚ö†Ô∏è</span>
            </div>
          </div>
          <div class="mt-4 text-sm text-gray-500">
            Utilisateurs √† valider
          </div>
        </div>
      </div>

      <!-- Quick Actions / Recent Activity Placeholder -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">Actions Rapides</h3>
          <div class="grid grid-cols-2 gap-4">
            <button class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-indigo-300 transition text-left group">
              <span class="block text-xl mb-2 group-hover:scale-110 transition-transform">üöö</span>
              <span class="font-semibold text-gray-700">Ajouter un V√©hicule</span>
            </button>
            <button routerLink="/register" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-indigo-300 transition text-left group">
              <span class="block text-xl mb-2 group-hover:scale-110 transition-transform">üë§</span>
              <span class="font-semibold text-gray-700">Cr√©er un Utilisateur</span>
            </button>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6">
           <h3 class="text-lg font-bold text-gray-800 mb-4">√âtat du Syst√®me</h3>
           <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-green-50 rounded border border-green-100">
                 <span class="text-green-800 font-medium">Base de donn√©es</span>
                 <span class="bg-green-200 text-green-800 text-xs px-2 py-1 rounded-full">Connect√©</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-100">
                 <span class="text-gray-700">Version API</span>
                 <span class="text-gray-500 text-sm">v1.0.0</span>
              </div>
           </div>
        </div>
      </div>
    </div>
  `
})
export class AdminHomeComponent {
  private userService = inject(UserService);

  // Calcul des statistiques en temps r√©el depuis le UserService
  stats$ = this.userService.getAllUsers().pipe(
    map(users => ({
      total: users.length,
      drivers: users.filter(u => u.role === 'DRIVER').length,
      pending: users.filter(u => !u.isActive).length
    }))
  );
}



==============================================================================
FICHIER : src/app/features/admin/mock-data/mock-data.component.ts
==============================================================================
import { Component, inject, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { MockDataService } from '../../../core/services/mock-data.service';

@Component({
  selector: 'app-mock-data',
  standalone: true,
  imports: [CommonModule],
  template: `
    <div class="max-w-4xl mx-auto py-10 px-4">
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-8 text-white">
          <h2 class="text-3xl font-bold flex items-center gap-3">
             <span class="text-4xl">‚ö°</span> G√©n√©rateur de Donn√©es
          </h2>
          <p class="mt-2 text-purple-100">R√©initialisation et peuplement de la base de donn√©es.</p>
        </div>

        <div class="p-8">
           <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
              <div class="flex">
                <span class="text-yellow-400 text-xl mr-3">‚ö†Ô∏è</span>
                <div>
                  <p class="text-sm text-yellow-700 font-bold">Action Destructive</p>
                  <p class="text-xs text-yellow-600 mt-1">
                    Ceci supprimera tous les utilisateurs (sauf vous), trajets et soci√©t√©s.
                  </p>
                </div>
              </div>
           </div>

           <div class="space-y-4 mb-8 text-gray-600">
              <h3 class="font-bold text-gray-800 border-b pb-2">Ce qui sera cr√©√© :</h3>
              <ul class="list-disc pl-5 space-y-1">
                 <li>üè¢ <strong>1 Soci√©t√©</strong> (Tunisia Express)</li>
                 <li>üëÆ <strong>2 Administrateurs</strong> (admin1@test.com, admin2@test.com)</li>
                 <li>üß¢ <strong>3 Chauffeurs</strong> (chauffeur1@test.com...)</li>
                 <li>üöö <strong>3 V√©hicules</strong> assign√©s</li>
                 <li>üì¶ <strong>6 Trajets</strong> (2 par chauffeur)</li>
              </ul>
           </div>
              
           <button (click)="generate()" [disabled]="isLoading()" 
              class="w-full py-4 px-6 rounded-xl text-white font-bold text-lg shadow-lg transform transition hover:scale-105 disabled:opacity-50 disabled:transform-none bg-indigo-600 hover:bg-indigo-700">
              {{ isLoading() ? 'Traitement en cours...' : 'Lancer la G√©n√©ration' }}
           </button>
        </div>
      </div>
    </div>
  `
})
export class MockDataComponent {
  private mockService = inject(MockDataService);
  isLoading = signal(false);

  async generate() {
    if(confirm('√ätes-vous s√ªr de vouloir tout √©craser ?')) {
      this.isLoading.set(true);
      try {
        await this.mockService.generateAll();
      } catch (e) {
        alert('Erreur: ' + e);
      }
      this.isLoading.set(false);
    }
  }
}



==============================================================================
FICHIER : src/app/features/admin/admin.routes.ts
==============================================================================
import { Routes } from '@angular/router';
import { AdminDashboardComponent } from './dashboard/admin-dashboard.component';
import { UserListComponent } from './users/user-list.component';
import { AdminHomeComponent } from './home/admin-home.component';
import { CarManagerComponent } from './cars/car-manager.component';
import { TripManagerComponent } from './trips/trip-manager.component';
import { CompanyManagerComponent } from './companies/company-manager.component';
import { LiveMapComponent } from './live-map/live-map.component';
import { MockDataComponent } from './mock-data/mock-data.component';
import { ChatComponent } from '../chat/chat.component'; // CHEMIN CORRIG√â (../ au lieu de ../../)

export const ADMIN_ROUTES: Routes = [
  {
    path: '',
    component: AdminDashboardComponent,
    children: [
      { path: '', component: AdminHomeComponent, title: 'Administration - Accueil' },
      { path: 'live-map', component: LiveMapComponent, title: 'Administration - Carte Live' },
      { path: 'users', component: UserListComponent, title: 'Administration - Utilisateurs' },
      { path: 'cars', component: CarManagerComponent, title: 'Administration - Flotte' },
      { path: 'trips', component: TripManagerComponent, title: 'Administration - Trajets' },
      { path: 'companies', component: CompanyManagerComponent, title: 'Administration - Soci√©t√©s' },
      { path: 'mock-data', component: MockDataComponent, title: 'Administration - Donn√©es Test' },
      { path: 'chat', component: ChatComponent, title: 'Administration - Messagerie' },
      { path: 'drivers', redirectTo: 'users' }
    ]
  }
];



==============================================================================
FICHIER : src/app/features/admin/dashboard/admin-dashboard.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterOutlet, RouterLink, RouterLinkActive } from '@angular/router';
import { AuthService } from '../../../core/auth/auth.service';
import { ChatComponent } from '../../chat/chat.component';
import { switchMap } from 'rxjs/operators';
import { of } from 'rxjs';
import { toSignal } from '@angular/core/rxjs-interop';

@Component({
  selector: 'app-admin-dashboard',
  standalone: true,
  imports: [CommonModule, RouterOutlet, RouterLink, RouterLinkActive, ChatComponent],
  template: `
    <div class="min-h-screen bg-gray-50 flex flex-col lg:flex-row">
      
      <div *ngIf="isMobileMenuOpen" (click)="closeMobileMenu()" 
           class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9998] lg:hidden transition-opacity">
      </div>

      <aside class="fixed inset-y-0 left-0 z-[10000] w-72 bg-slate-900 text-white shadow-2xl flex flex-col transition-transform duration-300 transform lg:translate-x-0"
             [ngClass]="isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'">
        
        <div class="h-20 flex items-center px-8 border-b border-slate-800 bg-slate-950/50">
          <span class="text-xl font-bold tracking-wide text-white">Master<span class="text-indigo-400">DELIVERY</span></span>
        </div>

        <nav class="flex-1 py-8 px-4 space-y-1 overflow-y-auto">
          
          <a routerLink="/admin" [routerLinkActiveOptions]="{exact: true}" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üè†</span> Accueil
          </a>

          <a routerLink="/admin/live-map" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üåç</span> Carte Live
          </a>

          <a routerLink="/admin/trips" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üì¶</span> Trajets
          </a>

          <a routerLink="/admin/users" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üë•</span> Utilisateurs
          </a>

          <a routerLink="/admin/cars" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üöö</span> V√©hicules
          </a>
          
          <a routerLink="/admin/companies" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üè¢</span> Soci√©t√©s
          </a>

          <a routerLink="/admin/chat" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üí¨</span> Messagerie
          </a>

          <a routerLink="/admin/mock-data" routerLinkActive="bg-purple-600/20 text-white border-l-4 border-purple-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-purple-300 hover:text-white mb-1 mt-6 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">‚ö°</span> Donn√©es Test
          </a>
          
          <button (click)="logout()" class="w-full flex items-center px-4 py-3 text-red-400 hover:text-red-300 mt-6 border-t border-slate-800 pt-4 cursor-pointer hover:bg-slate-800 transition-all">
             <span class="mr-3">üö™</span> D√©connexion
          </button>
        </nav>
      </aside>

      <div class="lg:pl-72 flex flex-col h-screen w-full relative transition-all duration-300">
        <header class="bg-white border-b h-16 flex items-center justify-between px-4 lg:hidden sticky top-0 z-20 shadow-sm">
             <button (click)="toggleMobileMenu()" class="text-2xl text-indigo-600 p-2">‚ò∞</button>
             <span class="font-bold text-gray-800">Master<span class="text-indigo-600">Delivery</span></span>
        </header>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-4">
             <router-outlet></router-outlet>
        </main>
      </div>

      <app-chat></app-chat>

    </div>
  `
})
export class AdminDashboardComponent {
  private authService = inject(AuthService);
  isMobileMenuOpen = false;
  userProfile = toSignal(this.authService.user$.pipe(switchMap(user => user ? this.authService.getUserProfile(user.uid) : of(null))));
  
  toggleMobileMenu() { this.isMobileMenuOpen = !this.isMobileMenuOpen; }
  
  // NOUVELLE M√âTHODE : Ferme explicitement le menu
  closeMobileMenu() { this.isMobileMenuOpen = false; }
  
  logout() { this.authService.logout().subscribe(); }
}



==============================================================================
FICHIER : src/app/features/admin/users/user-list.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router'; // 1. Import du Router
import { UserService } from '../../../core/services/user.service';
import { AuthService, UserProfile } from '../../../core/auth/auth.service';
import { ChatService } from '../../../core/services/chat.service';
import { Observable } from 'rxjs';
import { toSignal } from '@angular/core/rxjs-interop';

@Component({
  selector: 'app-user-list',
  standalone: true,
  imports: [CommonModule],
  template: `
    <div class="bg-white shadow rounded-lg overflow-hidden">
      <div class="px-4 py-5 sm:px-6 flex justify-between items-center bg-indigo-50">
        <div>
           <h3 class="text-lg leading-6 font-bold text-gray-900">Gestion des Utilisateurs</h3>
        </div>
        <span class="bg-white text-indigo-600 py-1 px-3 rounded-full text-xs font-bold border border-indigo-200">
          Total: {{ (users$ | async)?.length || 0 }}
        </span>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Utilisateur</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">T√©l√©phone</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">R√¥le</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            @for (user of users$ | async; track user.uid) {
              <tr class="hover:bg-gray-50 group">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="h-8 w-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-bold mr-3">
                      {{ user.email.charAt(0).toUpperCase() }}
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-900 flex items-center gap-2">
                         {{ user.email }}
                         
                         <button (click)="openChat(user)" 
                                 class="opacity-50 group-hover:opacity-100 transition-opacity bg-indigo-100 hover:bg-indigo-200 text-indigo-700 p-1 rounded-full flex items-center justify-center h-6 w-6" 
                                 title="Discuter">
                            üí¨
                         </button>
                      </div>
                      <div class="text-xs text-gray-500">{{ user.company }}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono font-bold">
                   <a *ngIf="user.phoneNumber" [href]="'tel:' + user.phoneNumber" class="text-indigo-700 hover:text-indigo-900 hover:underline">
                     {{ user.phoneNumber }}
                   </a>
                   <span *ngIf="!user.phoneNumber" class="text-gray-400">N/A</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                    [ngClass]="{
                      'bg-purple-100 text-purple-800': user.role === 'ADMIN' || user.role === 'SUPER_ADMIN',
                      'bg-blue-100 text-blue-800': user.role === 'DRIVER',
                      'bg-green-100 text-green-800': user.role === 'EMPLOYEE'
                    }">
                    {{ user.role }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                   <span *ngIf="user.isActive" class="text-green-600 text-xs font-bold">Actif</span>
                   <span *ngIf="!user.isActive" class="text-red-600 text-xs font-bold">Inactif</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <button *ngIf="!user.isActive" (click)="toggleStatus(user, true)" class="text-green-600 hover:text-green-900 mr-2">Valider</button>
                  <button *ngIf="user.isActive" (click)="toggleStatus(user, false)" class="text-red-600 hover:text-red-900 mr-2">D√©sactiver</button>
                  <button *ngIf="isSuperAdmin() && user.role !== 'ADMIN' && user.role !== 'SUPER_ADMIN'" (click)="promoteToAdmin(user)" class="text-indigo-600 hover:text-indigo-900">‚òÖ Admin</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  `
})
export class UserListComponent {
  private userService = inject(UserService);
  private authService = inject(AuthService);
  private chatService = inject(ChatService);
  private router = inject(Router); // 2. Injection du Router

  users$: Observable<UserProfile[]> = this.userService.getAllUsers();
  currentUser = toSignal(this.authService.user$);

  isSuperAdmin(): boolean { return this.currentUser()?.email === 'admin@gmail.com'; }

  toggleStatus(user: UserProfile, status: boolean) {
    if(confirm(`Modifier le statut de ${user.email} ?`)) this.userService.updateUserStatus(user.uid, status);
  }

  promoteToAdmin(user: UserProfile) {
    if(confirm(`Promouvoir ${user.email} comme Admin ?`)) this.userService.updateUserRole(user.uid, 'ADMIN');
  }

  // 3. CORRECTION : Ouverture ET Redirection
  openChat(user: UserProfile) {
    this.chatService.startChatWith(user); // S√©lectionne l'utilisateur
    this.router.navigate(['/admin/chat']); // Redirige vers la page de chat
  }
}



==============================================================================
FICHIER : src/app/features/admin/cars/car-manager.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { CarService, Car } from '../../../core/services/car.service';
import { UserService } from '../../../core/services/user.service';
import { AuthService } from '../../../core/auth/auth.service';
import { Observable, combineLatest, of } from 'rxjs';
import { switchMap, map } from 'rxjs/operators';
import { toSignal } from '@angular/core/rxjs-interop';

@Component({
  selector: 'app-car-manager',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Info Admin -->
      <div class="lg:col-span-3 bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-4">
        <p class="text-sm font-semibold text-indigo-800">
          Gestion pour la soci√©t√© : 
          <span class="font-bold text-indigo-900">{{ adminCompany() || 'Chargement...' }}</span>
        </p>
      </div>

      <!-- Formulaire -->
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 h-fit">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Ajouter un V√©hicule</h3>
        <form [formGroup]="carForm" (ngSubmit)="addCar()" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Mod√®le</label>
            <input formControlName="model" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="Ex: Renault Kangoo">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Plaque</label>
            <input formControlName="plate" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="123 TN 4567">
          </div>
          <button type="submit" [disabled]="carForm.invalid || !adminCompany()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50">
             Ajouter √† {{ adminCompany() }}
          </button>
        </form>
      </div>

      <!-- Liste -->
      <div class="lg:col-span-2 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
           <h3 class="text-lg font-bold text-gray-800">Flotte {{ adminCompany() }}</h3>
        </div>
        
        <div *ngIf="(carsFiltered$ | async)?.length === 0" class="p-6 text-center text-gray-500">
           Aucun v√©hicule trouv√©.
        </div>

        <div class="overflow-x-auto" *ngIf="(carsFiltered$ | async)?.length ?? 0 > 0">
           <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">V√©hicule</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chauffeur</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                @for (car of carsFiltered$ | async; track car.uid) {
                   <tr>
                     <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-900">{{ car.model }}</div>
                        <div class="text-xs text-gray-500">{{ car.plate }}</div>
                     </td>
                     <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                           [ngClass]="{'bg-green-100 text-green-800': car.status === 'AVAILABLE', 'bg-red-100 text-red-800': car.status === 'BUSY'}">
                           {{ car.status }}
                        </span>
                     </td>
                     <td class="px-6 py-4 whitespace-nowrap">
                        <select #driverSelect (change)="assignDriver(car, driverSelect.value)" class="text-sm border-gray-300 rounded border p-1">
                           <option value="" [selected]="!car.assignedDriverId">-- Disponible --</option>
                           @for (driver of drivers$ | async; track driver.uid) {
                              <option [value]="driver.uid" [selected]="car.assignedDriverId === driver.uid">
                                 {{ driver.email }}
                              </option>
                           }
                        </select>
                     </td>
                   </tr>
                }
              </tbody>
           </table>
        </div>
      </div>
    </div>
  `
})
export class CarManagerComponent {
  private carService = inject(CarService);
  private userService = inject(UserService);
  private authService = inject(AuthService);
  private fb = inject(FormBuilder);

  // Gestion robuste de l'utilisateur connect√© avec switchMap pour √©viter l'erreur TS2533
  adminProfile$ = this.authService.user$.pipe(
    switchMap(user => user ? this.authService.getUserProfile(user.uid) : of(null))
  );
  
  // Signal pour l'affichage dans le template
  adminCompany = toSignal(this.adminProfile$.pipe(map(p => p?.company || null)));

  // Filtre des voitures : on ne montre que celles de la soci√©t√© de l'admin
  carsFiltered$ = combineLatest([this.carService.getCars(), this.adminProfile$]).pipe(
    map(([cars, profile]) => {
      if (!profile?.company) return [];
      return cars.filter(car => car.company === profile.company);
    })
  );

  // Filtre des chauffeurs : on ne montre que ceux de la soci√©t√© de l'admin
  drivers$ = combineLatest([this.userService.getAllUsers(), this.adminProfile$]).pipe(
    map(([users, profile]) => {
      if (!profile?.company) return [];
      return users.filter(u => u.role === 'DRIVER' && u.isActive && u.company === profile.company);
    })
  );

  carForm = this.fb.group({
    model: ['', Validators.required],
    plate: ['', Validators.required]
  });

  addCar() {
    const company = this.adminCompany();
    if (!company || this.carForm.invalid) return;

    const newCar: Car = {
      ...this.carForm.value as any,
      status: 'AVAILABLE',
      assignedDriverId: null,
      company: company // S√©curit√©: on force la soci√©t√© de l'admin
    };
    this.carService.addCar(newCar).then(() => {
      this.carForm.reset();
      alert('V√©hicule ajout√© !');
    });
  }

  assignDriver(car: Car, driverId: string) {
    // S√©curit√© suppl√©mentaire c√¥t√© client
    if (car.company !== this.adminCompany()) {
       alert("Action non autoris√©e sur ce v√©hicule.");
       return;
    }
    this.carService.assignDriver(car.uid!, driverId || null);
  }
}



==============================================================================
FICHIER : src/app/features/admin/trips/trip-manager.component.ts
==============================================================================
import { Component, inject, signal, computed } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators, FormArray } from '@angular/forms';
import { Router } from '@angular/router';
import { TripService, Trip, TripRequest } from '../../../core/services/trip.service';
import { CarService, Car } from '../../../core/services/car.service';
import { AuthService, UserProfile } from '../../../core/auth/auth.service';
import { CompanyService } from '../../../core/services/company.service'; 
import { UserService } from '../../../core/services/user.service';
import { ChatService } from '../../../core/services/chat.service';
import { toSignal } from '@angular/core/rxjs-interop';
import { startWith, map } from 'rxjs/operators';
import { combineLatest } from 'rxjs';

@Component({
  selector: 'app-trip-manager',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="space-y-6 p-6">
      <div class="flex justify-between items-center gap-4">
        <h2 class="text-2xl font-bold text-gray-800">Suivi des Trajets</h2>
        <button (click)="toggleForm()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 shadow-md transition-colors">
           {{ showForm ? 'Fermer' : 'Nouveau Trajet' }}
        </button>
      </div>

      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200" [formGroup]="filterForm">
         <select formControlName="company" class="w-full border-gray-300 rounded-md shadow-sm border p-2 text-sm bg-gray-50">
            <option value="">Toutes les soci√©t√©s</option>
            @for (company of activeCompanies(); track company.uid) {
               <option [value]="company.name">{{ company.name }}</option>
            }
         </select>
      </div>

      <div *ngIf="showForm" class="bg-white p-6 rounded-lg shadow-xl border-l-4 border-indigo-500 mb-6 animate-fade-in">
         <form [formGroup]="tripForm" (ngSubmit)="createTrip()">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
               <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">D√©part</label><input formControlName="departure" class="w-full border p-2 rounded"></div>
               <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Destination</label><input formControlName="destination" class="w-full border p-2 rounded"></div>
               <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">V√©hicule</label>
                  <select formControlName="carId" class="w-full border p-2 rounded">
                     <option value="">-- Choisir --</option>
                     @for (car of cars$ | async; track car.uid) { <option [value]="car.uid">{{ car.model }} ({{ car.plate }})</option> }
                  </select>
               </div>
            </div>
            <button type="submit" [disabled]="tripForm.invalid" class="bg-green-600 text-white px-6 py-2 rounded font-bold w-full md:w-auto">Valider</button>
         </form>
      </div>

      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
         <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
               <thead class="bg-gray-50">
                  <tr>
                     <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Trajet</th>
                     <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Statut</th>
                     <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Chauffeur</th>
                     <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
               </thead>
               <tbody class="bg-white divide-y divide-gray-200">
                  @for (trip of filteredTrips(); track trip.uid) {
                     <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                           <div class="flex flex-col">
                              <span class="text-sm font-bold text-gray-900">{{ trip.departure }} ‚ûù {{ trip.destination }}</span>
                              <span class="text-xs text-gray-500">{{ trip.company }}</span>
                              <span class="text-xs text-gray-400 mt-1">{{ trip.date | date:'dd/MM HH:mm' }}</span>
                           </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap">
                           <span class="px-2 py-1 text-xs font-bold rounded-full" 
                                 [ngClass]="{'bg-blue-100 text-blue-800': trip.status === 'IN_PROGRESS', 'bg-green-100 text-green-800': trip.status === 'COMPLETED', 'bg-yellow-100 text-yellow-800': trip.status === 'PENDING'}">
                              {{ trip.status }}
                           </span>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                           <div class="flex items-center gap-3">
                              <div *ngIf="trip.driverEmail; else noDriver" class="flex items-center gap-2">
                                 <div>
                                    <div class="text-sm font-medium text-gray-900">{{ trip.driverEmail }}</div>
                                    <div class="text-xs text-gray-500">{{ trip.driverPhone || 'T√©l inconnu' }}</div>
                                 </div>
                                 
                                 <button *ngIf="trip.driverProfile" (click)="openChat(trip.driverProfile)" 
                                         class="h-8 w-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition-colors shadow-sm" 
                                         title="Ouvrir le Chat">
                                    üí¨
                                 </button>
                              </div>
                              <ng-template #noDriver>
                                 <span class="text-xs text-gray-400 italic bg-gray-100 px-2 py-1 rounded">Non assign√©</span>
                              </ng-template>
                           </div>
                        </td>

                        <td class="px-6 py-4 text-right whitespace-nowrap">
                           <div class="flex justify-end items-center gap-2">
                              
                              <button (click)="openRequestModal(trip)" 
                                      class="p-2 text-xs font-medium bg-purple-50 text-purple-700 rounded hover:bg-purple-100 border border-purple-200 transition-colors flex items-center gap-1"
                                      title="Ajouter une demande">
                                 ‚ûï <span class="hidden xl:inline">Demande</span>
                              </button>
                              
                              <button (click)="handleTrackClick(trip)" 
                                      class="p-2 text-xs font-medium bg-blue-50 text-blue-700 rounded hover:bg-blue-100 border border-blue-200 transition-colors flex items-center gap-1"
                                      title="Voir sur la carte">
                                 üìç <span class="hidden xl:inline">Suivre</span>
                              </button>
                              
                              <button (click)="deleteTrip(trip)" 
                                      class="p-2 text-xs font-medium bg-red-50 text-red-700 rounded hover:bg-red-100 border border-red-200 transition-colors flex items-center gap-1"
                                      title="Supprimer le trajet">
                                 üóëÔ∏è <span class="hidden xl:inline">Suppr.</span>
                              </button>

                           </div>
                        </td>
                     </tr>
                  } @empty {
                     <tr><td colspan="4" class="p-8 text-center text-gray-500">Aucun trajet trouv√©.</td></tr>
                  }
               </tbody>
            </table>
         </div>
      </div>

      <div *ngIf="selectedTripForRequest" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
          <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md animate-fade-in-up">
             <h3 class="font-bold text-lg mb-4 text-gray-800">Ajouter une demande</h3>
             <form [formGroup]="requestForm" (ngSubmit)="submitRequest()">
                <div class="mb-4">
                   <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                   <select formControlName="type" class="w-full border-gray-300 rounded-md shadow-sm border p-2 bg-gray-50">
                      <option value="PARCEL">üì¶ Colis suppl√©mentaire</option>
                      <option value="PASSENGER">üôã Passager</option>
                   </select>
                </div>
                <div class="mb-4">
                   <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                   <textarea formControlName="description" rows="3" class="w-full border-gray-300 rounded-md shadow-sm border p-2 bg-gray-50" placeholder="D√©tails..."></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                   <button type="button" (click)="closeRequestModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Annuler</button>
                   <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md">Envoyer</button>
                </div>
             </form>
          </div>
      </div>
    </div>
  `
})
export class TripManagerComponent {
  private fb = inject(FormBuilder);
  private tripService = inject(TripService);
  private carService = inject(CarService);
  private authService = inject(AuthService);
  private companyService = inject(CompanyService);
  private userService = inject(UserService);
  private chatService = inject(ChatService);
  private router = inject(Router);
  
  showForm = false;
  selectedTripForRequest: Trip | null = null;
  cars$ = this.carService.getCars();
  private currentUser = toSignal(this.authService.user$);
  activeCompanies = this.companyService.activeCompanies;
  
  filterForm = this.fb.group({ company: [''], inProgressOnly: [false] });
  filterValues = toSignal(this.filterForm.valueChanges.pipe(startWith(this.filterForm.value)), { initialValue: this.filterForm.value });

  tripForm = this.fb.group({
    departure: ['', Validators.required],
    destination: ['', Validators.required],
    date: ['', Validators.required],
    carId: ['', Validators.required],
    parcels: this.fb.array([])
  });

  requestForm = this.fb.group({
    type: ['PARCEL', Validators.required],
    description: ['', Validators.required]
  });

  private enrichedTrips$ = combineLatest([
    this.tripService.getTrips(),
    this.userService.getAllUsers(),
    this.carService.getCars()
  ]).pipe(
    map(([trips, users, cars]: [Trip[], UserProfile[], Car[]]) => {
       return trips.map((trip: Trip) => {
          let driver = users.find((u: UserProfile) => u.uid === trip.driverId);
          if (!driver && trip.carId) {
             const car = cars.find((c: Car) => c.uid === trip.carId);
             if (car && car.assignedDriverId) {
                driver = users.find((u: UserProfile) => u.uid === car.assignedDriverId);
             }
          }
          return {
             ...trip,
             driverEmail: driver ? driver.email : null,
             driverPhone: driver ? driver.phoneNumber : null,
             driverProfile: driver
          };
       });
    })
  );

  private enrichedRawTrips = toSignal(this.enrichedTrips$, { initialValue: [] });

  filteredTrips = computed(() => {
    const trips = this.enrichedRawTrips();
    const filters = this.filterValues();
    return trips.filter((t: any) => {
       const matchesCompany = !filters?.company || t.company === filters.company;
       const matchesStatus = filters?.inProgressOnly ? t.status === 'IN_PROGRESS' : true;
       return matchesCompany && matchesStatus;
    });
  });
  
  toggleForm() { this.showForm = !this.showForm; }
  
  async createTrip() { 
    if (this.tripForm.valid) { 
      await this.tripService.createTrip({ 
        ...this.tripForm.value, 
        driverId: 'PENDING', 
        status: 'PENDING', 
        company: 'DHL', // Par d√©faut pour l'exemple
        parcels: [], 
        extraRequests: [] 
      } as any); 
      this.tripForm.reset(); 
      this.showForm = false; 
    } 
  }
  
  async deleteTrip(trip: Trip) { 
    if (confirm(`Supprimer ce trajet vers ${trip.destination} ?`)) {
      await this.tripService.deleteTrip(trip.uid!); 
    }
  }
  
  openRequestModal(trip: Trip) { this.selectedTripForRequest = trip; this.requestForm.reset({ type: 'PARCEL' }); }
  closeRequestModal() { this.selectedTripForRequest = null; }
  
  async submitRequest() { 
    if (this.requestForm.valid && this.selectedTripForRequest) { 
      await this.tripService.addRequest(this.selectedTripForRequest.uid!, { 
        ...this.requestForm.value, 
        requesterName: 'Admin', 
        requesterEmail: 'admin@gmail.com', 
        status: 'PENDING', 
        createdAt: new Date().toISOString() 
      } as any); 
      this.closeRequestModal(); 
      alert('Demande ajout√©e !');
    } 
  }

  openChat(user: UserProfile) {
    this.chatService.startChatWith(user);
    this.router.navigate(['/admin/chat']);
  }

  handleTrackClick(trip: Trip) {
     const url = `https://www.google.com/maps/dir/?api=1&origin=$?q=${encodeURIComponent(trip.departure)}&destination=${encodeURIComponent(trip.destination)}&travelmode=driving`;
     window.open(url, '_blank');
  }
}



==============================================================================
FICHIER : src/app/features/admin/companies/company-manager.component.ts
==============================================================================
import { Component, inject, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { CompanyService, Company } from '../../../core/services/company.service';
import { Observable } from 'rxjs';

@Component({
  selector: 'app-company-manager',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="space-y-6">
        <div class="flex justify-between items-center">
             <h2 class="text-2xl font-bold text-gray-800">Gestion des Soci√©t√©s</h2>
             <button (click)="toggleForm()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 shadow-md flex items-center gap-2 transition-all">
                <span class="text-xl">{{ showForm() ? '‚úï' : '+' }}</span>
                {{ showForm() ? 'Fermer' : 'Ajouter Soci√©t√©' }}
             </button>
        </div>

        <div *ngIf="showForm()" class="bg-white p-6 rounded-lg shadow-xl border-l-4 border-indigo-500 animate-fade-in">
           <h3 class="text-lg font-bold text-gray-800 mb-4">{{ isEditMode() ? 'Modifier' : 'Ajouter' }} une Soci√©t√©</h3>
           <form [formGroup]="companyForm" (ngSubmit)="saveCompany()" class="space-y-4">
              <div>
                 <label class="block text-sm font-medium text-gray-700">Nom</label>
                 <input formControlName="name" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
              </div>
              <div>
                 <label class="block text-sm font-medium text-gray-700">Email Contact</label>
                 <input formControlName="contactEmail" type="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
              </div>
              <div *ngIf="isEditMode()">
                  <label class="block text-sm font-medium text-gray-700">Statut</label>
                  <select formControlName="isActive" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
                      <option [ngValue]="true">Actif</option>
                      <option [ngValue]="false">Inactif</option>
                  </select>
              </div>
              <div class="flex justify-end gap-3">
                 <button type="button" (click)="resetForm()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-md">Annuler</button>
                 <button type="submit" [disabled]="companyForm.invalid" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 shadow-sm disabled:opacity-50">
                    Sauvegarder
                 </button>
              </div>
           </form>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
             <div class="overflow-x-auto">
                 <table class="min-w-full divide-y divide-gray-200">
                     <thead class="bg-gray-50">
                         <tr>
                             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nom</th>
                             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                             <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                         </tr>
                     </thead>
                     <tbody class="bg-white divide-y divide-gray-200">
                         @for (company of (companies$ | async); track company.uid) {
                             <tr class="hover:bg-gray-50 transition-colors">
                                 <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">{{ company.name }}</td>
                                 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ company.contactEmail }}</td>
                                 <td class="px-6 py-4 whitespace-nowrap">
                                     <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                         [ngClass]="company.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                         {{ company.isActive ? 'Actif' : 'Inactif' }}
                                     </span>
                                 </td>
                                 <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                                     <button (click)="editCompany(company)" class="text-indigo-600 hover:text-indigo-900">Modifier</button>
                                     <button (click)="toggleStatus(company)"
                                             [ngClass]="company.isActive ? 'text-red-600' : 'text-green-600'">
                                         {{ company.isActive ? 'D√©sactiver' : 'Activer' }}
                                     </button>
                                 </td>
                             </tr>
                         }
                     </tbody>
                 </table>
             </div>
        </div>
    </div>
  `
})
export class CompanyManagerComponent {
  private fb = inject(FormBuilder);
  private companyService = inject(CompanyService);

  companies$: Observable<Company[]> = this.companyService.getCompanies();
  showForm = signal(false);
  isEditMode = signal(false);
  currentCompanyId: string | null = null;

  companyForm = this.fb.group({
    name: ['', Validators.required],
    contactEmail: ['', [Validators.required, Validators.email]],
    isActive: [true]
  });

  toggleForm() {
    if (this.showForm() && this.isEditMode()) { this.resetForm(); } 
    else { this.showForm.set(!this.showForm()); this.isEditMode.set(false); }
  }

  editCompany(company: Company) {
    this.currentCompanyId = company.uid!;
    this.companyForm.patchValue({ name: company.name, contactEmail: company.contactEmail, isActive: company.isActive });
    this.isEditMode.set(true);
    this.showForm.set(true);
  }

  resetForm() {
    this.companyForm.reset({ isActive: true });
    this.isEditMode.set(false);
    this.showForm.set(false);
    this.currentCompanyId = null;
  }

  async saveCompany() {
    if (this.companyForm.invalid) return;
    const data = this.companyForm.value;
    
    if (this.isEditMode() && this.currentCompanyId) {
      await this.companyService.updateCompany(this.currentCompanyId, {
        name: data.name!, contactEmail: data.contactEmail!, isActive: data.isActive!
      });
    } else {
      await this.companyService.addCompany({
        name: data.name!, contactEmail: data.contactEmail!, isActive: true
      });
    }
    this.resetForm();
  }

  async toggleStatus(company: Company) {
    if (confirm(`Confirmer l'action sur ${company.name} ?`)) {
      await this.companyService.toggleStatus(company.uid!, !company.isActive);
    }
  }
}



==============================================================================
FICHIER : src/app/features/admin/live-map/live-map.component.ts
==============================================================================
import { Component, inject, AfterViewInit, OnDestroy, signal, effect, NgZone } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule, FormBuilder } from '@angular/forms';
import { Router } from '@angular/router';
import * as L from 'leaflet';
import { TripService, Trip } from '../../../core/services/trip.service';
import { CarService, Car } from '../../../core/services/car.service';
import { UserService } from '../../../core/services/user.service';
import { CompanyService } from '../../../core/services/company.service';
import { ChatService } from '../../../core/services/chat.service';
import { UserProfile } from '../../../core/auth/auth.service';
import { combineLatest, startWith, map } from 'rxjs';
import { toSignal } from '@angular/core/rxjs-interop';

// Configuration Ic√¥nes Leaflet
const iconRetinaUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png';
const iconUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png';
const shadowUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png';
const iconDefault = L.icon({
  iconRetinaUrl, iconUrl, shadowUrl,
  iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], tooltipAnchor: [16, -28], shadowSize: [41, 41]
});
L.Marker.prototype.options.icon = iconDefault;

@Component({
  selector: 'app-live-map',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="flex flex-col h-full w-full relative overflow-hidden">
      <div class="absolute top-4 left-4 right-14 md:right-auto md:w-96 bg-white p-4 rounded-xl shadow-lg z-[1000] border border-gray-200 flex flex-col gap-3">
        <div class="flex justify-between items-center">
           <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><span class="text-xl">üåç</span> Flotte Live</h2>
           <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800 animate-pulse">{{ filteredCount() }} / {{ totalCount() }} Actifs</span>
        </div>
        <form [formGroup]="filterForm" class="flex flex-col gap-2">
           <div class="flex items-center gap-2 mb-1">
               <input type="checkbox" formControlName="inProgressOnly" id="mapInProgress" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
               <label for="mapInProgress" class="text-sm text-gray-700 font-medium">Uniquement "En cours"</label>
           </div>
           <div>
              <select formControlName="company" class="w-full text-sm border-gray-300 rounded-md bg-gray-50 p-2">
                 <option value="">Toutes les soci√©t√©s</option>
                 @for (company of activeCompanies(); track company.uid) { <option [value]="company.name">{{ company.name }}</option> }
              </select>
           </div>
           <div><input formControlName="search" type="text" placeholder="Rechercher..." class="w-full text-sm border-gray-300 rounded-md bg-gray-50 p-2"></div>
        </form>
      </div>
      <div id="map" class="flex-1 w-full h-full z-0 bg-gray-100"></div>
    </div>
  `,
  styles: [`:host { display: block; height: 100%; width: 100%; } #map { height: 100%; width: 100%; }`]
})
export class LiveMapComponent implements AfterViewInit, OnDestroy {
  private tripService = inject(TripService);
  private carService = inject(CarService);
  private userService = inject(UserService);
  private companyService = inject(CompanyService);
  private chatService = inject(ChatService);
  private router = inject(Router);
  private ngZone = inject(NgZone);
  private fb = inject(FormBuilder);
  
  private map: L.Map | undefined;
  private markers: L.LayerGroup = L.layerGroup();
  private readonly TUNISIA_BOUNDS = L.latLngBounds([30.2, 7.5], [37.6, 11.6]);

  activeCompanies = this.companyService.activeCompanies;
  filterForm = this.fb.group({ company: [''], inProgressOnly: [true], search: [''] });

  private combinedData$ = combineLatest([
    this.tripService.getTrips(),
    this.carService.getCars(),
    this.userService.getAllUsers(),
    this.filterForm.valueChanges.pipe(startWith(this.filterForm.value))
  ]).pipe(
    map(([trips, cars, users, filters]: [Trip[], Car[], UserProfile[], any]) => {
      const activeTrips = trips.filter((t: Trip) => t.status === 'IN_PROGRESS' && t.currentLocation);
      const enrichedTrips = activeTrips.map((trip: Trip) => {
        const car = cars.find((c: Car) => c.uid === trip.carId);
        const driver = users.find((u: UserProfile) => u.uid === car?.assignedDriverId);
        return { trip, car, driver };
      });
      const searchTerm = (filters?.search || '').toLowerCase();
      return enrichedTrips.filter((item: any) => {
         const matchCompany = !filters?.company || item.driver?.company === filters.company || item.trip.company === filters.company;
         const matchSearch = !searchTerm || item.car?.plate?.toLowerCase().includes(searchTerm) || item.trip.currentLocation?.city.toLowerCase().includes(searchTerm);
         return matchCompany && (filters?.inProgressOnly ? item.trip.status === 'IN_PROGRESS' : true);
      });
    })
  );

  liveData = toSignal(this.combinedData$, { initialValue: [] });
  filteredCount = signal(0);
  totalCount = signal(0);

  constructor() {
    effect(() => {
      const data = this.liveData();
      this.filteredCount.set(data.length);
      setTimeout(() => this.updateMarkers(data), 200);
    });
    this.tripService.getTrips().subscribe(trips => this.totalCount.set(trips.filter(t => t.status === 'IN_PROGRESS').length));
  }

  ngAfterViewInit(): void { setTimeout(() => this.initMap(), 100); }
  ngOnDestroy(): void { if (this.map) this.map.remove(); }

  private initMap(): void {
    if (this.map) return;
    this.map = L.map('map', { zoomControl: false, attributionControl: false });
    this.map.fitBounds(this.TUNISIA_BOUNDS);
    L.control.zoom({ position: 'bottomright' }).addTo(this.map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(this.map);
    this.markers.addTo(this.map);
    setTimeout(() => { this.map?.invalidateSize(); this.map?.fitBounds(this.TUNISIA_BOUNDS); }, 300);
  }

  private updateMarkers(data: any[]): void {
    if (!this.map) return;
    this.markers.clearLayers();
    
    data.forEach(item => {
      const { trip, car, driver } = item;
      if (trip.currentLocation) {
        
        // 1. ID UNIQUE POUR LE BOUTON (Essentiel pour le cibler apr√®s le rendu)
        const chatBtnId = `chat-btn-${driver?.uid}`;
        
        // 2. TEMPLATE HTML (Avec le bouton inject√©)
        const popupContent = `
          <div class="font-sans p-1 min-w-[220px]">
            <div class="flex items-center justify-between border-b border-gray-100 pb-2 mb-2">
                <div class="font-bold text-indigo-700 text-sm">${car?.model || 'V√©hicule'}</div>
                <div class="text-xs bg-gray-100 px-1 rounded font-mono">${car?.plate}</div>
            </div>
            <div class="text-xs text-gray-600 space-y-1">
               <div class="flex items-center gap-2"><span>üè¢</span> <strong>${driver?.company || 'N/A'}</strong></div>
               <div class="flex items-center gap-2"><span>üß¢</span> ${driver?.email?.split('@')[0]}</div>
               <div class="flex items-center gap-2 text-indigo-600 font-bold"><span>üìû</span> ${driver?.phoneNumber || 'N/A'}</div>
               <div class="flex items-center gap-2 text-gray-400 mt-2"><span>üìç</span> ${trip.currentLocation.city}</div>
            </div>
            
            <div class="mt-3 pt-2 border-t border-gray-100 flex gap-2">
               <button id="${chatBtnId}" class="flex-1 bg-indigo-50 text-indigo-700 py-1.5 rounded text-xs font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-1 border border-indigo-200 cursor-pointer">
                  <span>üí¨</span> Chat
               </button>
               
               <a href="https://www.google.com/maps/dir/?api=1&origin=$?q=${encodeURIComponent(trip.departure)}&destination=${encodeURIComponent(trip.destination)}&waypoints=${trip.currentLocation.lat},${trip.currentLocation.lng}&travelmode=driving" 
                  target="_blank" 
                  class="flex-1 bg-blue-600 text-white py-1.5 rounded text-xs font-bold hover:bg-blue-700 text-center no-underline block">
                  üìç Suivre
               </a>
            </div>
          </div>
        `;

        const marker = L.marker([trip.currentLocation.lat, trip.currentLocation.lng])
          .bindPopup(popupContent);

        // 3. LOGIQUE D'ATTACHEMENT DU CLICK (Quand le popup s'ouvre)
        marker.on('popupopen', () => {
           if (driver) {
              setTimeout(() => { // Petit d√©lai de s√©curit√© pour le DOM
                  const btn = document.getElementById(chatBtnId);
                  if (btn) {
                     btn.onclick = (e) => {
                        e.preventDefault(); // Emp√™cher comportement par d√©faut
                        // IMPORTANT: Revenir dans la Zone Angular pour la navigation
                        this.ngZone.run(() => {
                            this.openChat(driver);
                        });
                     };
                  }
              }, 50);
           }
        });

        marker.addTo(this.markers);
      }
    });

    if (data.length > 0) {
       const group = L.featureGroup(this.markers.getLayers() as L.Marker[]);
       this.map.fitBounds(group.getBounds().pad(0.1));
    }
  }

  openChat(driver: UserProfile) {
     this.chatService.startChatWith(driver);
     this.router.navigate(['/admin/chat']);
  }
}



==============================================================================
FICHIER : src/app/app.component.ts
==============================================================================
import { Component } from '@angular/core';
import { RouterOutlet } from '@angular/router';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [RouterOutlet],
  templateUrl: './app.component.html',
  styleUrl: './app.component.scss'
})
export class AppComponent {
  title = 'master-delivery';
}



==============================================================================
FICHIER : src/app/app.config.ts
==============================================================================
import { ApplicationConfig, provideZoneChangeDetection } from '@angular/core';
import { provideRouter } from '@angular/router';
import { routes } from './app.routes';
import { initializeApp, provideFirebaseApp } from '@angular/fire/app';
import { getAuth, provideAuth } from '@angular/fire/auth';
import { getFirestore, provideFirestore } from '@angular/fire/firestore';
import { getDatabase, provideDatabase } from '@angular/fire/database'; // AJOUT√â
import { environment } from '../environments/environment';

export const appConfig: ApplicationConfig = {
  providers: [
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideRouter(routes),
    provideFirebaseApp(() => initializeApp(environment.firebase)),
    provideAuth(() => getAuth()),
    provideFirestore(() => getFirestore()),
    provideDatabase(() => getDatabase()) // AJOUT√â
  ]
};



==============================================================================
FICHIER : src/app/app.html
==============================================================================
<router-outlet />



==============================================================================
FICHIER : src/app/app.scss
==============================================================================



==============================================================================
FICHIER : src/main.ts
==============================================================================
import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { App } from './app/app';

bootstrapApplication(App, appConfig)
  .catch((err) => console.error(err));



==============================================================================
FICHIER : src/environments/environment.ts
==============================================================================
export const environment = {
  production: false,
  // ‚ö†Ô∏è IMPORTANT : Remplacez cette configuration par la v√¥tre !
  // Le projet 'demo-project' ci-dessous est en lecture seule et bloquera l'inscription (Erreur 400).
  // Cr√©ez un projet sur https://console.firebase.google.com/
  firebase: {
    apiKey: "AIzaSyDJm6gOw0CSNlbWXP2BAX3etHZPBn9ARZY",
    authDomain: "masterdeliverpackage.firebaseapp.com",
    databaseURL: "https://masterdeliverpackage-default-rtdb.firebaseio.com",
    projectId: "masterdeliverpackage",
    storageBucket: "masterdeliverpackage.firebasestorage.app",
    messagingSenderId: "406875058530",
    appId: "1:406875058530:web:e872e7a5eea2ccc870fc3b",
    measurementId: "G-X9MGMQ3BVG"
  }
};



==============================================================================
FICHIER : src/styles.scss
==============================================================================
@import 'leaflet/dist/leaflet.css';
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Custom Global Styles */
body {
  @apply bg-gray-50 text-gray-900;
}



