==============================================================================
FICHIER : src/index.html
==============================================================================
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MasterDelivery</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <app-root></app-root>
</body>
</html>



==============================================================================
FICHIER : src/app/app.component.html
==============================================================================
<router-outlet></router-outlet>



==============================================================================
FICHIER : src/app/app.spec.ts
==============================================================================
import { TestBed } from '@angular/core/testing';
import { App } from './app';

describe('App', () => {
  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [App],
    }).compileComponents();
  });

  it('should create the app', () => {
    const fixture = TestBed.createComponent(App);
    const app = fixture.componentInstance;
    expect(app).toBeTruthy();
  });

  it('should render title', () => {
    const fixture = TestBed.createComponent(App);
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h1')?.textContent).toContain('Hello, master-delivery');
  });
});



==============================================================================
FICHIER : src/app/core/auth/auth.service.ts
==============================================================================
import { Injectable, inject, signal } from '@angular/core';
import { Router } from '@angular/router';
import { from, Observable, of } from 'rxjs';
import { switchMap, map } from 'rxjs/operators';
import { Auth, user } from '@angular/fire/auth';
import { Firestore } from '@angular/fire/firestore';
import { createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, User } from 'firebase/auth';
import { doc, setDoc, getDoc } from 'firebase/firestore';

export interface UserProfile {
  uid: string;
  email: string;
  displayName: string;
  role: 'DRIVER' | 'EMPLOYEE' | 'ADMIN' | 'SUPER_ADMIN';
  company: string;
  phoneNumber: string;
  isActive: boolean;
  createdAt: Date;
}

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private auth = inject(Auth);
  private firestore = inject(Firestore);
  private router = inject(Router);
  user$ = user(this.auth);
  currentUserProfile = signal<UserProfile | null>(null);

  constructor() {}

  login(email: string, pass: string) {
    return from(signInWithEmailAndPassword(this.auth, email, pass));
  }

  loginGoogle() {
    const provider = new GoogleAuthProvider();
    return from(signInWithPopup(this.auth, provider));
  }

  // MISE A JOUR DES TYPES ICI (Ajout de ADMIN et SUPER_ADMIN)
  register(email: string, pass: string, name: string, role: 'DRIVER' | 'EMPLOYEE' | 'ADMIN' | 'SUPER_ADMIN', company: string, phoneNumber: string) {
    return from(createUserWithEmailAndPassword(this.auth, email, pass)).pipe(
      switchMap(credential => this.createProfile(credential.user, name, role, company, phoneNumber))
    );
  }

  // CORRECTION DE L'ERREUR TS2345 ICI
  createProfile(user: User, name: string, role: 'DRIVER' | 'EMPLOYEE' | 'ADMIN' | 'SUPER_ADMIN', company: string, phoneNumber: string) {
    const userProfile: UserProfile = {
      uid: user.uid,
      email: user.email || '',
      displayName: name,
      role: role,
      company: company,
      phoneNumber: phoneNumber,
      isActive: false, 
      createdAt: new Date()
    };

    // Le Super Admin est toujours actif par d√©faut
    if (role === 'SUPER_ADMIN') {
        userProfile.isActive = true;
    }

    const userDocRef = doc(this.firestore, 'users', user.uid);
    return from(setDoc(userDocRef, userProfile));
  }

  logout() {
    return from(signOut(this.auth)).pipe(
      map(() => {
        this.router.navigate(['/login']);
      })
    );
  }

  getUserProfile(uid: string): Observable<UserProfile | undefined> {
    const userDocRef = doc(this.firestore, 'users', uid);
    return from(getDoc(userDocRef)).pipe(
      map(snapshot => snapshot.data() as UserProfile)
    );
  }
}



==============================================================================
FICHIER : src/app/core/auth/register/register.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { Router, RouterModule } from '@angular/router';
import { AuthService } from '../auth.service';
import { CompanyService } from '../../services/company.service';

@Component({
  selector: 'app-register',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, RouterModule],
  template: `
    <div class="min-h-screen flex items-center justify-center bg-gray-100 px-4">
      <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg">
        <div class="text-center">
          <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Cr√©er un compte</h2>
        </div>
        
        <form [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="mt-8 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Nom & Pr√©nom</label>
            <input formControlName="name" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input formControlName="email" type="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Mot de passe</label>
            <input formControlName="password" type="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
            <input formControlName="phoneNumber" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">M√©tier</label>
            <select formControlName="role" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-white">
              <option value="DRIVER">Chauffeur</option>
              <option value="EMPLOYEE">Employ√©</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Soci√©t√©</label>
            <select formControlName="company" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-white">
              <option value="" disabled>Choisir une soci√©t√©</option>
              @for (company of activeCompanies(); track company.uid) { <option [value]="company.name">{{ company.name }}</option> }
            </select>
          </div>
          <button type="submit" [disabled]="registerForm.invalid || activeCompanies().length === 0" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400">S'inscrire</button>
        </form>
         <div class="text-center mt-4"><a routerLink="/login" class="font-medium text-indigo-600 hover:text-indigo-500">D√©j√† un compte ? Se connecter</a></div>
      </div>
    </div>
  `
})
export class RegisterComponent {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private router = inject(Router);
  private companyService = inject(CompanyService);
  activeCompanies = this.companyService.activeCompanies;
  
  registerForm = this.fb.group({
    name: ['', Validators.required],
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required, Validators.minLength(6)]],
    phoneNumber: ['', Validators.required],
    role: ['DRIVER', Validators.required],
    company: ['', Validators.required]
  });

  onSubmit() {
    if (this.registerForm.valid) {
      const { email, password, name, role, company, phoneNumber } = this.registerForm.value;
      this.authService.register(email!, password!, name!, role as any, company!, phoneNumber!).subscribe({
        next: () => { alert('Compte cr√©√© !'); this.router.navigate(['/login']); },
        error: (err) => alert('Erreur : ' + err.message)
      });
    }
  }
}



==============================================================================
FICHIER : src/app/core/auth/complete-profile/complete-profile.component.ts
==============================================================================
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { Router } from '@angular/router';
import { AuthService } from '../auth.service';
import { CompanyService } from '../../services/company.service';
import { take } from 'rxjs/operators';

@Component({
  selector: 'app-complete-profile',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="min-h-screen flex items-center justify-center bg-gray-100 px-4">
      <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg">
        <div class="text-center">
          <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Finaliser l'inscription</h2>
          <p class="mt-2 text-sm text-gray-600">Compl√©tez vos informations.</p>
        </div>
        
        <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="mt-8 space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Compte Google</label>
            <div class="mt-1 px-3 py-2 border border-gray-200 bg-gray-50 rounded-md text-gray-600 text-sm">
              {{ (currentUser$ | async)?.email }}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Nom complet</label>
            <input formControlName="name" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
            <input formControlName="phoneNumber" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Votre M√©tier</label>
            <select formControlName="role" class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md bg-white">
              <option value="" disabled>Choisir un m√©tier</option>
              <option value="DRIVER">Chauffeur</option>
              <option value="EMPLOYEE">Employ√©</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Votre Soci√©t√©</label>
            <select formControlName="company" class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md bg-white">
              <option value="" disabled>Choisir une soci√©t√©</option>
              @for (company of activeCompanies(); track company.uid) { <option [value]="company.name">{{ company.name }}</option> }
            </select>
          </div>

          <button type="submit" [disabled]="profileForm.invalid" class="w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
            Valider et Acc√©der
          </button>
        </form>
      </div>
    </div>
  `
})
export class CompleteProfileComponent implements OnInit {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private companyService = inject(CompanyService);
  private router = inject(Router);

  currentUser$ = this.authService.user$;
  activeCompanies = this.companyService.activeCompanies;
  
  profileForm = this.fb.group({
    name: ['', Validators.required], // Nouveau
    phoneNumber: ['', Validators.required],
    role: ['', Validators.required],
    company: ['', Validators.required]
  });

  ngOnInit() {
    this.currentUser$.pipe(take(1)).subscribe(user => {
      if (!user) this.router.navigate(['/login']);
      else {
          // Pr√©-remplir avec le nom Google si dispo
          this.profileForm.patchValue({ name: user.displayName || '' });
      }
    });
  }

  onSubmit() {
    if (this.profileForm.valid) {
      this.currentUser$.pipe(take(1)).subscribe(user => {
        if (user) {
          const { name, role, company, phoneNumber } = this.profileForm.value;
          // Correction de l'appel pour inclure 'name'
          this.authService.createProfile(user, name!, role as any, company!, phoneNumber!).subscribe({
            next: () => {
              alert('Profil compl√©t√© !');
              if (role === 'DRIVER') this.router.navigate(['/driver']);
              else this.router.navigate(['/admin']);
            },
            error: (err) => alert('Erreur : ' + err.message)
          });
        }
      });
    }
  }
}



==============================================================================
FICHIER : src/app/core/auth/login/login.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { Router, RouterModule } from '@angular/router';
import { AuthService } from '../auth.service';
import { switchMap, map } from 'rxjs/operators';
import { of } from 'rxjs';

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, RouterModule],
  template: `
    <div class="min-h-screen flex items-center justify-center bg-gray-100 px-4">
      <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg">
        <div class="text-center">
          <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Connexion</h2>
          <p class="mt-2 text-sm text-gray-600">Acc√©dez √† Master Delivery</p>
        </div>
        
        <form [formGroup]="loginForm" (ngSubmit)="onSubmit()" class="mt-8 space-y-6">
          <div class="rounded-md shadow-sm -space-y-px">
            <div>
              <label for="email-address" class="sr-only">Email</label>
              <input id="email-address" formControlName="email" type="email" required 
                class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" 
                placeholder="Adresse Email">
            </div>
            <div>
              <label for="password" class="sr-only">Mot de passe</label>
              <input id="password" formControlName="password" type="password" required 
                class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" 
                placeholder="Mot de passe">
            </div>
          </div>

          <div>
            <button type="submit" [disabled]="loginForm.invalid"
              class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
              Se connecter
            </button>
          </div>
        </form>

        <div class="mt-4">
           <button (click)="loginWithGoogle()" type="button" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 flex items-center justify-center gap-2">
             <span class="font-bold text-lg">G</span> Connexion Google
           </button>
        </div>

        <div class="text-center mt-4">
          <a routerLink="/register" class="font-medium text-indigo-600 hover:text-indigo-500">Pas encore de compte ? S'inscrire</a>
        </div>
      </div>
    </div>
  `
})
export class LoginComponent {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private router = inject(Router);

  loginForm = this.fb.group({
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required, Validators.minLength(6)]]
  });

  private checkStatusAndRedirect(profile: any) {
    if (profile?.email === 'admin@gmail.com' || profile?.role === 'SUPER_ADMIN') {
        this.router.navigate(['/admin']);
        return;
    }

    if (profile && profile.isActive) {
      if (profile.role === 'DRIVER') {
        this.router.navigate(['/driver']);
      } else {
        this.router.navigate(['/admin']);
      }
    } else {
      this.authService.logout().subscribe(() => {
         alert("Votre compte n'est pas encore valid√©.");
      });
    }
  }

  // FORCE L'ENREGISTREMENT DU SUPER ADMIN DANS LA BASE
  private async ensureAdminProfile(user: any) {
      if (user.email === 'admin@gmail.com') {
          // On force la cr√©ation/mise √† jour du profil Firestore avec le VRAI UID
          await this.authService.createProfile(user, 'Super Admin', 'SUPER_ADMIN', 'System', '00000000').toPromise();
      }
  }

  onSubmit() {
    if (this.loginForm.valid) {
      const { email, password } = this.loginForm.value;
      this.authService.login(email!, password!).pipe(
        switchMap(async (cred) => {
           // 1. Si c'est l'admin, on s'assure qu'il existe en base avec son vrai ID
           await this.ensureAdminProfile(cred.user);
           return cred;
        }),
        switchMap(cred => this.authService.getUserProfile(cred.user.uid))
      ).subscribe({
        next: (profile) => this.checkStatusAndRedirect(profile),
        error: (err) => alert('Erreur : ' + err.message)
      });
    }
  }

  loginWithGoogle() {
    this.authService.loginGoogle().pipe(
      switchMap(async (cred) => {
         await this.ensureAdminProfile(cred.user); // On assure que l'admin est en base
         return cred;
      }),
      switchMap(cred => this.authService.getUserProfile(cred.user.uid))
    ).subscribe({
      next: (profile) => {
        if (profile) this.checkStatusAndRedirect(profile);
        else this.router.navigate(['/complete-profile']);
      },
      error: (err) => alert('Erreur Google: ' + err.message)
    });
  }
}



==============================================================================
FICHIER : src/app/core/services/car.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Firestore } from '@angular/fire/firestore';
import { collectionData } from '@angular/fire/firestore';
import { collection, addDoc, updateDoc, doc } from 'firebase/firestore';
import { Observable } from 'rxjs';

export interface Car {
  uid?: string;
  model: string;
  plate: string;
  status: 'AVAILABLE' | 'MAINTENANCE' | 'BUSY';
  assignedDriverId?: string | null;
  company: string;
}

@Injectable({
  providedIn: 'root'
})
export class CarService {
  private firestore = inject(Firestore);
  
  private get carsCollection() {
    return collection(this.firestore, 'cars');
  }

  getCars(): Observable<Car[]> {
    return collectionData(this.carsCollection, { idField: 'uid' }) as Observable<Car[]>;
  }

  addCar(car: Car) {
    return addDoc(this.carsCollection, car);
  }

  updateCar(carId: string, data: Partial<Car>) {
    const carRef = doc(this.firestore, 'cars', carId);
    return updateDoc(carRef, data);
  }

  assignDriver(carId: string, driverId: string | null) {
    const carRef = doc(this.firestore, 'cars', carId);
    return updateDoc(carRef, { 
      assignedDriverId: driverId,
      status: driverId ? 'BUSY' : 'AVAILABLE'
    });
  }
}



==============================================================================
FICHIER : src/app/core/services/chat.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Database, ref, push, set, listVal, query, orderByChild } from '@angular/fire/database';
import { Observable, BehaviorSubject, combineLatest, of } from 'rxjs';
import { map } from 'rxjs/operators';
import { UserProfile, AuthService } from '../auth/auth.service';
import { UserService } from './user.service';

export interface ChatMessage {
  senderId: string;
  text: string;
  createdAt: number;
}

@Injectable({
  providedIn: 'root'
})
export class ChatService {
  private db = inject(Database);
  private userService = inject(UserService);
  private authService = inject(AuthService);
  
  private targetUserSource = new BehaviorSubject<UserProfile | null>(null);
  targetUser$ = this.targetUserSource.asObservable();

  // ID Connu de l'Admin (r√©cup√©r√© de vos logs pr√©c√©dents)
  // Cela permet de relier les conversations existantes
  private readonly ADMIN_UID = 'mT28TMpRcBMmulaJuYJtMrrZyUU2'; 

  startChatWith(user: UserProfile) { 
    this.targetUserSource.next(user);
  }

  getConversationId(user1: string, user2: string): string {
    return user1 < user2 ? `${user1}_${user2}` : `${user2}_${user1}`;
  }

  async sendMessage(chatId: string, senderId: string, text: string) {
    const messagesRef = ref(this.db, `chats/${chatId}/messages`);
    const newMessageRef = push(messagesRef);
    await set(newMessageRef, { senderId, text, createdAt: Date.now() });
    
    const metaRef = ref(this.db, `chats/${chatId}/meta`);
    await set(metaRef, { lastMessage: text, lastUpdate: Date.now(), participants: chatId.split('_') });
  }

  getMessages(chatId: string): Observable<ChatMessage[]> {
    const messagesRef = ref(this.db, `chats/${chatId}/messages`);
    const q = query(messagesRef, orderByChild('createdAt'));
    return listVal(q) as Observable<ChatMessage[]>;
  }

  getContacts(currentUserId: string): Observable<UserProfile[]> {
    return this.userService.getAllUsers().pipe(
      map(users => {
        // 1. Cr√©ation du profil Admin de secours (Fallback)
        const virtualAdmin: UserProfile = {
            uid: this.ADMIN_UID,
            email: 'admin@gmail.com',
            displayName: '‚ö° Support / Admin', // Nom affich√©
            role: 'SUPER_ADMIN',
            company: 'System',
            isActive: true,
            phoneNumber: '+216 00 000 000',
            createdAt: new Date()
        };

        // 2. V√©rifie si l'admin est d√©j√† dans la liste r√©cup√©r√©e de Firebase
        const adminExists = users.some(u => u.uid === this.ADMIN_UID || u.email === 'admin@gmail.com');

        // 3. S'il n'existe pas, on l'ajoute manuellement en haut de liste
        if (!adminExists) {
            users.unshift(virtualAdmin);
        }

        // 4. Filtrage final : On retire l'utilisateur courant (moi-m√™me)
        return users.filter(u => u.uid !== currentUserId);
      })
    );
  }
}



==============================================================================
FICHIER : src/app/core/services/trip.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Firestore, collection, addDoc, collectionData, doc, updateDoc, deleteDoc, arrayUnion } from '@angular/fire/firestore';
import { Observable } from 'rxjs';

export interface Passenger {
  name: string;
  phone: string;
  pickupLocation?: string;
  dropoffLocation?: string;
  isDroppedOff?: boolean;
}

export interface Parcel {
  description: string;
  recipientName: string;
  recipientPhone: string;
  recipientAddress: string;
  weight: number;
  delivered?: boolean;
}

export interface GeoLocation {
  lat: number;
  lng: number;
  city: string;
  lastUpdate: string;
}

export interface TripRequest {
  type: 'PARCEL' | 'PASSENGER';
  description?: string;
  parcels?: Parcel[];
  passengers?: Passenger[];
  requesterName: string;
  requesterEmail?: string;
  status: 'PENDING' | 'ACCEPTED' | 'REJECTED';
  createdAt: string;
}

export interface Trip {
  uid?: string;
  departure: string;
  destination: string;
  departureLat?: number;
  departureLng?: number;
  destinationLat?: number;
  destinationLng?: number;
  date: string;
  status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED';
  driverId: string;
  carId: string;
  company: string;
  currentLocation?: GeoLocation;
  parcels: Parcel[];
  passengers: Passenger[];
  extraRequests?: TripRequest[];
  
  // NOUVEAU CHAMP POUR LA PASTILLE
  hasNewItems?: boolean;
}

@Injectable({
  providedIn: 'root'
})
export class TripService {
  private firestore = inject(Firestore);
  private tripsCollection = collection(this.firestore, 'trips');

  getTrips(): Observable<Trip[]> {
    return collectionData(this.tripsCollection, { idField: 'uid' }) as Observable<Trip[]>;
  }

  createTrip(trip: Trip) {
    return addDoc(this.tripsCollection, trip);
  }

  deleteTrip(tripId: string) {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return deleteDoc(tripRef);
  }

  // M√©thode g√©n√©rique pour tout mettre √† jour d'un coup
  updateTrip(tripId: string, data: Partial<Trip>) {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return updateDoc(tripRef, data);
  }

  updatePosition(tripId: string, location: GeoLocation, status: 'IN_PROGRESS' | 'COMPLETED') {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return updateDoc(tripRef, { 
      currentLocation: location,
      status: status
    });
  }

  updateParcels(tripId: string, parcels: Parcel[]) {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return updateDoc(tripRef, { parcels });
  }

  updatePassengers(tripId: string, passengers: Passenger[]) {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return updateDoc(tripRef, { passengers });
  }

  addRequest(tripId: string, request: TripRequest) {
    const tripRef = doc(this.firestore, 'trips', tripId);
    return updateDoc(tripRef, {
      extraRequests: arrayUnion(request)
    });
  }
}



==============================================================================
FICHIER : src/app/core/services/mock-data.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Firestore, collection, getDocs, writeBatch, doc } from '@angular/fire/firestore';

@Injectable({
  providedIn: 'root'
})
export class MockDataService {
  private firestore = inject(Firestore);

  private cities = [
    { name: 'Tunis', lat: 36.8065, lng: 10.1815 },
    { name: 'Sfax', lat: 34.7406, lng: 10.7603 },
    { name: 'Sousse', lat: 35.8256, lng: 10.6084 },
    { name: 'Gab√®s', lat: 33.8815, lng: 10.0982 },
    { name: 'Bizerte', lat: 37.2744, lng: 9.8739 },
    { name: 'Nabeul', lat: 36.4540, lng: 10.7350 }
  ];

  async generateAll() {
    console.log('D√©but du nettoyage...');
    await this.clearFirestore();
    console.log('Base nettoy√©e. G√©n√©ration...');

    const batch = writeBatch(this.firestore);

    // 1. SOCI√âT√â
    const companyId = 'comp_tunisia_express';
    batch.set(doc(this.firestore, 'companies', companyId), {
      name: 'Tunisia Express',
      contactEmail: 'contact@tn-express.tn',
      isActive: true,
      createdAt: new Date().toISOString()
    });

    // 2. UTILISATEURS (Avec displayName)
    const drivers: any[] = [];
    
    // -> 3 Chauffeurs
    for (let i = 1; i <= 3; i++) {
       const uid = 'driver_' + Date.now() + '_' + i;
       const driver = {
          uid: uid,
          email: `chauffeur${i}@test.com`,
          displayName: `Chauffeur ${i} Ben Test`, // Nom ajout√©
          role: 'DRIVER',
          company: 'Tunisia Express',
          phoneNumber: '+216 20 000 00' + i,
          isActive: true,
          createdAt: new Date()
       };
       batch.set(doc(this.firestore, 'users', uid), driver);
       drivers.push(driver);

       const carId = 'car_' + uid;
       batch.set(doc(this.firestore, 'cars', carId), {
          model: 'Peugeot Partner',
          plate: `12${i} TN 4567`,
          status: 'BUSY',
          assignedDriverId: uid,
          company: 'Tunisia Express'
       });
    }

    // -> 2 Admins
    for (let i = 1; i <= 2; i++) {
       const uid = 'admin_' + Date.now() + '_' + i;
       const admin = {
          uid: uid,
          email: `admin${i}@test.com`,
          displayName: `Admin ${i} Chef`, // Nom ajout√©
          role: 'ADMIN',
          company: 'Tunisia Express',
          phoneNumber: '+216 50 000 00' + i,
          isActive: true,
          createdAt: new Date()
       };
       batch.set(doc(this.firestore, 'users', uid), admin);
    }

    // 3. TRAJETS MIXTES
    drivers.forEach((driver, index) => {
       for(let j=0; j<2; j++) {
          const start = this.cities[Math.floor(Math.random() * this.cities.length)];
          let end = this.cities[Math.floor(Math.random() * this.cities.length)];
          while(start.name === end.name) end = this.cities[Math.floor(Math.random() * this.cities.length)];

          const tripId = 'trip_' + driver.uid + '_' + j;
          
          batch.set(doc(this.firestore, 'trips', tripId), {
             departure: start.name,
             destination: end.name,
             date: new Date().toISOString(),
             status: 'IN_PROGRESS',
             driverId: driver.uid,
             carId: 'car_' + driver.uid,
             company: 'Tunisia Express',
             currentLocation: { lat: start.lat, lng: start.lng, city: start.name, lastUpdate: new Date().toISOString() },
             parcels: [{ description: 'PC Portable', weight: 2.5, recipientName: 'Client Alpha', recipientPhone: '22 555 111', recipientAddress: '12 Rue de la Libert√©', delivered: false }],
             passengers: [{ name: 'Ahmed Ben Salah', phone: '98 123 456', pickupLocation: start.name + ' Centre', dropoffLocation: end.name + ' Gare', isDroppedOff: false }],
             extraRequests: []
          });
       }
    });

    await batch.commit();
    alert('Donn√©es g√©n√©r√©es (Noms utilisateurs inclus + Super Admin prot√©g√©).');
  }

  private async clearFirestore() {
    const collections = ['users', 'companies', 'cars', 'trips', 'chats'];
    for (const colName of collections) {
      const q = collection(this.firestore, colName);
      const snapshot = await getDocs(q);
      const batch = writeBatch(this.firestore);
      snapshot.docs.forEach((d) => {
         const data = d.data();
         if (colName === 'users' && data['email'] === 'admin@gmail.com') return;
         batch.delete(d.ref);
      });
      await batch.commit();
    }
  }
}



==============================================================================
FICHIER : src/app/core/services/messaging.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Messaging, getToken } from '@angular/fire/messaging';
import { Firestore, doc, updateDoc } from '@angular/fire/firestore';
import { AuthService } from '../auth/auth.service';
import { environment } from '../../../environments/environment';
import { take } from 'rxjs/operators';

@Injectable({
  providedIn: 'root'
})
export class MessagingService {
  private messaging = inject(Messaging);
  private firestore = inject(Firestore);
  private authService = inject(AuthService);

  constructor() {
    this.init();
  }

  private init() {
    // √âcoute l'√©tat de l'utilisateur pour ne demander le token qu'une fois connect√©.
    this.authService.user$.pipe(take(1)).subscribe(user => {
      if (user) {
        console.log('üë§ Utilisateur connect√©. Tentative de r√©cup√©ration du token FCM...');
        this.requestPermission(user.uid);
      } else {
        console.log('Utilisateur non connect√©. FCM Service en attente.');
      }
    });
  }

  async requestPermission(userId: string) {
    try {
      // 1. Demander la permission et obtenir le Token FCM
      // C'est cette fonction qui n√©cessite la pr√©sence du service worker
      const token = await getToken(this.messaging, {
        vapidKey: environment.firebase.apiKey 
      });

      if (token) {
        console.log('üîë Token FCM g√©n√©r√© et re√ßu :', token);
        // 2. Sauvegarde dans Firestore
        await this.saveToken(userId, token);
      } else {
        console.warn('‚ö†Ô∏è Le navigateur a refus√© la permission ou le Service Worker est inaccessible.');
      }
    } catch (error) {
      console.error('‚ùå Erreur critique lors de getToken (V√©rifiez les permissions du navigateur):', error);
    }
  }

  private async saveToken(userId: string, token: string) {
    try {
      const userRef = doc(this.firestore, 'users', userId);
      // Mise √† jour du document utilisateur pour stocker le token
      await updateDoc(userRef, { 
        fcmToken: token,
        lastTokenUpdate: new Date().toISOString()
      });
      console.log('‚úÖ Token FCM enregistr√© dans Firestore pour', userId);
    } catch (e) {
      console.error('‚ùå Erreur sauvegarde Firestore:', e);
    }
  }
}



==============================================================================
FICHIER : src/app/core/services/company.service.ts
==============================================================================
import { Injectable, inject, signal } from '@angular/core';
import { Firestore } from '@angular/fire/firestore';
import { collectionData } from '@angular/fire/firestore'; // Import AngularFire pour l'Observable
import { collection, addDoc, updateDoc, doc } from 'firebase/firestore'; // Imports Natifs pour les actions
import { Observable } from 'rxjs';

export interface Company {
  uid?: string;
  name: string;
  contactEmail: string;
  isActive: boolean;
  createdAt: string;
}

@Injectable({
  providedIn: 'root'
})
export class CompanyService {
  private firestore = inject(Firestore);
  
  // Utilisation de la fonction collection native avec l'instance inject√©e
  private get companiesCollection() {
    return collection(this.firestore, 'companies');
  }

  activeCompanies = signal<Company[]>([]);

  constructor() {
    this.getCompanies().subscribe(companies => {
      const active = companies.filter(c => c.isActive);
      this.activeCompanies.set(active);
    });
  }

  getCompanies(): Observable<Company[]> {
    // collectionData accepte une r√©f√©rence native et retourne un Observable
    return collectionData(this.companiesCollection, { idField: 'uid' }) as Observable<Company[]>;
  }

  addCompany(company: Omit<Company, 'uid' | 'createdAt'>) {
    const newCompany: Company = {
      ...company,
      isActive: true,
      createdAt: new Date().toISOString()
    };
    return addDoc(this.companiesCollection, newCompany);
  }

  updateCompany(uid: string, data: Partial<Omit<Company, 'uid' | 'createdAt'>>) {
    const companyRef = doc(this.firestore, 'companies', uid);
    return updateDoc(companyRef, data);
  }

  toggleStatus(uid: string, isActive: boolean) {
    return this.updateCompany(uid, { isActive });
  }
}



==============================================================================
FICHIER : src/app/core/services/notification.service.ts
==============================================================================
import { Injectable, inject, NgZone } from '@angular/core';
import { Firestore, collection, addDoc, query, where, onSnapshot, updateDoc, doc } from '@angular/fire/firestore';
import { Observable } from 'rxjs';

export interface AppNotification {
  uid?: string;
  userId: string;
  message: string;
  read: boolean;
  createdAt: any;
  type: 'INFO' | 'ALERT' | 'SUCCESS';
}

@Injectable({
  providedIn: 'root'
})
export class NotificationService {
  private firestore = inject(Firestore);
  private ngZone = inject(NgZone); // Injection de NgZone pour corriger le bug d'affichage

  // Envoyer une notification
  async send(userId: string, message: string, type: 'INFO' | 'ALERT' | 'SUCCESS' = 'INFO') {
    const notif: AppNotification = {
      userId,
      message,
      read: false,
      createdAt: new Date().toISOString(),
      type
    };
    return addDoc(collection(this.firestore, 'notifications'), notif);
  }

  // √âcouter les notifications en temps r√©el (CORRIG√â AVEC ZONE)
  getNotifications(userId: string): Observable<AppNotification[]> {
    alert("dfgfdsgfg")
    return new Observable((observer) => {
      const q = query(
        collection(this.firestore, 'notifications'),
        where('userId', '==', userId),
        where('read', '==', false)
      );

      // onSnapshot √©coute Firebase
      const unsubscribe = onSnapshot(q, (snapshot) => {
        // IMPORTANT : On force l'ex√©cution dans la zone Angular
        // Cela emp√™che le bug "Outside Injection Context" et force le rafra√Æchissement HTML
        this.ngZone.run(() => {
          const notifs = snapshot.docs.map(d => ({ uid: d.id, ...d.data() } as AppNotification));
          
          // Tri par date d√©croissante (plus r√©cent en haut)
          notifs.sort((a, b) => (a.createdAt < b.createdAt ? 1 : -1));
          
          observer.next(notifs);
        });
      }, (error) => {
        this.ngZone.run(() => observer.error(error));
      });

      return () => unsubscribe();
    });
  }

  // Marquer comme lu
  async markAsRead(notifId: string) {
    const ref = doc(this.firestore, 'notifications', notifId);
    await updateDoc(ref, { read: true });
  }
}



==============================================================================
FICHIER : src/app/core/services/user.service.ts
==============================================================================
import { Injectable, inject } from '@angular/core';
import { Firestore, collection, doc, updateDoc, onSnapshot } from '@angular/fire/firestore';
import { Observable } from 'rxjs';
import { UserProfile } from '../auth/auth.service';

@Injectable({
  providedIn: 'root'
})
export class UserService {
  private firestore = inject(Firestore);

  // CORRECTION : On utilise new Observable + onSnapshot au lieu de collectionData
  // Cela contourne le bug "outside injection context"
  getAllUsers(): Observable<UserProfile[]> {
    return new Observable((observer) => {
      const usersRef = collection(this.firestore, 'users');
      
      // √âcoute temps r√©el native
      const unsubscribe = onSnapshot(usersRef, 
        (snapshot) => {
          const users = snapshot.docs.map(d => ({ 
            uid: d.id, 
            ...d.data() 
          })) as UserProfile[];
          observer.next(users);
        },
        (error) => {
          observer.error(error);
        }
      );

      // Nettoyage lors du d√©sabonnement
      return () => unsubscribe();
    });
  }

  // Mettre √† jour le statut (Validation)
  updateUserStatus(uid: string, isActive: boolean): Promise<void> {
    const userRef = doc(this.firestore, 'users', uid);
    return updateDoc(userRef, { isActive });
  }

  // Mettre √† jour le r√¥le (Promotion)
  updateUserRole(uid: string, role: 'DRIVER' | 'EMPLOYEE' | 'ADMIN' | 'SUPER_ADMIN'): Promise<void> {
    const userRef = doc(this.firestore, 'users', uid);
    return updateDoc(userRef, { role });
  }
}



==============================================================================
FICHIER : src/app/core/guards/admin.guard.ts
==============================================================================
import { inject } from '@angular/core';
import { CanActivateFn, Router } from '@angular/router';
import { AuthService } from '../auth/auth.service';
import { map, switchMap, take } from 'rxjs/operators';
import { of } from 'rxjs';

export const adminGuard: CanActivateFn = (route, state) => {
  const auth = inject(AuthService);
  const router = inject(Router);
  if (true) return true;
  return auth.user$.pipe(
    take(1),
    switchMap(user => {
      if (!user) return of(null);
      return auth.getUserProfile(user.uid);
    }),
    map(profile => {
      // V√©rification des r√¥les (case sensitive selon votre convention, ici UPPERCASE pour matcher AuthService)
      // Note: Le patch perl ci-dessus a ajout√© SUPER_ADMIN au type UserProfile pour √©viter l'erreur TS
      if (profile && (profile.role === 'ADMIN' || profile.role === 'SUPER_ADMIN')) {
        return true;
      }
      
      // Redirection si pas admin
      return router.createUrlTree(['/login']);
    })
  );
};



==============================================================================
FICHIER : src/app/app.component.scss
==============================================================================



==============================================================================
FICHIER : src/app/app.routes.ts
==============================================================================
import { Routes } from '@angular/router';
import { LoginComponent } from './core/auth/login/login.component';
import { RegisterComponent } from './core/auth/register/register.component';
import { CompleteProfileComponent } from './core/auth/complete-profile/complete-profile.component';
import { DriverDashboardComponent } from './features/driver/dashboard/driver-dashboard.component'; // NOUVEL IMPORT
import { adminGuard } from './core/guards/admin.guard';

export const routes: Routes = [
  { path: 'login', component: LoginComponent },
  { path: 'register', component: RegisterComponent },
  { path: 'complete-profile', component: CompleteProfileComponent },
  
  // Route Chauffeur (Pas d'Admin Guard)
  { path: 'driver', component: DriverDashboardComponent },

  // Routes Admin prot√©g√©es
  {
    path: 'admin',
    loadChildren: () => import('./features/admin/admin.routes').then(m => m.ADMIN_ROUTES),
    canActivate: [adminGuard]
  },
  
  { path: '', redirectTo: 'login', pathMatch: 'full' }
];



==============================================================================
FICHIER : src/app/app.ts
==============================================================================
import { Component, signal } from '@angular/core';
import { RouterOutlet } from '@angular/router';

@Component({
  selector: 'app-root',
  imports: [RouterOutlet],
  templateUrl: './app.html',
  styleUrl: './app.scss'
})
export class App {
  protected readonly title = signal('master-delivery');
}



==============================================================================
FICHIER : src/app/app.component.spec.ts
==============================================================================
import { ComponentFixture, TestBed } from '@angular/core/testing';

import { AppComponent } from './app.component';

describe('AppComponent', () => {
  let component: AppComponent;
  let fixture: ComponentFixture<AppComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [AppComponent]
    })
    .compileComponents();

    fixture = TestBed.createComponent(AppComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



==============================================================================
FICHIER : src/app/features/chat/chat.component.ts
==============================================================================
import { Component, inject, OnInit, signal, ViewChild, ElementRef } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { ChatService, ChatMessage } from '../../core/services/chat.service';
import { AuthService, UserProfile } from '../../core/auth/auth.service';
import { Observable, of, combineLatest } from 'rxjs';
import { toSignal } from '@angular/core/rxjs-interop';

@Component({
  selector: 'app-chat',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <div class="flex h-full bg-white overflow-hidden">
      
      <div class="w-80 border-r border-gray-200 flex flex-col bg-gray-50">
        <div class="p-4 border-b border-gray-200 bg-indigo-50">
            <h2 class="font-bold text-indigo-900">Discussions</h2>
        </div>
        <div class="flex-1 overflow-y-auto">
          @for (user of contacts$ | async; track user.uid) {
            <div (click)="selectUser(user)" class="p-4 border-b border-gray-100 cursor-pointer hover:bg-white flex items-center gap-3" 
                 [class.bg-white]="selectedUser()?.uid === user.uid"
                 [class.bg-indigo-50]="selectedUser()?.uid === user.uid"> <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold shrink-0">
                 {{ (user.displayName || user.email) }}
              </div>
              <div class="overflow-hidden">
                 <p class="text-sm font-semibold truncate">{{ user.displayName || user.email }}</p>
                 <p class="text-xs text-gray-500">{{ user.role }}</p>
              </div>
            </div>
          }
        </div>
      </div>

      <div class="flex-1 flex flex-col bg-slate-50 relative">
        @if (selectedUser(); as recipient) {
           <div class="p-4 bg-white border-b shadow-sm flex items-center gap-3 shrink-0">
             <div class="h-8 w-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold">
                {{ (recipient.displayName || recipient.email) }}
             </div>
             <div>
                <h3 class="font-bold text-gray-800">{{ recipient.displayName || recipient.email }}</h3>
             </div>
          </div>

          <div class="flex-1 overflow-y-auto p-4 space-y-3" #scrollContainer>
             @for (msg of messages$ | async; track msg.createdAt) {
                <div class="flex" [ngClass]="msg.senderId === currentUser()?.uid ? 'justify-end' : 'justify-start'">
                   <div class="max-w-[70%] px-4 py-2 rounded-2xl text-sm shadow-sm break-words" 
                        [ngClass]="msg.senderId === currentUser()?.uid ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'">
                      {{ msg.text }}
                      <div class="text-[10px] mt-1 opacity-70 text-right">
                        {{ msg.createdAt | date:'HH:mm' }}
                      </div>
                   </div>
                </div>
             }
          </div>

          <form (ngSubmit)="sendMessage()" class="p-4 bg-white border-t flex gap-2 shrink-0">
             <input [(ngModel)]="newMessage" name="msg" placeholder="√âcrivez votre message..." 
                    class="flex-1 border border-gray-300 rounded-full px-4 py-2 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
             <button type="submit" [disabled]="!newMessage.trim()" 
                     class="bg-indigo-600 hover:bg-indigo-700 text-white w-10 h-10 rounded-full shadow flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                ‚û§
             </button>
          </form>

        } @else {
          <div class="flex-1 flex flex-col items-center justify-center text-gray-400">
              <span class="text-6xl mb-4">üí¨</span>
              <p>S√©lectionnez une conversation</p>
          </div>
        }
      </div>
    </div>
  `
})
export class ChatComponent implements OnInit {
  private chatService = inject(ChatService);
  public authService = inject(AuthService);
  @ViewChild('scrollContainer') private scrollContainer!: ElementRef;
  
  currentUser = toSignal(this.authService.user$);
  contacts$: Observable<UserProfile[]> = of([]);
  messages$: Observable<ChatMessage[]> = of([]);
  selectedUser = signal<UserProfile | null>(null);
  newMessage = '';

  ngOnInit() {
    this.authService.user$.subscribe(u => { 
        if (u) this.contacts$ = this.chatService.getContacts(u.uid); 
    });

    // S√©lectionner automatiquement l'utilisateur cible s'il est d√©fini dans le service (ex: clic depuis la carte)
    combineLatest([this.authService.user$, this.chatService.targetUser$]).subscribe(([currentUser, targetUser]) => {
      if (currentUser && targetUser && this.selectedUser()?.uid !== targetUser.uid) {
         this.selectUser(targetUser, currentUser.uid);
      }
    });
  }

  selectUser(user: UserProfile, currentUserId?: string) {
    this.selectedUser.set(user);
    const uid = currentUserId || this.currentUser()?.uid;
    if (uid) {
       const chatId = this.chatService.getConversationId(uid, user.uid);
       this.messages$ = this.chatService.getMessages(chatId);
       // Scroll automatique vers le bas
       setTimeout(() => { this.scrollToBottom(); }, 200);
    }
  }

  sendMessage() {
    if (this.currentUser()?.uid && this.selectedUser() && this.newMessage.trim()) {
       const chatId = this.chatService.getConversationId(this.currentUser()!.uid, this.selectedUser()!.uid);
       this.chatService.sendMessage(chatId, this.currentUser()!.uid, this.newMessage);
       this.newMessage = '';
       setTimeout(() => { this.scrollToBottom(); }, 100);
    }
  }

  private scrollToBottom() {
      if(this.scrollContainer) {
          this.scrollContainer.nativeElement.scrollTop = this.scrollContainer.nativeElement.scrollHeight;
      }
  }
}


==============================================================================
FICHIER : src/app/features/chat/chat.component.html
==============================================================================
<div class="flex h-[calc(100vh-64px)] bg-gray-100 overflow-hidden relative">
  <div 
    class="flex flex-col bg-white border-r border-gray-200 h-full transition-all"
    [ngClass]="{
      'w-full': true,              
      'hidden': selectedChatId,    /* Mobile: Cach√© si un chat est ouvert */
      'flex': !selectedChatId,     /* Mobile: Visible si pas de chat */
      'md:flex': true,             /* Desktop: Toujours visible */
      'md:w-80': true              /* Desktop: Largeur fixe */
    }"
  >
    <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
      <h2 class="font-bold text-gray-700 text-lg">Discussions</h2>
      <span class="text-xs text-gray-400 bg-gray-200 px-2 py-1 rounded-full">
        {{ (chats$ | async)?.length || 0 }}
      </span>
    </div>

    <div class="flex-1 overflow-y-auto">
      <ng-container *ngIf="chats$ | async as chatList">
        <div *ngFor="let chat of chatList" 
             (click)="selectChat(chat.id)"
             class="p-4 border-b border-gray-100 cursor-pointer hover:bg-blue-50 transition flex items-center gap-3"
             [class.bg-blue-100]="selectedChatId === chat.id">
          
          <div class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xl shrink-0">
            {{ chat.name ? chat.name[0].toUpperCase() : 'U' }}
          </div>
          
          <div class="flex-1 min-w-0"> <p class="font-medium text-gray-900 truncate">{{ chat.name || 'Utilisateur' }}</p>
            <p class="text-sm text-gray-500 truncate">{{ chat.role || 'Client' }}</p>
          </div>

          <div class="text-gray-300 md:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
            </svg>
          </div>
        </div>
      </ng-container>

      <div *ngIf="(chats$ | async)?.length === 0" class="p-8 text-center text-gray-400">
        Aucune conversation trouv√©e.
      </div>
    </div>
  </div>


  <div 
    class="flex-col bg-gray-50 h-full"
    [ngClass]="{
      'w-full fixed inset-0 z-50 bg-white': true, /* Mobile: Mode plein √©cran par dessus tout */
      'hidden': !selectedChatId,                   /* Mobile: Cach√© si rien s√©lectionn√© */
      'flex': selectedChatId,                      /* Mobile: Visible si s√©lectionn√© */
      'md:static': true,                           /* Desktop: Pas de fixed position */
      'md:flex': true,                             /* Desktop: Toujours flex */
      'md:flex-1': true,                           /* Desktop: Prend l'espace restant */
      'md:w-auto': true                            /* Desktop: Reset largeur */
    }"
  >

    <div *ngIf="!selectedChatId" class="hidden md:flex flex-col items-center justify-center h-full text-gray-400">
      <div class="bg-white p-6 rounded-full shadow-sm mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
      </div>
      <p class="text-lg">S√©lectionnez une conversation</p>
    </div>

    <ng-container *ngIf="selectedChatId">
      
      <div class="h-16 border-b border-gray-200 bg-white flex items-center px-4 shadow-sm shrink-0">
        <button (click)="clearSelection()" class="md:hidden mr-3 p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        
        <div class="flex items-center">
           <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold mr-3">
             C
           </div>
           <div>
             <h3 class="font-bold text-gray-800">Discussion</h3>
             <p class="text-xs text-green-500 flex items-center">
               <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> En ligne
             </p>
           </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
        <div *ngFor="let msg of messages$ | async" 
             class="flex w-full"
             [ngClass]="{'justify-end': msg.senderId === injector.get(Auth).currentUser?.uid, 'justify-start': msg.senderId !== injector.get(Auth).currentUser?.uid}">
          
          <div class="max-w-[75%] px-4 py-2 rounded-2xl shadow-sm text-sm"
               [ngClass]="{
                 'bg-blue-600 text-white rounded-br-none': msg.senderId === injector.get(Auth).currentUser?.uid,
                 'bg-white text-gray-800 border border-gray-100 rounded-bl-none': msg.senderId !== injector.get(Auth).currentUser?.uid
               }">
            {{ msg.text }}
          </div>
        </div>
      </div>

      <div class="p-3 bg-white border-t border-gray-200 shrink-0 safe-area-bottom">
        <div class="flex items-center gap-2 bg-gray-100 rounded-full px-4 py-2">
          <input type="text" 
                 #msgInput
                 (keyup.enter)="sendMessage(selectedChatId, 'TODO_MY_ID', msgInput.value); msgInput.value=''"
                 placeholder="√âcrivez un message..." 
                 class="flex-1 bg-transparent border-none focus:ring-0 text-gray-800 placeholder-gray-500 text-sm">
          
          <button (click)="sendMessage(selectedChatId, 'TODO_MY_ID', msgInput.value); msgInput.value=''" 
                  class="text-blue-600 font-bold p-2 hover:bg-blue-50 rounded-full transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
            </svg>
          </button>
        </div>
      </div>

    </ng-container>
  </div>
</div>



==============================================================================
FICHIER : src/app/features/driver/dashboard/driver-dashboard.component.ts
==============================================================================
import { Component, inject, signal, computed, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators, FormArray, FormGroup } from '@angular/forms';
import { AuthService } from '../../../core/auth/auth.service';
import { TripService, Trip, Parcel, Passenger } from '../../../core/services/trip.service';
import { CarService, Car } from '../../../core/services/car.service';
import { NotificationService, AppNotification } from '../../../core/services/notification.service';
import { toSignal } from '@angular/core/rxjs-interop';
import { combineLatest, map, switchMap, of } from 'rxjs';
import { Firestore, doc, updateDoc } from '@angular/fire/firestore';
import { ChatComponent } from '../../chat/chat.component';

@Component({
  selector: 'app-driver-dashboard',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, ChatComponent],
  template: `
    <div class="min-h-screen bg-gray-50 flex flex-col relative">
      
      <div class="fixed top-4 right-4 z-[9999] flex flex-col gap-2">
         @for (notif of notifications$ | async; track notif.uid) {
             <div class="bg-white border-l-4 border-indigo-600 shadow-xl rounded-r-lg p-4 flex items-start gap-3 w-80 animate-fade-in-left">
                <div class="text-2xl">üîî</div>
                <div class="flex-1">
                   <p class="text-sm font-bold text-gray-800">Notification</p>
                   <p class="text-sm text-gray-600">{{ notif.message }}</p>
                </div>
                <button (click)="markRead(notif)" class="text-gray-400 hover:text-gray-600 font-bold">‚úï</button>
             </div>
         }
      </div>

      <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-20">
        <div class="max-w-7xl mx-auto py-4 px-4 flex flex-col sm:flex-row justify-between items-center gap-4">
          <div class="flex items-center gap-2">
             <span class="text-2xl">üß¢</span>
             <h1 class="text-xl font-bold text-gray-900">Espace Chauffeur</h1>
          </div>
          <div class="flex items-center gap-3 w-full sm:w-auto">
             <button (click)="isChatOpen = true" class="flex-1 sm:flex-none bg-indigo-50 text-indigo-700 border border-indigo-200 px-4 py-2 rounded-lg font-bold hover:bg-indigo-100 flex items-center justify-center gap-2">
                <span>üí¨</span> Messages
             </button>
             <button (click)="openCreateModal()" class="flex-1 sm:flex-none bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 flex items-center justify-center gap-2"><span>‚ûï</span> Nouveau Trajet</button>
             <button (click)="logout()" class="text-sm text-red-600 font-bold border border-red-200 bg-red-50 px-3 py-2 rounded hover:bg-red-100 transition-colors">D√©connexion</button>
          </div>
        </div>
      </header>
  
      <main class="flex-1 max-w-7xl mx-auto w-full py-8 px-4 relative">
        <div *ngIf="!myCar()" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-sm"><p class="font-bold">‚ö†Ô∏è Aucun v√©hicule assign√©.</p></div>

        <div *ngIf="filteredMissions().length > 0; else noMissions">
           <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
              @for (trip of filteredMissions(); track trip.uid) {
                 <div class="bg-white shadow-lg rounded-xl border-l-4 overflow-hidden transition-transform hover:scale-[1.02] relative"
                      [ngClass]="{'border-indigo-500': trip.status === 'PENDING', 'border-blue-500': trip.status === 'IN_PROGRESS', 'border-green-500': trip.status === 'COMPLETED'}">
                      
                      <span *ngIf="trip.hasNewItems" class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse shadow-md z-10">
                          üîî Nouveau
                      </span>

                      <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                           <div><h3 class="font-bold text-lg text-gray-900">{{ trip.destination }}</h3><p class="text-sm text-gray-500">Depuis: {{ trip.departure }}</p></div>
                           <span class="px-2 py-1 text-xs font-bold rounded uppercase tracking-wide" [ngClass]="{'bg-indigo-100 text-indigo-700': trip.status === 'PENDING', 'bg-blue-100 text-blue-700': trip.status === 'IN_PROGRESS', 'bg-green-100 text-green-700': trip.status === 'COMPLETED'}">{{ trip.status }}</span>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600 mb-4">
                           <div class="flex items-center gap-2"><span>üìÖ</span> {{ trip.date | date:'dd/MM HH:mm' }}</div>
                           <div class="flex items-center gap-2"><span>üì¶</span> {{ getMergedParcels(trip).length }} Colis</div>
                           <div class="flex items-center gap-2 text-indigo-600 font-bold" *ngIf="trip.passengers?.length"><span>üôã</span> {{ trip.passengers.length }} Passagers</div>
                        </div>
                        <button (click)="viewDetails(trip)" class="w-full bg-gray-900 text-white py-2.5 rounded-lg font-bold hover:bg-gray-800 transition-colors flex items-center justify-center gap-2"><span>üëÅÔ∏è</span> Voir D√©tails</button>
                    </div>
                 </div>
              }
           </div>
        </div>
        <ng-template #noMissions><div class="flex flex-col items-center justify-center py-20 text-gray-400"><p class="text-lg font-medium">Aucune mission.</p></div></ng-template>

        <div *ngIf="isCreateModalOpen" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 overflow-y-auto">
             <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl animate-fade-in-up my-auto max-h-[90vh] overflow-y-auto">
                 <div class="bg-indigo-600 text-white p-6 flex justify-between items-center"><h3 class="font-bold text-xl">Cr√©er un Trajet</h3><button (click)="closeCreateModal()">‚úï</button></div>
                 <form [formGroup]="createForm" (ngSubmit)="submitNewTrip()" class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">D√©part</label><input formControlName="departure" class="w-full border p-2 rounded bg-gray-50"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">Destination</label><input formControlName="destination" class="w-full border p-2 rounded bg-gray-50"></div>
                        <div class="md:col-span-2"><label class="block text-sm font-bold text-gray-700 mb-1">Date</label><input type="datetime-local" formControlName="date" class="w-full border p-2 rounded bg-gray-50"></div>
                    </div>
                    <div class="flex justify-end gap-3"><button type="button" (click)="closeCreateModal()" class="px-4 py-2 text-gray-600">Annuler</button><button type="submit" [disabled]="createForm.invalid" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold">Cr√©er</button></div>
                 </form>
             </div>
        </div>

        @if (selectedTrip(); as trip) {
            <div class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 overflow-y-auto">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden animate-fade-in-up my-auto">
                    <div class="bg-gray-900 text-white p-6 flex justify-between items-start">
                        <div><h3 class="font-bold text-xl">{{ trip.destination }}</h3><p class="text-gray-300 text-sm mt-1">D√©part: {{ trip.departure }}</p></div>
                        <button (click)="closeDetails()" class="text-gray-400 hover:text-white text-2xl font-bold">‚úï</button>
                    </div>
                    <div class="p-6 max-h-[70vh] overflow-y-auto">
                        <div class="flex gap-3 mb-8">
                            <button *ngIf="trip.status === 'PENDING'" (click)="updateStatus('IN_PROGRESS')" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold">üöÄ D√©marrer</button>
                            <button *ngIf="trip.status === 'IN_PROGRESS'" (click)="updateStatus('COMPLETED')" class="flex-1 bg-gray-800 text-white py-3 rounded-xl font-bold">üèÅ Terminer</button>
                        </div>
                        <div *ngIf="trip.passengers?.length" class="mb-6">
                            <h4 class="font-bold text-indigo-900 mb-3 border-b border-indigo-100 pb-2">üôã Passagers</h4>
                            <div class="space-y-3">
                                @for (pass of trip.passengers; track $index) {
                                    <div class="border border-indigo-100 bg-indigo-50/50 rounded-xl p-4 flex justify-between items-center">
                                        <div>
                                            <p class="font-bold text-indigo-900">{{ pass.name }}</p>
                                            <a [href]="'tel:' + pass.phone" class="text-sm text-blue-600 underline">{{ pass.phone }}</a>
                                            <div class="text-xs text-gray-500 mt-1">
                                                <span *ngIf="pass.pickupLocation">‚¨ÜÔ∏è {{ pass.pickupLocation }}</span>
                                                <span *ngIf="pass.dropoffLocation" class="ml-2">‚¨áÔ∏è {{ pass.dropoffLocation }}</span>
                                            </div>
                                        </div>
                                        <button (click)="togglePassengerDropoff(trip, $index)" class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all" [ngClass]="pass.isDroppedOff ? 'bg-indigo-600 text-white border-indigo-700' : 'bg-white text-gray-300 border-gray-300'">{{ pass.isDroppedOff ? '‚úì' : '' }}</button>
                                    </div>
                                }
                            </div>
                        </div>
                        <h4 class="font-bold text-gray-800 mb-3 border-b pb-2">üì¶ Colis</h4>
                        <div class="space-y-4">
                            @for (parcel of getMergedParcels(trip); track $index) {
                                <div class="border rounded-xl p-4 transition-colors relative" [ngClass]="parcel.delivered ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="font-bold text-lg text-gray-800">{{ parcel.description }}</div>
                                            <div class="text-sm mt-1 text-gray-600">üë§ {{ parcel.recipientName }} <br>üìç {{ parcel.recipientAddress }}</div>
                                        </div>
                                        <div class="ml-4 flex flex-col items-center gap-1">
                                            <button (click)="toggleParcelDelivery(trip, parcel)" class="w-12 h-12 rounded-full flex items-center justify-center text-2xl shadow-sm transition-all border-2" [ngClass]="parcel.delivered ? 'bg-green-500 text-white border-green-600 scale-110' : 'bg-white text-gray-300 border-gray-200'">{{ parcel.delivered ? '‚úì' : '' }}</button>
                                        </div>
                                    </div>
                                </div>
                            }
                            @if (getMergedParcels(trip).length === 0) { <div class="text-center py-4 text-gray-400 italic">Aucun colis.</div> }
                         </div>
                    </div>
                </div>
            </div>
        }

        <div *ngIf="isChatOpen" class="fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
             <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] overflow-hidden flex flex-col relative">
                 <div class="bg-indigo-900 text-white px-4 py-3 flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-lg flex items-center gap-2">üí¨ Messagerie</h3>
                    <button (click)="isChatOpen = false" class="text-white/80 hover:text-white text-xl font-bold p-2">‚úï</button>
                 </div>
                 <div class="flex-1 overflow-hidden relative">
                    <app-chat class="block h-full w-full"></app-chat>
                 </div>
             </div>
        </div>
      </main>
    </div>
  `
})
export class DriverDashboardComponent implements OnInit {
  private authService = inject(AuthService);
  private tripService = inject(TripService);
  private carService = inject(CarService);
  private notifService = inject(NotificationService);
  private firestore = inject(Firestore);
  private fb = inject(FormBuilder);
  
  private user$ = this.authService.user$;
  private cars$ = this.carService.getCars();
  private allTrips$ = this.tripService.getTrips();
  
  selectedTrip = signal<Trip | null>(null);
  isCreateModalOpen = false;
  isChatOpen = false;
  notifications$ = of<AppNotification[]>([]);

  activeTab: 'parcels' | 'passengers' = 'parcels';
  myCar = toSignal(combineLatest([this.user$, this.cars$]).pipe(
      map(([user, cars]) => user ? cars.find(c => c.assignedDriverId === user.uid) || null : null)
  ));
  missions = toSignal(combineLatest([this.user$, this.cars$, this.allTrips$]).pipe(map(([user, cars, trips]) => {
        if (!user) return [];
        const myCar = cars.find(c => c.assignedDriverId === user.uid);
        if (!myCar) return [];
        return trips.filter(t => t.carId === myCar.uid);
  })), { initialValue: [] });
  filteredMissions = computed(() => this.missions().filter(t => t.status !== 'COMPLETED'));

  createForm = this.fb.group({
      departure: ['', Validators.required],
      destination: ['', Validators.required],
      date: [new Date().toISOString().slice(0, 16), Validators.required],
      parcels: this.fb.array([]),
      passengers: this.fb.array([])
  });
  get parcelsArray() { return this.createForm.get('parcels') as FormArray; }
  get passengersArray() { return this.createForm.get('passengers') as FormArray; }

  ngOnInit() {
    this.user$.subscribe(user => {
      if (user) {
        this.notifications$ = this.notifService.getNotifications(user.uid);
      }
    });
  }

  addParcel() { this.parcelsArray.push(this.fb.group({ description: [''], recipientName: [''], recipientPhone: [''], recipientAddress: [''], weight: [1], delivered: [false] })); }
  addPassenger() { this.passengersArray.push(this.fb.group({ name: [''], phone: [''], pickupLocation: [''], dropoffLocation: [''], isDroppedOff: [false] })); }
  
  removeParcel(index: number) { this.parcelsArray.removeAt(index); }
  removePassenger(index: number) { this.passengersArray.removeAt(index); }

  openCreateModal() { this.isCreateModalOpen = true; this.createForm.reset({ date: new Date().toISOString().slice(0, 16) }); this.parcelsArray.clear(); this.passengersArray.clear(); }
  closeCreateModal() { this.isCreateModalOpen = false; }

  async submitNewTrip() {
      const car = this.myCar();
      this.user$.pipe(switchMap(u => {
          if (!u || !car || this.createForm.invalid) return of(null);
          const val = this.createForm.value;
          const newTrip: Trip = {
             departure: val.departure!, destination: val.destination!, date: val.date!,
             status: 'PENDING', driverId: u.uid, carId: car.uid!, company: car.company,
             parcels: val.parcels as any[] ?? [],
             passengers: val.passengers as any[] ?? [],
             extraRequests: []
          };
          return this.tripService.createTrip(newTrip);
      })).subscribe(res => { if(res) { this.closeCreateModal(); alert('Trajet cr√©√© !'); } });
  }

  async togglePassengerDropoff(trip: Trip, index: number) {
     if(!trip.uid || !trip.passengers) return;
     trip.passengers[index].isDroppedOff = !trip.passengers[index].isDroppedOff;
     await this.tripService.updatePassengers(trip.uid, trip.passengers);
     this.selectedTrip.set({...trip});
  }

  getMergedParcels(trip: Trip): Parcel[] { return trip.parcels || []; }
  
  async toggleParcelDelivery(trip: Trip, parcelToToggle: Parcel) {
      if (!trip.uid || !trip.parcels) return;
      const idx = trip.parcels.indexOf(parcelToToggle);
      if (idx > -1) {
          trip.parcels[idx].delivered = !trip.parcels[idx].delivered;
          await this.tripService.updateParcels(trip.uid, trip.parcels);
          this.selectedTrip.set({...trip});
      }
  }
  
  // CORRECTION : Quand on clique sur Voir D√©tails, on enl√®ve le flag 'Nouveau'
  async viewDetails(trip: Trip) { 
      this.selectedTrip.set(JSON.parse(JSON.stringify(trip))); 
      if (trip.hasNewItems && trip.uid) {
          await this.tripService.updateTrip(trip.uid, { hasNewItems: false });
      }
  }

  closeDetails() { this.selectedTrip.set(null); }
  
  async updateStatus(status: any) { 
     const t = this.selectedTrip();
     if(t?.uid) { await updateDoc(doc(this.firestore, 'trips', t.uid), { status }); this.closeDetails(); }
  }
  
  logout() { this.authService.logout().subscribe(); }

  markRead(notif: AppNotification) {
    if (notif.uid) this.notifService.markAsRead(notif.uid);
  }
}



==============================================================================
FICHIER : src/app/features/admin/home/admin-home.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { UserService } from '../../../core/services/user.service';
import { map } from 'rxjs/operators';
import { RouterLink } from '@angular/router';

@Component({
  selector: 'app-admin-home',
  standalone: true,
  imports: [CommonModule, RouterLink],
  template: `
    <div class="space-y-6">
      
      <!-- Welcome Section -->
      <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-indigo-600">
        <h2 class="text-2xl font-bold text-gray-800">Bienvenue sur votre Tableau de Bord</h2>
        <p class="text-gray-600 mt-1">Voici un aper√ßu de l'activit√© de votre flotte aujourd'hui.</p>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- Card 1: Total Users -->
        <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase">Utilisateurs Total</p>
              <h3 class="text-3xl font-bold text-gray-900 mt-2">{{ (stats$ | async)?.total || 0 }}</h3>
            </div>
            <div class="p-3 bg-blue-50 rounded-full">
              <span class="text-2xl">üë•</span>
            </div>
          </div>
          <div class="mt-4 flex items-center text-sm text-gray-600">
            <span class="text-green-600 font-medium flex items-center">
              <span class="mr-1">‚Üë</span> Actifs
            </span>
            <span class="mx-2 text-gray-300">|</span>
            <span class="text-gray-500">Employ√©s & Chauffeurs</span>
          </div>
        </div>

        <!-- Card 2: Drivers -->
        <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase">Chauffeurs</p>
              <h3 class="text-3xl font-bold text-gray-900 mt-2">{{ (stats$ | async)?.drivers || 0 }}</h3>
            </div>
            <div class="p-3 bg-indigo-50 rounded-full">
               <span class="text-2xl">üß¢</span>
            </div>
          </div>
          <div class="mt-4">
             <a routerLink="/admin/drivers" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Voir les d√©tails ‚Üí</a>
          </div>
        </div>

        <!-- Card 3: Pending Validations -->
        <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase">En attente</p>
              <h3 class="text-3xl font-bold text-orange-600 mt-2">{{ (stats$ | async)?.pending || 0 }}</h3>
            </div>
            <div class="p-3 bg-orange-50 rounded-full">
               <span class="text-2xl">‚ö†Ô∏è</span>
            </div>
          </div>
          <div class="mt-4 text-sm text-gray-500">
            Utilisateurs √† valider
          </div>
        </div>
      </div>

      <!-- Quick Actions / Recent Activity Placeholder -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">Actions Rapides</h3>
          <div class="grid grid-cols-2 gap-4">
            <button class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-indigo-300 transition text-left group">
              <span class="block text-xl mb-2 group-hover:scale-110 transition-transform">üöö</span>
              <span class="font-semibold text-gray-700">Ajouter un V√©hicule</span>
            </button>
            <button routerLink="/register" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-indigo-300 transition text-left group">
              <span class="block text-xl mb-2 group-hover:scale-110 transition-transform">üë§</span>
              <span class="font-semibold text-gray-700">Cr√©er un Utilisateur</span>
            </button>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6">
           <h3 class="text-lg font-bold text-gray-800 mb-4">√âtat du Syst√®me</h3>
           <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-green-50 rounded border border-green-100">
                 <span class="text-green-800 font-medium">Base de donn√©es</span>
                 <span class="bg-green-200 text-green-800 text-xs px-2 py-1 rounded-full">Connect√©</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-100">
                 <span class="text-gray-700">Version API</span>
                 <span class="text-gray-500 text-sm">v1.0.0</span>
              </div>
           </div>
        </div>
      </div>
    </div>
  `
})
export class AdminHomeComponent {
  private userService = inject(UserService);

  // Calcul des statistiques en temps r√©el depuis le UserService
  stats$ = this.userService.getAllUsers().pipe(
    map(users => ({
      total: users.length,
      drivers: users.filter(u => u.role === 'DRIVER').length,
      pending: users.filter(u => !u.isActive).length
    }))
  );
}



==============================================================================
FICHIER : src/app/features/admin/mock-data/mock-data.component.ts
==============================================================================
import { Component, inject, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { MockDataService } from '../../../core/services/mock-data.service';

@Component({
  selector: 'app-mock-data',
  standalone: true,
  imports: [CommonModule],
  template: `
    <div class="max-w-4xl mx-auto py-10 px-4">
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-8 text-white">
          <h2 class="text-3xl font-bold flex items-center gap-3">
             <span class="text-4xl">‚ö°</span> G√©n√©rateur de Donn√©es
          </h2>
          <p class="mt-2 text-purple-100">R√©initialisation et peuplement de la base de donn√©es.</p>
        </div>

        <div class="p-8">
           <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
              <div class="flex">
                <span class="text-yellow-400 text-xl mr-3">‚ö†Ô∏è</span>
                <div>
                  <p class="text-sm text-yellow-700 font-bold">Action Destructive</p>
                  <p class="text-xs text-yellow-600 mt-1">
                    Ceci supprimera tous les utilisateurs (sauf vous), trajets et soci√©t√©s.
                  </p>
                </div>
              </div>
           </div>

           <div class="space-y-4 mb-8 text-gray-600">
              <h3 class="font-bold text-gray-800 border-b pb-2">Ce qui sera cr√©√© :</h3>
              <ul class="list-disc pl-5 space-y-1">
                 <li>üè¢ <strong>1 Soci√©t√©</strong> (Tunisia Express)</li>
                 <li>üëÆ <strong>2 Administrateurs</strong> (admin1@test.com, admin2@test.com)</li>
                 <li>üß¢ <strong>3 Chauffeurs</strong> (chauffeur1@test.com...)</li>
                 <li>üöö <strong>3 V√©hicules</strong> assign√©s</li>
                 <li>üì¶ <strong>6 Trajets</strong> (2 par chauffeur)</li>
              </ul>
           </div>
              
           <button (click)="generate()" [disabled]="isLoading()" 
              class="w-full py-4 px-6 rounded-xl text-white font-bold text-lg shadow-lg transform transition hover:scale-105 disabled:opacity-50 disabled:transform-none bg-indigo-600 hover:bg-indigo-700">
              {{ isLoading() ? 'Traitement en cours...' : 'Lancer la G√©n√©ration' }}
           </button>
        </div>
      </div>
    </div>
  `
})
export class MockDataComponent {
  private mockService = inject(MockDataService);
  isLoading = signal(false);

  async generate() {
    if(confirm('√ätes-vous s√ªr de vouloir tout √©craser ?')) {
      this.isLoading.set(true);
      try {
        await this.mockService.generateAll();
      } catch (e) {
        alert('Erreur: ' + e);
      }
      this.isLoading.set(false);
    }
  }
}



==============================================================================
FICHIER : src/app/features/admin/admin.routes.ts
==============================================================================
import { Routes } from '@angular/router';
import { AdminDashboardComponent } from './dashboard/admin-dashboard.component';
import { UserListComponent } from './users/user-list.component';
import { AdminHomeComponent } from './home/admin-home.component';
import { CarManagerComponent } from './cars/car-manager.component';
import { TripManagerComponent } from './trips/trip-manager.component';
import { CompanyManagerComponent } from './companies/company-manager.component';
import { LiveMapComponent } from './live-map/live-map.component';
import { MockDataComponent } from './mock-data/mock-data.component';
import { ChatComponent } from '../chat/chat.component'; // CHEMIN CORRIG√â (../ au lieu de ../../)

export const ADMIN_ROUTES: Routes = [
  {
    path: '',
    component: AdminDashboardComponent,
    children: [
      { path: '', component: AdminHomeComponent, title: 'Administration - Accueil' },
      { path: 'live-map', component: LiveMapComponent, title: 'Administration - Carte Live' },
      { path: 'users', component: UserListComponent, title: 'Administration - Utilisateurs' },
      { path: 'cars', component: CarManagerComponent, title: 'Administration - Flotte' },
      { path: 'trips', component: TripManagerComponent, title: 'Administration - Trajets' },
      { path: 'companies', component: CompanyManagerComponent, title: 'Administration - Soci√©t√©s' },
      { path: 'mock-data', component: MockDataComponent, title: 'Administration - Donn√©es Test' },
      { path: 'chat', component: ChatComponent, title: 'Administration - Messagerie' },
      { path: 'drivers', redirectTo: 'users' }
    ]
  }
];



==============================================================================
FICHIER : src/app/features/admin/dashboard/admin-dashboard.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterOutlet, RouterLink, RouterLinkActive } from '@angular/router';
import { AuthService } from '../../../core/auth/auth.service';
import { ChatComponent } from '../../chat/chat.component';
import { switchMap } from 'rxjs/operators';
import { of } from 'rxjs';
import { toSignal } from '@angular/core/rxjs-interop';

@Component({
  selector: 'app-admin-dashboard',
  standalone: true,
  imports: [CommonModule, RouterOutlet, RouterLink, RouterLinkActive],
  template: `
    <div class="min-h-screen bg-gray-50 flex flex-col lg:flex-row">
      
      <div *ngIf="isMobileMenuOpen" (click)="closeMobileMenu()" 
           class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9998] lg:hidden transition-opacity">
      </div>

      <aside class="fixed inset-y-0 left-0 z-[10000] w-72 bg-slate-900 text-white shadow-2xl flex flex-col transition-transform duration-300 transform lg:translate-x-0"
             [ngClass]="isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'">
        
        <div class="h-20 flex items-center px-8 border-b border-slate-800 bg-slate-950/50">
          <span class="text-xl font-bold tracking-wide text-white">Master<span class="text-indigo-400">DELIVERY</span></span>
        </div>

        <nav class="flex-1 py-8 px-4 space-y-1 overflow-y-auto">
          
          <a routerLink="/admin" [routerLinkActiveOptions]="{exact: true}" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üè†</span> Accueil
          </a>

          <a routerLink="/admin/live-map" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üåç</span> Carte Live
          </a>

          <a routerLink="/admin/trips" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üì¶</span> Trajets
          </a>

          <a routerLink="/admin/users" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üë•</span> Utilisateurs
          </a>

          <a routerLink="/admin/cars" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üöö</span> V√©hicules
          </a>
          
          <a routerLink="/admin/companies" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üè¢</span> Soci√©t√©s
          </a>

          <a routerLink="/admin/chat" routerLinkActive="bg-indigo-600/20 text-white border-l-4 border-indigo-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-slate-400 hover:text-white mb-1 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">üí¨</span> Messagerie
          </a>

          <a routerLink="/admin/mock-data" routerLinkActive="bg-purple-600/20 text-white border-l-4 border-purple-500" 
             (click)="closeMobileMenu()"
             class="flex items-center px-4 py-3 rounded-r-lg text-purple-300 hover:text-white mb-1 mt-6 border-l-4 border-transparent cursor-pointer transition-all hover:bg-slate-800">
             <span class="mr-3">‚ö°</span> Donn√©es Test
          </a>
          
          <button (click)="logout()" class="w-full flex items-center px-4 py-3 text-red-400 hover:text-red-300 mt-6 border-t border-slate-800 pt-4 cursor-pointer hover:bg-slate-800 transition-all">
             <span class="mr-3">üö™</span> D√©connexion
          </button>
        </nav>
      </aside>

      <div class="lg:pl-72 flex flex-col h-screen w-full relative transition-all duration-300">
        <header class="bg-white border-b h-16 flex items-center justify-between px-4 lg:hidden sticky top-0 z-20 shadow-sm">
             <button (click)="toggleMobileMenu()" class="text-2xl text-indigo-600 p-2">‚ò∞</button>
             <span class="font-bold text-gray-800">Master<span class="text-indigo-600">Delivery</span></span>
        </header>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-4">
             <router-outlet></router-outlet>
        </main>
      </div>

      
    </div>
  `
})
export class AdminDashboardComponent {
  private authService = inject(AuthService);
  isMobileMenuOpen = false;
  userProfile = toSignal(this.authService.user$.pipe(switchMap(user => user ? this.authService.getUserProfile(user.uid) : of(null))));
  
  toggleMobileMenu() { this.isMobileMenuOpen = !this.isMobileMenuOpen; }
  
  // NOUVELLE M√âTHODE : Ferme explicitement le menu
  closeMobileMenu() { this.isMobileMenuOpen = false; }
  
  logout() { this.authService.logout().subscribe(); }
}



==============================================================================
FICHIER : src/app/features/admin/users/user-list.component.ts
==============================================================================
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import { UserService } from '../../../core/services/user.service';
import { AuthService, UserProfile } from '../../../core/auth/auth.service';
import { ChatService } from '../../../core/services/chat.service';
import { Observable } from 'rxjs';
import { toSignal } from '@angular/core/rxjs-interop';

@Component({
  selector: 'app-user-list',
  standalone: true,
  imports: [CommonModule],
  template: `
    <div class="bg-white shadow rounded-lg overflow-hidden">
      <div class="px-4 py-5 sm:px-6 flex justify-between items-center bg-indigo-50">
        <div><h3 class="text-lg leading-6 font-bold text-gray-900">Gestion des Utilisateurs</h3></div>
        <span class="bg-white text-indigo-600 py-1 px-3 rounded-full text-xs font-bold border border-indigo-200">Total: {{ (users$ | async)?.length || 0 }}</span>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Utilisateur</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">T√©l√©phone</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">R√¥le</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            @for (user of users$ | async; track user.uid) {
              <tr class="hover:bg-gray-50 group">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="h-10 w-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-bold mr-3 text-lg">
                       {{ (user.displayName || user.email) }}
                    </div>
                    <div>
                      <div class="text-sm font-bold text-gray-900 flex items-center gap-2">
                          {{ user.displayName || user.email }}
                          <button (click)="openChat(user)" class="opacity-50 group-hover:opacity-100 transition-opacity bg-indigo-100 hover:bg-indigo-200 text-indigo-700 p-1 rounded-full flex items-center justify-center h-6 w-6" title="Discuter">üí¨</button>
                      </div>
                      <div class="text-xs text-gray-500">{{ user.company }}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono font-bold text-indigo-700">{{ user.phoneNumber || 'N/A' }}</td>
                <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">{{ user.role }}</span></td>
                <td class="px-6 py-4 whitespace-nowrap"><span *ngIf="user.isActive" class="text-green-600 text-xs font-bold">Actif</span><span *ngIf="!user.isActive" class="text-red-600 text-xs font-bold">Inactif</span></td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <button *ngIf="!user.isActive" (click)="toggleStatus(user, true)" class="text-green-600 hover:text-green-900 mr-2">Valider</button>
                  <button *ngIf="user.isActive" (click)="toggleStatus(user, false)" class="text-red-600 hover:text-red-900 mr-2">D√©sactiver</button>
                  <button *ngIf="isSuperAdmin() && user.role !== 'ADMIN'" (click)="promoteToAdmin(user)" class="text-indigo-600 hover:text-indigo-900">‚òÖ Admin</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  `
})
export class UserListComponent {
  private userService = inject(UserService);
  private authService = inject(AuthService);
  private chatService = inject(ChatService);
  private router = inject(Router);
  users$: Observable<UserProfile[]> = this.userService.getAllUsers();
  currentUser = toSignal(this.authService.user$);
  isSuperAdmin(): boolean { return this.currentUser()?.email === 'admin@gmail.com'; }
  toggleStatus(user: UserProfile, status: boolean) { if(confirm('Modifier statut ?')) this.userService.updateUserStatus(user.uid, status); }
  promoteToAdmin(user: UserProfile) { if(confirm('Promouvoir Admin ?')) this.userService.updateUserRole(user.uid, 'ADMIN'); }
  openChat(user: UserProfile) { this.chatService.startChatWith(user); this.router.navigate(['/admin/chat']); }
}



==============================================================================
FICHIER : src/app/features/admin/cars/car-manager.component.ts
==============================================================================
import { Component, inject, computed } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { CarService, Car } from '../../../core/services/car.service';
import { UserService } from '../../../core/services/user.service';
import { AuthService, UserProfile } from '../../../core/auth/auth.service';
import { CompanyService } from '../../../core/services/company.service';
import { Observable, combineLatest, of } from 'rxjs';
import { switchMap, map, shareReplay, startWith } from 'rxjs/operators';
import { toSignal } from '@angular/core/rxjs-interop';

@Component({
  selector: 'app-car-manager',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-3 bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-4">
        <div class="flex items-center gap-2">
           <span class="text-2xl">üè¢</span> 
           <div>
             <p class="text-sm font-semibold text-indigo-800">Mode de Gestion</p>
             <p class="font-bold text-indigo-900">
               @if (isSuperAdmin()) { ‚ö° SUPER ADMIN (Compte Syst√®me) } 
               @else if (adminCompany()) { {{ adminCompany() }} } 
               @else { <span class="italic opacity-50">Chargement...</span> }
             </p>
           </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 h-fit">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Ajouter un V√©hicule</h3>
        <form [formGroup]="carForm" (ngSubmit)="addCar()" class="space-y-4">
          @if (isSuperAdmin()) {
            <div>
              <label class="block text-sm font-medium text-gray-700">Soci√©t√© <span class="text-red-500">*</span></label>
              <select formControlName="company" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 bg-yellow-50">
                <option value="" disabled>Choisir une soci√©t√©</option>
                @for (company of companies(); track company.uid) { <option [value]="company.name">{{ company.name }}</option> }
              </select>
            </div>
          }
          <div><label class="block text-sm font-medium text-gray-700">Mod√®le</label><input formControlName="model" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2"></div>
          <div><label class="block text-sm font-medium text-gray-700">Plaque</label><input formControlName="plate" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2"></div>
          <button type="submit" [disabled]="carForm.invalid || (!isSuperAdmin() && !adminCompany())" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50">Ajouter</button>
        </form>
      </div>

      <div class="lg:col-span-2 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
           <h3 class="text-lg font-bold text-gray-800">Flotte {{ isSuperAdmin() ? 'Globale' : adminCompany() }}</h3>
           <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">{{ (carsFiltered$ | async)?.length || 0 }} v√©hicules</span>
        </div>
        <div class="overflow-x-auto">
           <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">V√©hicule</th>
                  @if (isSuperAdmin()) { <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Soci√©t√©</th> }
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chauffeur</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                @for (car of carsFiltered$ | async; track car.uid) {
                  <tr class="hover:bg-gray-50 transition-colors">
                     <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-900">{{ car.model }}</div>
                        <div class="text-xs text-gray-500 font-mono">{{ car.plate }}</div>
                     </td>
                     @if (isSuperAdmin()) { <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-bold bg-indigo-50 text-indigo-700 rounded-md border border-indigo-100">{{ car.company }}</span></td> }
                     <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-bold rounded-full" [ngClass]="{'bg-green-100 text-green-800': car.status === 'AVAILABLE', 'bg-red-100 text-red-800': car.status === 'BUSY', 'bg-yellow-100 text-yellow-800': car.status === 'MAINTENANCE'}">
                           {{ car.status }}
                        </span>
                     </td>
                     <td class="px-6 py-4 whitespace-nowrap">
                        <select #driverSelect (change)="assignDriver(car, driverSelect.value)" class="text-sm border-gray-300 rounded-md border p-1.5 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm cursor-pointer w-40">
                           <option value="" [selected]="!car.assignedDriverId">-- Non assign√© --</option>
                           @for (driver of getDriversForCar(car, (drivers$ | async)); track driver.uid) { <option [value]="driver.uid" [selected]="car.assignedDriverId === driver.uid">{{ driver.displayName || driver.email }}</option> }
                        </select>
                     </td>
                     <td class="px-6 py-4 whitespace-nowrap text-right"><button (click)="deleteCar(car)" class="text-red-600 hover:text-red-900 text-xs font-bold border border-red-200 bg-red-50 px-2 py-1 rounded">Supprimer</button></td>
                   </tr>
                 }
              </tbody>
           </table>
        </div>
      </div>
    </div>
  `
})
export class CarManagerComponent {
  private carService = inject(CarService);
  private userService = inject(UserService);
  private authService = inject(AuthService);
  private companyService = inject(CompanyService);
  private fb = inject(FormBuilder);

  adminProfile$ = this.authService.user$.pipe(
    switchMap(user => {
        if (!user) return of(null);
        if (user.email === 'admin@gmail.com') {
           // CORRECTION ICI : Ajout de displayName
           const superAdminProfile: UserProfile = {
               uid: user.uid,
               email: user.email,
               displayName: 'Super Admin', // <--- AJOUT√â
               role: 'SUPER_ADMIN',
               company: 'System', 
               isActive: true,
               phoneNumber: '00000000',
               createdAt: new Date()
           };
           return of(superAdminProfile);
        }
        return this.authService.getUserProfile(user.uid);
    }),
    shareReplay(1)
  );
  
  companies = this.companyService.activeCompanies;
  isSuperAdmin = toSignal(this.adminProfile$.pipe(map(p => p?.role === 'SUPER_ADMIN' || p?.email === 'admin@gmail.com')), { initialValue: false });
  adminCompany = toSignal(this.adminProfile$.pipe(map(p => p?.company || null)));

  carsFiltered$ = combineLatest([this.carService.getCars(), this.adminProfile$.pipe(startWith(null))]).pipe(
    map(([cars, profile]) => {
      if (profile?.role === 'SUPER_ADMIN') return cars;
      if (!profile?.company) return [];
      return cars.filter(car => car.company === profile.company);
    })
  );

  drivers$ = combineLatest([this.userService.getAllUsers(), this.adminProfile$.pipe(startWith(null))]).pipe(
    map(([users, profile]) => {
      if (profile?.role === 'SUPER_ADMIN') return users.filter(u => u.role === 'DRIVER' && u.isActive);
      if (!profile?.company) return [];
      return users.filter(u => u.role === 'DRIVER' && u.isActive && u.company === profile.company);
    })
  );

  carForm = this.fb.group({ model: ['', Validators.required], plate: ['', Validators.required], company: [''] });

  getDriversForCar(car: Car, allDrivers: any[] | null): any[] {
    if (!allDrivers) return [];
    if (this.isSuperAdmin()) return allDrivers.filter(d => d.company === car.company);
    return allDrivers;
  }

  addCar() {
    let targetCompany = this.adminCompany();
    if (this.isSuperAdmin()) {
       targetCompany = this.carForm.value.company;
       if (!targetCompany) { alert("S√©lectionnez une soci√©t√©."); return; }
    }
    if (!targetCompany || this.carForm.invalid) return;
    this.carService.addCar({ ...this.carForm.value, status: 'AVAILABLE', assignedDriverId: null, company: targetCompany } as any).then(() => {
      this.carForm.reset({ company: '' });
    });
  }

  assignDriver(car: Car, driverId: string) {
    if (!this.isSuperAdmin() && car.company !== this.adminCompany()) { alert("Non autoris√©."); return; }
    this.carService.assignDriver(car.uid!, driverId || null);
  }
  
  deleteCar(car: Car) { if(confirm('Supprimer ?')) alert("Suppression √† impl√©menter."); }
}



==============================================================================
FICHIER : src/app/features/admin/trips/trip-manager.component.ts
==============================================================================
import { Component, inject, signal, computed } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators, FormArray, FormGroup } from '@angular/forms';
import { Router } from '@angular/router';
import { TripService, Trip, Parcel, Passenger } from '../../../core/services/trip.service';
import { CarService, Car } from '../../../core/services/car.service';
import { AuthService, UserProfile } from '../../../core/auth/auth.service';
import { CompanyService } from '../../../core/services/company.service';
import { UserService } from '../../../core/services/user.service';
import { ChatService } from '../../../core/services/chat.service';
import { NotificationService } from '../../../core/services/notification.service';
import { toSignal } from '@angular/core/rxjs-interop';
import { startWith, map, switchMap, shareReplay } from 'rxjs/operators';
import { combineLatest, of } from 'rxjs';

@Component({
  selector: 'app-trip-manager',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="space-y-6 p-6">
      <div class="flex justify-between items-center gap-4">
        <h2 class="text-2xl font-bold text-gray-800">Suivi des Trajets</h2>
        <button (click)="toggleForm()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 shadow-md transition-colors">
           {{ showForm ? 'Fermer' : 'Nouveau Trajet' }}
        </button>
      </div>

      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200" [formGroup]="filterForm">
         <select formControlName="company" class="w-full border-gray-300 rounded-md shadow-sm border p-2 text-sm bg-gray-50">
            <option value="">Toutes les soci√©t√©s</option>
            @for (company of activeCompanies(); track company.uid) {
               <option [value]="company.name">{{ company.name }}</option>
            }
         </select>
      </div>

      <div *ngIf="showForm" class="bg-white p-6 rounded-lg shadow-xl border-l-4 border-indigo-500 mb-6 animate-fade-in">
         <h3 class="text-lg font-bold text-gray-800 mb-4">Cr√©er un nouveau trajet</h3>
         <form [formGroup]="tripForm" (ngSubmit)="createTrip()">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
               <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">D√©part</label><input formControlName="departure" class="w-full border p-2 rounded"></div>
               <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Destination</label><input formControlName="destination" class="w-full border p-2 rounded"></div>
               <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label><input type="datetime-local" formControlName="date" class="w-full border p-2 rounded"></div>
               <div>
                  <label class="block text-xs font-bold text-gray-500 uppercase mb-1">V√©hicule</label>
                  <select formControlName="carId" class="w-full border p-2 rounded bg-white">
                     <option value="">-- Choisir --</option>
                     @for (car of cars$ | async; track car.uid) { <option [value]="car.uid">{{ car.model }} ({{ car.plate }})</option> }
                  </select>
               </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                   <div class="flex justify-between items-center mb-4"><h4 class="font-bold text-gray-700">üì¶ Colis Initiaux</h4><button type="button" (click)="addParcel()" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold">+ Ajouter</button></div>
                   <div formArrayName="parcels" class="space-y-3">
                      @for (parcel of parcelsArray.controls; track $index) {
                         <div [formGroupName]="$index" class="bg-white p-2 rounded shadow-sm border border-gray-200 text-sm relative">
                           <button type="button" (click)="removeParcel($index)" class="absolute right-1 top-1 text-red-400 font-bold text-xs">‚úï</button>
                           <input formControlName="description" placeholder="Objet" class="w-full mb-1 border-gray-300 rounded p-1 border">
                           <input formControlName="recipientName" placeholder="Client" class="w-full mb-1 border-gray-300 rounded p-1 border">
                           <div class="flex gap-1"><input formControlName="recipientPhone" placeholder="T√©l" class="w-1/2 border-gray-300 rounded p-1 border"><input formControlName="recipientAddress" placeholder="Adresse" class="w-1/2 border-gray-300 rounded p-1 border"></div>
                        </div>
                      }
                   </div>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                   <div class="flex justify-between items-center mb-4"><h4 class="font-bold text-indigo-900">üôã Passagers Initiaux</h4><button type="button" (click)="addPassenger()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold">+ Ajouter</button></div>
                   <div formArrayName="passengers" class="space-y-3">
                      @for (p of passengersArray.controls; track $index) {
                        <div [formGroupName]="$index" class="bg-white p-2 rounded shadow-sm border border-indigo-100 text-sm relative">
                           <button type="button" (click)="removePassenger($index)" class="absolute right-1 top-1 text-red-400 font-bold text-xs">‚úï</button>
                           <input formControlName="name" placeholder="Nom Pr√©nom" class="w-full mb-1 border-gray-300 rounded p-1 border font-bold">
                           <input formControlName="phone" placeholder="T√©l√©phone" class="w-full mb-1 border-gray-300 rounded p-1 border">
                           <div class="flex gap-1"><input formControlName="pickupLocation" placeholder="Prise" class="w-1/2 border-gray-300 rounded p-1 border text-xs"><input formControlName="dropoffLocation" placeholder="D√©pose" class="w-1/2 border-gray-300 rounded p-1 border text-xs"></div>
                        </div>
                      }
                   </div>
                </div>
            </div>
            <div class="flex justify-end mt-6"><button type="button" (click)="toggleForm()" class="px-4 py-2 text-gray-600">Annuler</button><button type="submit" [disabled]="tripForm.invalid" class="bg-indigo-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg ml-3">Valider</button></div>
         </form>
      </div>

      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
         <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
               <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Trajet</th><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Contenu</th><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Statut</th><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Chauffeur</th><th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Actions</th></tr></thead>
               <tbody class="bg-white divide-y divide-gray-200">
                  @for (trip of filteredTrips(); track trip.uid) {
                     <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4"><div class="flex flex-col"><span class="text-sm font-bold text-gray-900">{{ trip.departure }} ‚ûù {{ trip.destination }}</span><span class="text-xs text-gray-500">{{ trip.company }}</span><span class="text-xs text-gray-400 mt-1">{{ trip.date | date:'dd/MM HH:mm' }}</span></div></td>
                        <td class="px-6 py-4"><div class="flex flex-col gap-2">
                               <div *ngIf="trip.parcels?.length" class="text-xs"><strong class="text-gray-500 block mb-1">üì¶ {{ trip.parcels.length }} Colis:</strong>@for (p of trip.parcels; track $index) { <div class="pl-2 border-l-2 border-gray-200 text-gray-600">{{ p.description }}</div> }</div>
                               <div *ngIf="trip.passengers?.length" class="text-xs"><strong class="text-indigo-500 block mb-1">üôã {{ trip.passengers.length }} Passagers:</strong>@for (pass of trip.passengers; track $index) { <div class="pl-2 border-l-2 border-indigo-200 text-gray-700">{{ pass.name }}</div> }</div>
                        </div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-bold rounded-full bg-blue-100 text-blue-800">{{ trip.status }}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                           <div class="flex items-center gap-3">
                              <div *ngIf="trip.driverName; else noDriver" class="flex items-center gap-2">
                                 <div><div class="text-sm font-bold text-gray-900">{{ trip.driverName }}</div><div class="text-xs text-gray-500 font-mono">{{ trip.driverPhone }}</div></div>
                                 <button *ngIf="trip.driverProfile" (click)="openChat(trip.driverProfile)" class="h-8 w-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 shadow-sm">üí¨</button>
                              </div>
                              <ng-template #noDriver><span class="text-xs text-gray-400 italic bg-gray-100 px-2 py-1 rounded">Non assign√©</span></ng-template>
                           </div>
                        </td>
                        <td class="px-6 py-4 text-right whitespace-nowrap">
                           <button (click)="openRequestModal(trip)" class="p-2 text-xs bg-purple-50 text-purple-700 rounded border border-purple-200 mr-2 hover:bg-purple-100">‚ûï Ajout Rapide</button>
                           <button (click)="handleTrackClick(trip)" class="p-2 text-xs bg-blue-50 text-blue-700 rounded border border-blue-200 mr-2">üìç</button>
                           <button (click)="deleteTrip(trip)" class="p-2 text-xs bg-red-50 text-red-700 rounded border border-red-200">üóëÔ∏è</button>
                        </td>
                     </tr>
                  } @empty { <tr><td colspan="5" class="p-8 text-center text-gray-500">Aucun trajet.</td></tr> }
               </tbody>
            </table>
         </div>
      </div>

    <div *ngIf="selectedTripForRequest" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden animate-fade-in-up flex flex-col max-h-[90vh]">
            
            <div class="bg-indigo-900 text-white p-4 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg">Ajouter au Trajet : {{ selectedTripForRequest.departure }} ‚ûù {{ selectedTripForRequest.destination }}</h3>
                <button (click)="closeRequestModal()" class="text-white hover:text-gray-300">‚úï</button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                
                <div *ngIf="tempParcels.length > 0 || tempPassengers.length > 0" class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-bold text-yellow-800 mb-2 flex items-center gap-2">üìù Liste √† valider ({{ tempParcels.length + tempPassengers.length }})</h4>
                    <ul class="space-y-2 text-sm">
                        @for (p of tempParcels; track $index) {
                            <li class="flex justify-between items-center bg-white p-2 rounded shadow-sm">
                                <span>üì¶ <strong>{{ p.description }}</strong> ({{ p.recipientName }})</span>
                                <button (click)="removeTempParcel($index)" class="text-red-500 hover:text-red-700 font-bold">‚úï</button>
                            </li>
                        }
                        @for (p of tempPassengers; track $index) {
                            <li class="flex justify-between items-center bg-white p-2 rounded shadow-sm">
                                <span>üôã <strong>{{ p.name }}</strong> ({{ p.phone }})</span>
                                <button (click)="removeTempPassenger($index)" class="text-red-500 hover:text-red-700 font-bold">‚úï</button>
                            </li>
                        }
                    </ul>
                    <div class="mt-3 text-right">
                         <button (click)="saveAllExtras()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-yellow-700 shadow-sm animate-pulse">
                            ‚úÖ Valider et Envoyer Tout
                         </button>
                    </div>
                </div>

                <div class="flex gap-4 mb-4 bg-gray-100 p-1 rounded-lg">
                  <button (click)="requestType='PARCEL'" 
                          [class]="requestType==='PARCEL' ? 'bg-white text-indigo-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'" 
                          class="flex-1 py-2 rounded-md font-bold transition-all text-sm flex items-center justify-center gap-2">
                      <span>üì¶</span> Nouveau Colis
                  </button>
                  <button (click)="requestType='PASSENGER'" 
                          [class]="requestType==='PASSENGER' ? 'bg-white text-indigo-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'" 
                          class="flex-1 py-2 rounded-md font-bold transition-all text-sm flex items-center justify-center gap-2">
                      <span>üôã</span> Nouveau Passager
                  </button>
                </div>

                <div *ngIf="requestType==='PARCEL'" class="space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                   <div>
                     <label class="text-xs font-bold text-gray-500 uppercase">Description</label>
                     <input #descInput placeholder="Ex: Documents, PC..." class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                   </div>
                   <div class="grid grid-cols-2 gap-3">
                     <div>
                       <label class="text-xs font-bold text-gray-500 uppercase">Destinataire</label>
                       <input #recNameInput placeholder="Nom" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                     </div>
                     <div>
                       <label class="text-xs font-bold text-gray-500 uppercase">T√©l</label>
                       <input #recPhoneInput placeholder="20..." class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                     </div>
                   </div>
                   <div>
                     <label class="text-xs font-bold text-gray-500 uppercase">Adresse</label>
                     <input #recAddrInput placeholder="Adresse livraison" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                   </div>
                   <button (click)="addToTempParcel(descInput, recNameInput, recPhoneInput, recAddrInput)" 
                           class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 mt-2">
                       ‚¨áÔ∏è Ajouter √† la liste
                   </button>
                </div>

                <div *ngIf="requestType==='PASSENGER'" class="space-y-3 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                   <div class="grid grid-cols-2 gap-3">
                     <div>
                       <label class="text-xs font-bold text-gray-500 uppercase">Nom</label>
                       <input #passNameInput placeholder="Nom Pr√©nom" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                     </div>
                     <div>
                       <label class="text-xs font-bold text-gray-500 uppercase">T√©l</label>
                       <input #passPhoneInput placeholder="Phone" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                     </div>
                   </div>
                   <div>
                       <label class="text-xs font-bold text-gray-500 uppercase">Lieu de prise</label>
                       <input #passPickInput placeholder="D√©part" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                   </div>
                   <div>
                       <label class="text-xs font-bold text-gray-500 uppercase">Destination</label>
                       <input #passDropInput placeholder="Arriv√©e" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                   </div>
                   <button (click)="addToTempPassenger(passNameInput, passPhoneInput, passPickInput, passDropInput)" 
                           class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 mt-2">
                       ‚¨áÔ∏è Ajouter √† la liste
                   </button>
                </div>
            </div>
        </div>
    </div>
    </div>
  `
})
export class TripManagerComponent {
  private fb = inject(FormBuilder);
  private tripService = inject(TripService);
  private carService = inject(CarService);
  private authService = inject(AuthService);
  private companyService = inject(CompanyService);
  private userService = inject(UserService);
  private chatService = inject(ChatService);
  private notifService = inject(NotificationService);
  private router = inject(Router);
  
  showForm = false;
  cars$ = this.carService.getCars();
  activeCompanies = this.companyService.activeCompanies;
  selectedTripForRequest: Trip | null = null;
  
  adminProfile$ = this.authService.user$.pipe(switchMap(u => u?.email === 'admin@gmail.com' ? of({ uid: u.uid, email: u.email, role: 'SUPER_ADMIN', company: 'System', displayName: 'Super Admin' } as UserProfile) : (u ? this.authService.getUserProfile(u.uid) : of(null))), shareReplay(1));
  adminCompany = toSignal(this.adminProfile$.pipe(map(p => p?.company || null)));
  filterForm = this.fb.group({ company: [''], inProgressOnly: [false] });
  filterValues = toSignal(this.filterForm.valueChanges.pipe(startWith(this.filterForm.value)), { initialValue: this.filterForm.value });

  tripForm = this.fb.group({ departure: ['', Validators.required], destination: ['', Validators.required], date: ['', Validators.required], carId: ['', Validators.required], parcels: this.fb.array([]), passengers: this.fb.array([]) });
  get parcelsArray() { return this.tripForm.get('parcels') as FormArray; }
  get passengersArray() { return this.tripForm.get('passengers') as FormArray; }
  
  addParcel() { this.parcelsArray.push(this.fb.group({ description: [''], recipientName: [''], recipientPhone: [''], recipientAddress: [''], weight: [1], delivered: [false] })); }
  addPassenger() { this.passengersArray.push(this.fb.group({ name: [''], phone: [''], pickupLocation: [''], dropoffLocation: [''], isDroppedOff: [false] })); }
  removeParcel(i: number) { this.parcelsArray.removeAt(i); }
  removePassenger(i: number) { this.passengersArray.removeAt(i); }
  toggleForm() { this.showForm = !this.showForm; }
  
  async createTrip() { if (this.tripForm.valid) { await this.tripService.createTrip({ ...this.tripForm.value, driverId: 'PENDING', status: 'PENDING', company: this.adminCompany() === 'System' ? 'Tunisia Express' : this.adminCompany(), parcels: this.tripForm.value.parcels ?? [], passengers: this.tripForm.value.passengers ?? [], extraRequests: [] } as any); this.tripForm.reset(); this.parcelsArray.clear(); this.passengersArray.clear(); this.showForm = false; } }
  
  requestForm = this.fb.group({ type: ['PARCEL'], description: [''], parcels: this.fb.array([]) });
  openRequestModal(t: Trip) { 
      this.selectedTripForRequest = t;
      this.tempParcels = [];
      this.tempPassengers = [];
  }
  closeRequestModal() { this.selectedTripForRequest = null; }
  
  async deleteTrip(t: Trip) { if (confirm('Suppr?')) await this.tripService.deleteTrip(t.uid!); }
  openChat(u: UserProfile) { this.chatService.startChatWith(u); this.router.navigate(['/admin/chat']); }
  
  handleTrackClick(t: Trip) { 
    // CORRECTION ICI: Nous utilisons une m√©thode concat√©n√©e pour √©viter l'erreur de backticks dans le script shell
    const url = 'https://www.google.com/maps/dir/?api=1&origin=$' + encodeURIComponent(t.departure) + '&destination=' + encodeURIComponent(t.destination) + '&travelmode=driving';
    window.open(url, '_blank'); 
  }

  private enrichedTrips$ = combineLatest([this.tripService.getTrips(), this.userService.getAllUsers(), this.carService.getCars()]).pipe(
    map(([trips, users, cars]) => {
       return trips.map((trip: any) => {
          let driver = users.find(u => u.uid === trip.driverId);
          if (!driver && trip.carId) {
             const car = cars.find(c => c.uid === trip.carId);
             if (car && car.assignedDriverId) driver = users.find(u => u.uid === car.assignedDriverId);
          }
          return { 
             ...trip, 
             driverName: driver ? (driver.displayName || driver.email) : null,
             driverEmail: driver ? driver.email : null,
             driverPhone: driver ? driver.phoneNumber : null, 
             driverProfile: driver 
          };
       });
    })
  );
  private enrichedRawTrips = toSignal(this.enrichedTrips$, { initialValue: [] });
  
  filteredTrips = computed(() => {
    const trips = this.enrichedRawTrips();
    const filters = this.filterValues();
    const myCompany = this.adminCompany();
    const isAdmin = myCompany === 'System' || !myCompany; 
    return trips.filter((t: any) => {
       if (!isAdmin && t.company !== myCompany) return false;
       return (!filters?.company || t.company === filters.company) && (!filters?.inProgressOnly || t.status === 'IN_PROGRESS');
    });
  });

  requestType: 'PARCEL' | 'PASSENGER' = 'PARCEL';
  tempParcels: Parcel[] = [];
  tempPassengers: Passenger[] = [];

  addToTempParcel(desc: HTMLInputElement, name: HTMLInputElement, phone: HTMLInputElement, addr: HTMLInputElement) {
    if (!desc.value || !name.value) { alert('Champs obligatoires manquants'); return; }
    this.tempParcels.push({
        description: desc.value, recipientName: name.value, recipientPhone: phone.value, recipientAddress: addr.value, weight: 1, delivered: false
    });
    desc.value = ''; name.value = ''; phone.value = ''; addr.value = '';
  }

  addToTempPassenger(name: HTMLInputElement, phone: HTMLInputElement, pickup: HTMLInputElement, drop: HTMLInputElement) {
    if (!name.value) { alert('Nom obligatoire'); return; }
    this.tempPassengers.push({
        name: name.value, phone: phone.value, pickupLocation: pickup.value, dropoffLocation: drop.value, isDroppedOff: false
    });
    name.value = ''; phone.value = ''; pickup.value = ''; drop.value = '';
  }

  removeTempParcel(index: number) { this.tempParcels.splice(index, 1); }
  removeTempPassenger(index: number) { this.tempPassengers.splice(index, 1); }

  async saveAllExtras() {
    const trip = this.selectedTripForRequest;
    if (!trip || !trip.uid) return;
    
    if (this.tempParcels.length === 0 && this.tempPassengers.length === 0) {
        alert("Aucun √©l√©ment √† ajouter."); return;
    }

    try {
        const updates: any = {};
        if (this.tempParcels.length > 0) {
            updates.parcels = [...(trip.parcels || []), ...this.tempParcels];
        }
        if (this.tempPassengers.length > 0) {
            updates.passengers = [...(trip.passengers || []), ...this.tempPassengers];
        }
        
        updates.hasNewItems = true;

        await this.tripService.updateTrip(trip.uid, updates);

        if (trip.driverId && trip.driverId !== 'PENDING') {
            const countP = this.tempParcels.length;
            const countPass = this.tempPassengers.length;
            let msg = 'Mise √† jour trajet : ';
            if (countP > 0) msg += countP + ' Colis ';
            if (countPass > 0) msg += countPass + ' Passagers ';
            msg += 'ajout√©(s).';
            await this.notifService.send(trip.driverId, msg, 'INFO');
        }

        alert("Ajouts valid√©s avec succ√®s !");
        this.closeRequestModal();

    } catch (e) {
        alert("Erreur lors de la sauvegarde : " + e);
    }
  }
}



==============================================================================
FICHIER : src/app/features/admin/companies/company-manager.component.ts
==============================================================================
import { Component, inject, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { CompanyService, Company } from '../../../core/services/company.service';
import { Observable } from 'rxjs';

@Component({
  selector: 'app-company-manager',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="space-y-6">
        <div class="flex justify-between items-center">
             <h2 class="text-2xl font-bold text-gray-800">Gestion des Soci√©t√©s</h2>
             <button (click)="toggleForm()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 shadow-md flex items-center gap-2 transition-all">
                <span class="text-xl">{{ showForm() ? '‚úï' : '+' }}</span>
                {{ showForm() ? 'Fermer' : 'Ajouter Soci√©t√©' }}
             </button>
        </div>

        <div *ngIf="showForm()" class="bg-white p-6 rounded-lg shadow-xl border-l-4 border-indigo-500 animate-fade-in">
           <h3 class="text-lg font-bold text-gray-800 mb-4">{{ isEditMode() ? 'Modifier' : 'Ajouter' }} une Soci√©t√©</h3>
           <form [formGroup]="companyForm" (ngSubmit)="saveCompany()" class="space-y-4">
              <div>
                 <label class="block text-sm font-medium text-gray-700">Nom</label>
                 <input formControlName="name" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
              </div>
              <div>
                 <label class="block text-sm font-medium text-gray-700">Email Contact</label>
                 <input formControlName="contactEmail" type="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
              </div>
              <div *ngIf="isEditMode()">
                  <label class="block text-sm font-medium text-gray-700">Statut</label>
                  <select formControlName="isActive" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
                      <option [ngValue]="true">Actif</option>
                      <option [ngValue]="false">Inactif</option>
                  </select>
              </div>
              <div class="flex justify-end gap-3">
                 <button type="button" (click)="resetForm()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-md">Annuler</button>
                 <button type="submit" [disabled]="companyForm.invalid" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 shadow-sm disabled:opacity-50">
                    Sauvegarder
                 </button>
              </div>
           </form>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
             <div class="overflow-x-auto">
                 <table class="min-w-full divide-y divide-gray-200">
                     <thead class="bg-gray-50">
                         <tr>
                             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nom</th>
                             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                             <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                         </tr>
                     </thead>
                     <tbody class="bg-white divide-y divide-gray-200">
                         @for (company of (companies$ | async); track company.uid) {
                             <tr class="hover:bg-gray-50 transition-colors">
                                 <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">{{ company.name }}</td>
                                 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ company.contactEmail }}</td>
                                 <td class="px-6 py-4 whitespace-nowrap">
                                     <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                         [ngClass]="company.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                         {{ company.isActive ? 'Actif' : 'Inactif' }}
                                     </span>
                                 </td>
                                 <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                                     <button (click)="editCompany(company)" class="text-indigo-600 hover:text-indigo-900">Modifier</button>
                                     <button (click)="toggleStatus(company)"
                                             [ngClass]="company.isActive ? 'text-red-600' : 'text-green-600'">
                                         {{ company.isActive ? 'D√©sactiver' : 'Activer' }}
                                     </button>
                                 </td>
                             </tr>
                         }
                     </tbody>
                 </table>
             </div>
        </div>
    </div>
  `
})
export class CompanyManagerComponent {
  private fb = inject(FormBuilder);
  private companyService = inject(CompanyService);

  companies$: Observable<Company[]> = this.companyService.getCompanies();
  showForm = signal(false);
  isEditMode = signal(false);
  currentCompanyId: string | null = null;

  companyForm = this.fb.group({
    name: ['', Validators.required],
    contactEmail: ['', [Validators.required, Validators.email]],
    isActive: [true]
  });

  toggleForm() {
    if (this.showForm() && this.isEditMode()) { this.resetForm(); } 
    else { this.showForm.set(!this.showForm()); this.isEditMode.set(false); }
  }

  editCompany(company: Company) {
    this.currentCompanyId = company.uid!;
    this.companyForm.patchValue({ name: company.name, contactEmail: company.contactEmail, isActive: company.isActive });
    this.isEditMode.set(true);
    this.showForm.set(true);
  }

  resetForm() {
    this.companyForm.reset({ isActive: true });
    this.isEditMode.set(false);
    this.showForm.set(false);
    this.currentCompanyId = null;
  }

  async saveCompany() {
    if (this.companyForm.invalid) return;
    const data = this.companyForm.value;
    
    if (this.isEditMode() && this.currentCompanyId) {
      await this.companyService.updateCompany(this.currentCompanyId, {
        name: data.name!, contactEmail: data.contactEmail!, isActive: data.isActive!
      });
    } else {
      await this.companyService.addCompany({
        name: data.name!, contactEmail: data.contactEmail!, isActive: true
      });
    }
    this.resetForm();
  }

  async toggleStatus(company: Company) {
    if (confirm(`Confirmer l'action sur ${company.name} ?`)) {
      await this.companyService.toggleStatus(company.uid!, !company.isActive);
    }
  }
}



==============================================================================
FICHIER : src/app/features/admin/live-map/live-map.component.ts
==============================================================================
import { Component, inject, AfterViewInit, OnDestroy, signal, effect, NgZone } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule, FormBuilder } from '@angular/forms';
import { Router } from '@angular/router';
import * as L from 'leaflet';
import { TripService, Trip } from '../../../core/services/trip.service';
import { CarService, Car } from '../../../core/services/car.service';
import { UserService } from '../../../core/services/user.service';
import { CompanyService } from '../../../core/services/company.service';
import { ChatService } from '../../../core/services/chat.service';
import { UserProfile } from '../../../core/auth/auth.service';
import { combineLatest, startWith, map } from 'rxjs';
import { toSignal } from '@angular/core/rxjs-interop';

// Configuration Ic√¥nes Leaflet
const iconRetinaUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png';
const iconUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png';
const shadowUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png';
const iconDefault = L.icon({
  iconRetinaUrl, iconUrl, shadowUrl,
  iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], tooltipAnchor: [16, -28], shadowSize: [41, 41]
});
L.Marker.prototype.options.icon = iconDefault;

@Component({
  selector: 'app-live-map',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  template: `
    <div class="flex flex-col h-full w-full relative overflow-hidden">
      <div class="absolute top-4 left-4 right-14 md:right-auto md:w-96 bg-white p-4 rounded-xl shadow-lg z-[1000] border border-gray-200 flex flex-col gap-3">
        <div class="flex justify-between items-center">
           <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><span class="text-xl">üåç</span> Flotte Live</h2>
           <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800 animate-pulse">{{ filteredCount() }} / {{ totalCount() }} Actifs</span>
        </div>
        <form [formGroup]="filterForm" class="flex flex-col gap-2">
           <div class="flex items-center gap-2 mb-1">
               <input type="checkbox" formControlName="inProgressOnly" id="mapInProgress" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
               <label for="mapInProgress" class="text-sm text-gray-700 font-medium">Uniquement "En cours"</label>
           </div>
           <div>
              <select formControlName="company" class="w-full text-sm border-gray-300 rounded-md bg-gray-50 p-2">
                 <option value="">Toutes les soci√©t√©s</option>
                 @for (company of activeCompanies(); track company.uid) { <option [value]="company.name">{{ company.name }}</option> }
              </select>
           </div>
           <div><input formControlName="search" type="text" placeholder="Rechercher..." class="w-full text-sm border-gray-300 rounded-md bg-gray-50 p-2"></div>
        </form>
      </div>
      <div id="map" class="flex-1 w-full h-full z-0 bg-gray-100"></div>
    </div>
  `,
  styles: [`:host { display: block; height: 100%; width: 100%; } #map { height: 100%; width: 100%; }`]
})
export class LiveMapComponent implements AfterViewInit, OnDestroy {
  private tripService = inject(TripService);
  private carService = inject(CarService);
  private userService = inject(UserService);
  private companyService = inject(CompanyService);
  private chatService = inject(ChatService);
  private router = inject(Router);
  private ngZone = inject(NgZone);
  private fb = inject(FormBuilder);
  
  private map: L.Map | undefined;
  private markers: L.LayerGroup = L.layerGroup();
  private readonly TUNISIA_BOUNDS = L.latLngBounds([30.2, 7.5], [37.6, 11.6]);

  activeCompanies = this.companyService.activeCompanies;
  filterForm = this.fb.group({ company: [''], inProgressOnly: [true], search: [''] });

  private combinedData$ = combineLatest([
    this.tripService.getTrips(),
    this.carService.getCars(),
    this.userService.getAllUsers(),
    this.filterForm.valueChanges.pipe(startWith(this.filterForm.value))
  ]).pipe(
    map(([trips, cars, users, filters]: [Trip[], Car[], UserProfile[], any]) => {
      const activeTrips = trips.filter((t: Trip) => t.status === 'IN_PROGRESS' && t.currentLocation);
      const enrichedTrips = activeTrips.map((trip: Trip) => {
        const car = cars.find((c: Car) => c.uid === trip.carId);
        const driver = users.find((u: UserProfile) => u.uid === car?.assignedDriverId);
        return { trip, car, driver };
      });
      const searchTerm = (filters?.search || '').toLowerCase();
      return enrichedTrips.filter((item: any) => {
         const matchCompany = !filters?.company || item.driver?.company === filters.company || item.trip.company === filters.company;
         const matchSearch = !searchTerm || item.car?.plate?.toLowerCase().includes(searchTerm) || item.trip.currentLocation?.city.toLowerCase().includes(searchTerm);
         return matchCompany && (filters?.inProgressOnly ? item.trip.status === 'IN_PROGRESS' : true);
      });
    })
  );

  liveData = toSignal(this.combinedData$, { initialValue: [] });
  filteredCount = signal(0);
  totalCount = signal(0);

  constructor() {
    effect(() => {
      const data = this.liveData();
      this.filteredCount.set(data.length);
      setTimeout(() => this.updateMarkers(data), 200);
    });
    this.tripService.getTrips().subscribe(trips => this.totalCount.set(trips.filter(t => t.status === 'IN_PROGRESS').length));
  }

  ngAfterViewInit(): void { setTimeout(() => this.initMap(), 100); }
  ngOnDestroy(): void { if (this.map) this.map.remove(); }

  private initMap(): void {
    if (this.map) return;
    this.map = L.map('map', { zoomControl: false, attributionControl: false });
    this.map.fitBounds(this.TUNISIA_BOUNDS);
    L.control.zoom({ position: 'bottomright' }).addTo(this.map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(this.map);
    this.markers.addTo(this.map);
    setTimeout(() => { this.map?.invalidateSize(); this.map?.fitBounds(this.TUNISIA_BOUNDS); }, 300);
  }

  private updateMarkers(data: any[]): void {
    if (!this.map) return;
    this.markers.clearLayers();
    
    data.forEach(item => {
      const { trip, car, driver } = item;
      if (trip.currentLocation) {
        
        // 1. ID UNIQUE POUR LE BOUTON (Essentiel pour le cibler apr√®s le rendu)
        const chatBtnId = `chat-btn-${driver?.uid}`;
        
        // 2. TEMPLATE HTML (Avec le bouton inject√©)
        const popupContent = `
          <div class="font-sans p-1 min-w-[220px]">
            <div class="flex items-center justify-between border-b border-gray-100 pb-2 mb-2">
                <div class="font-bold text-indigo-700 text-sm">${car?.model || 'V√©hicule'}</div>
                <div class="text-xs bg-gray-100 px-1 rounded font-mono">${car?.plate}</div>
            </div>
            <div class="text-xs text-gray-600 space-y-1">
               <div class="flex items-center gap-2"><span>üè¢</span> <strong>${driver?.company || 'N/A'}</strong></div>
               <div class="flex items-center gap-2"><span>üß¢</span> ${driver?.email?.split('@')[0]}</div>
               <div class="flex items-center gap-2 text-indigo-600 font-bold"><span>üìû</span> ${driver?.phoneNumber || 'N/A'}</div>
               <div class="flex items-center gap-2 text-gray-400 mt-2"><span>üìç</span> ${trip.currentLocation.city}</div>
            </div>
            
            <div class="mt-3 pt-2 border-t border-gray-100 flex gap-2">
               <button id="${chatBtnId}" class="flex-1 bg-indigo-50 text-indigo-700 py-1.5 rounded text-xs font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-1 border border-indigo-200 cursor-pointer">
                  <span>üí¨</span> Chat
               </button>
               
               <a href="https://www.google.com/maps/dir/?api=1&origin=$?q=${encodeURIComponent(trip.departure)}&destination=${encodeURIComponent(trip.destination)}&waypoints=${trip.currentLocation.lat},${trip.currentLocation.lng}&travelmode=driving" 
                  target="_blank" 
                  class="flex-1 bg-blue-600 text-white py-1.5 rounded text-xs font-bold hover:bg-blue-700 text-center no-underline block">
                  üìç Suivre
               </a>
            </div>
          </div>
        `;

        const marker = L.marker([trip.currentLocation.lat, trip.currentLocation.lng])
          .bindPopup(popupContent);

        // 3. LOGIQUE D'ATTACHEMENT DU CLICK (Quand le popup s'ouvre)
        marker.on('popupopen', () => {
           if (driver) {
              setTimeout(() => { // Petit d√©lai de s√©curit√© pour le DOM
                  const btn = document.getElementById(chatBtnId);
                  if (btn) {
                     btn.onclick = (e) => {
                        e.preventDefault(); // Emp√™cher comportement par d√©faut
                        // IMPORTANT: Revenir dans la Zone Angular pour la navigation
                        this.ngZone.run(() => {
                            this.openChat(driver);
                        });
                     };
                  }
              }, 50);
           }
        });

        marker.addTo(this.markers);
      }
    });

    if (data.length > 0) {
       const group = L.featureGroup(this.markers.getLayers() as L.Marker[]);
       this.map.fitBounds(group.getBounds().pad(0.1));
    }
  }

  openChat(driver: UserProfile) {
     this.chatService.startChatWith(driver);
     this.router.navigate(['/admin/chat']);
  }
}



==============================================================================
FICHIER : src/app/app.component.ts
==============================================================================
import { Component, inject, OnInit } from '@angular/core';
import { RouterOutlet } from '@angular/router';
import { MessagingService } from './core/services/messaging.service';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [RouterOutlet],
  templateUrl: './app.component.html',
  styleUrl: './app.component.scss'
})
export class AppComponent implements OnInit {
  title = 'master-delivery';
  private messagingService = inject(MessagingService);
  
  // Injection du service pour d√©clencher le constructor() imm√©diatement

  ngOnInit() {
    console.log('üöÄ Application d√©marr√©e - Service Messaging actif');
  }
}



==============================================================================
FICHIER : src/app/app.config.ts
==============================================================================
import { ApplicationConfig, provideZoneChangeDetection } from '@angular/core';
import { provideRouter } from '@angular/router';
import { routes } from './app.routes';
import { initializeApp, provideFirebaseApp } from '@angular/fire/app';
import { getAuth, provideAuth } from '@angular/fire/auth';
import { getFirestore, provideFirestore } from '@angular/fire/firestore';
import { getDatabase, provideDatabase } from '@angular/fire/database';
import { getMessaging, provideMessaging } from '@angular/fire/messaging';
import { environment } from '../environments/environment';

export const appConfig: ApplicationConfig = {
  providers: [
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideRouter(routes),
    provideFirebaseApp(() => initializeApp(environment.firebase)),
    provideAuth(() => getAuth()),
    provideFirestore(() => getFirestore()),
    provideDatabase(() => getDatabase()),
    provideMessaging(() => getMessaging())
  ]
};



==============================================================================
FICHIER : src/app/app.html
==============================================================================
<router-outlet />



==============================================================================
FICHIER : src/app/services/chat.service.ts
==============================================================================
import { Injectable, Injector, inject, runInInjectionContext } from '@angular/core';
import { Database, ref, listVal, objectVal, push, serverTimestamp } from '@angular/fire/database';
import { Observable } from 'rxjs';

@Injectable({
  providedIn: 'root'
})
export class ChatService {
  private db = inject(Database);
  private injector = inject(Injector);

  constructor() {}

  // --- GESTION DES ID UNIQUES ---
  private createChatId(user1: string, user2: string): string {
    return [user1, user2].sort().join('_');
  }

  // --- R√âCUP√âRER LES MESSAGES ---
  getMessages(currentUser: string, otherUser: string): Observable<any[]> {
    const chatId = this.createChatId(currentUser, otherUser);
    const chatRef = ref(this.db, 'chats/' + chatId);

    return runInInjectionContext(this.injector, () => {
      return listVal(chatRef);
    });
  }

  // --- ENVOYER UN MESSAGE ---
  sendMessage(senderId: string, receiverId: string, text: string) {
    const chatId = this.createChatId(senderId, receiverId);
    const chatRef = ref(this.db, 'chats/' + chatId);

    const message = {
      senderId: senderId,
      receiverId: receiverId,
      text: text,
      timestamp: serverTimestamp()
    };

    return push(chatRef, message);
  }

  // --- COMPTEUR NON-LUS (Celui qui posait probl√®me) ---
  getTotalUnreadCount(userId: string) {
    const countRef = ref(this.db, 'unread_counts/' + userId);
    
    return runInInjectionContext(this.injector, () => {
      return objectVal(countRef);
    });
  }
}



==============================================================================
FICHIER : src/app/app.scss
==============================================================================



==============================================================================
FICHIER : src/main.ts
==============================================================================
import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { App } from './app/app';

bootstrapApplication(App, appConfig)
  .catch((err) => console.error(err));



==============================================================================
FICHIER : src/environments/environment.ts
==============================================================================
export const environment = {
  production: false,
  // ‚ö†Ô∏è IMPORTANT : Remplacez cette configuration par la v√¥tre !
  // Le projet 'demo-project' ci-dessous est en lecture seule et bloquera l'inscription (Erreur 400).
  // Cr√©ez un projet sur https://console.firebase.google.com/
  firebase: {
    apiKey: "AIzaSyDJm6gOw0CSNlbWXP2BAX3etHZPBn9ARZY",
    authDomain: "masterdeliverpackage.firebaseapp.com",
    databaseURL: "https://masterdeliverpackage-default-rtdb.firebaseio.com",
    projectId: "masterdeliverpackage",
    storageBucket: "masterdeliverpackage.firebasestorage.app",
    messagingSenderId: "406875058530",
    appId: "1:406875058530:web:e872e7a5eea2ccc870fc3b",
    measurementId: "G-X9MGMQ3BVG"
  }
};



==============================================================================
FICHIER : src/styles.scss
==============================================================================
@import 'leaflet/dist/leaflet.css';
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Custom Global Styles */
body {
  @apply bg-gray-50 text-gray-900;
}



