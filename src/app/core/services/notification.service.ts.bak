import { Injectable, inject } from '@angular/core';
import { Messaging, getToken, onMessage } from '@angular/fire/messaging';
import { Firestore, doc, setDoc } from '@angular/fire/firestore';
import { AuthService } from '../auth/auth.service';
import { environment } from '../../../environments/environment';
import { filter, take } from 'rxjs/operators';

@Injectable({
  providedIn: 'root'
})
export class MessagingService {
  private messaging = inject(Messaging);
  private firestore = inject(Firestore);
  private authService = inject(AuthService);

  constructor() {
    this.init();
  }

  private init() {
    // On attend qu'un utilisateur soit connect√©
    this.authService.user$
      .pipe(
        filter(user => !!user),
        take(1)
      )
      .subscribe(user => {
        console.log('üë§ Utilisateur connect√©, r√©cup√©ration du token FCM...');
        if (user) { this.requestPermission(user.uid); }
      });

    // (Optionnel) √©couter les messages quand l'app est au premier plan
    onMessage(this.messaging, (payload) => {
      console.log('üì© Notification re√ßue en foreground :', payload);
    });
  }

  /** Demande la permission navigateur + r√©cup√®re le token */
  async requestPermission(userId: string) {
    try {
      const token = await getToken(this.messaging, {
        // ‚ö†Ô∏è Mets ici ta VAPID key web (pas l‚ÄôapiKey Firebase)
        vapidKey: environment.firebase.vapidKey
      });

      if (!token) {
        console.warn('‚ö†Ô∏è Aucun token re√ßu (permission refus√©e ou SW non dispo)');
        return;
      }

      console.log('üîë Token FCM r√©cup√©r√© :', token);
      await this.saveToken(userId, token);
    } catch (err) {
      console.error('‚ùå Erreur lors de la r√©cup√©ration du token FCM :', err);
    }
  }

  /** Enregistre / met √† jour le token dans Firestore */
  private async saveToken(userId: string, token: string) {
    try {
      const userRef = doc(this.firestore, `users/${userId}`);

      await setDoc(
        userRef,
        {
          fcmToken: token,
          fcmTokenUpdatedAt: { seconds: Math.floor(Date.now() / 1000), nanoseconds: 0 }
        },
        { merge: true }
      );

      console.log('‚úÖ Token FCM enregistr√© dans Firestore pour user :', userId);
    } catch (err) {
      console.error('‚ùå Erreur lors de l‚Äôenregistrement du token FCM dans Firestore :', err);
    }
  }
}
